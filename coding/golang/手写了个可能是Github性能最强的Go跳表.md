è…¾è®¯ç¨‹åºå‘˜Â è…¾è®¯æŠ€æœ¯å·¥ç¨‹

_2022å¹´09æœˆ01æ—¥ 18:00_Â _å¹¿ä¸œ_

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_gif/j3gficicyOvasIjZpiaTNIPReJVWEJf7UGpmokI3LL4NbQDb8fO48fYROmYPXUhXFN8IdDqPcI1gA6OfSLsQHxB4w/640?wx_fmt=gif&wxfrom=13&tp=wxpic)

ä½œè€…ï¼šphongchenï¼Œè…¾è®¯ IEG åå°å¼€å‘å·¥ç¨‹å¸ˆ

> 2022 å¹´ 3 æœˆï¼Œå¹¿å¤§äººæ°‘æœŸç›¼å·²ä¹…çš„æ”¯æŒçš„æ³›å‹çš„ go1.18 å‘å¸ƒäº†ã€‚ä½†æ˜¯ç›®å‰åŸºäºæ³›å‹çš„å®¹å™¨å®ç°è¿˜ä¸å¤šã€‚æˆ‘å®ç°äº†ä¸€å¥—ç±»ä¼¼ C++ä¸­ STL çš„å®¹å™¨å’Œç®—æ³•åº“ã€‚å…¶ä¸­æœ‰åºçš„ Map é€‰æ‹©ç”¨è·³è¡¨æ¥å®ç°ï¼Œå¹¶ä¼˜åŒ–åˆ°äº†ç›¸å½“å¥½çš„æ€§èƒ½ã€‚åœ¨æ­¤åˆ†äº«ä¸€ä¸‹ä¼˜åŒ–çš„æ€è·¯å’Œå¿ƒå¾—ï¼Œä¾›å¤§å®¶å‚è€ƒå€Ÿé‰´ï¼Œå¦‚æœå‘ç°æœ‰é”™è¯¯ä¹Ÿæ¬¢è¿æŒ‡å‡ºã€‚

### ä¸€ã€èƒŒæ™¯

é¦–å…ˆä¸ºæ ‡é¢˜å…šè‡´æ­‰ï¼Œä¸è¿‡ç¡®å®æ²¡å¹ç‰› ğŸ˜Šã€‚

æœ€è¿‘ä¸€å¹´æˆ‘æ‰€è´Ÿè´£çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œç”¨ Go è¯­è¨€çš„å®ç°çš„å äº†è‡³å°‘ 70%çš„æ¯”ä¾‹ï¼Œå› æ­¤ Review äº†å¤§é‡çš„ Go ä»£ç ï¼Œä¹Ÿçœ‹äº†å¾ˆå¤šç›¸å…³çš„æŠ€æœ¯èµ„æ–™ã€‚ä½†æ˜¯æˆ‘ç¡®å®æ²¡æ€ä¹ˆå†™è¿‡ Go çš„ä»£ç ï¼Œå› ä¸ºä¸€ç›´ä»¥æ¥æˆ‘ä¸å¤ªå–œæ¬¢ Go è¯­è¨€çš„ä¸»è¦æœ‰ä¸¤ç‚¹ï¼Œä¸€ä¸ªæ˜¯é”™è¯¯å¤„ç†ï¼Œå¦ä¸€ä¸ªå°±æ˜¯æ³›å‹ã€‚å› æ­¤å…ˆå‰è¿˜æ˜¯ä»¥å†™ C++å’Œ Python ä»£ç ä¸ºä¸»ï¼Œå†åŠ ä¸Šä¸€äº› Markdown æ–‡æ¡£ä»€ä¹ˆçš„ã€‚

2022 å¹´ 3 æœˆï¼ŒGo1.18 å‘å¸ƒï¼Œæ”¯æŒäº†æ³›å‹ï¼Œæˆ‘ä¹Ÿæ‰“ç®—è‡ªå·±ä¸€è¾¹å­¦ä¹ ï¼Œä¸€è¾¹å†™ä¸€äº›æœ‰å®é™…ä»·å€¼çš„ Go ä»£ç ã€‚

å‰å‡ å‘¨å­©å­æ”¾å‡å›è€å®¶ï¼Œå®¶é‡Œæ²¡äººæ‰“æ‰°äº†ï¼Œè°ƒç ”äº†ä¸€ä¸‹æœ‰æ²¡æœ‰ç±»ä¼¼ C++ä¸­ STL çš„æ³›å‹åº“ï¼Œå‘ç°è¦ä¹ˆå¾ˆè–„å¼±è¦ä¹ˆæ ¹æœ¬å°±ä¸æ”¯æŒæ³›å‹ã€‚äºæ˜¯å°±èŠ±äº†å‡ ä¸ªå‘¨æœ«å’Œä¸€äº›æ™šä¸Šçš„æ—¶é—´ï¼Œå†™äº†ä¸ªåŸºäºæ³›å‹çš„å®¹å™¨å’Œç®—æ³•åº“ï¼Œæš‚ä¸”èµ·åå«[stl4go](https://github.com/chen3feng/stl4go)ï¼ˆğŸ‘ åŠ  â­ï¼ŒğŸ™ï¼‰ã€‚å…¶ä¸­çš„æœ‰åº Map æˆ‘æ²¡æœ‰é€‰æ‹©çº¢é»‘æ ‘è€Œæ˜¯ç”¨äº†è·³è¡¨ï¼ŒèŠ±äº†ä¸€äº›æ—¶é—´ç”¨äº†ä¸€äº›æ‰‹æ³•ä¼˜åŒ–ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è¯´æ˜¯å…¨ GitHub ä¸Šèƒ½æ‰¾åˆ°çš„æœ€å¿«çš„ Go çš„å®ç°äº†ã€‚

### äºŒã€è·³è¡¨æ˜¯ä»€ä¹ˆ

è·³è¡¨ï¼ˆ[skiplist](http://en.wikipedia.org/wiki/Skip_list)ï¼‰æ˜¯ä¸€ç§éšæœºåŒ–çš„æ•°æ®ï¼Œ ç”± William Pugh åœ¨è®ºæ–‡[ã€ŠSkip lists: a probabilistic alternative to balanced treesã€‹](http://www.cl.cam.ac.uk/teaching/0506/Algorithms/skiplists.pdf)ä¸­æå‡ºï¼Œ è·³è¡¨ä»¥æœ‰åºçš„æ–¹å¼åœ¨å±‚æ¬¡åŒ–çš„é“¾è¡¨ä¸­ä¿å­˜å…ƒç´ ï¼Œ æ•ˆç‡å’Œå¹³è¡¡æ ‘åª²ç¾ â€”â€” æŸ¥æ‰¾ã€åˆ é™¤ã€æ·»åŠ ç­‰æ“ä½œéƒ½å¯ä»¥åœ¨ O(logN)æœŸæœ›æ—¶é—´ä¸‹å®Œæˆï¼Œ ç»¼åˆèƒ½åŠ›ç›¸å½“äºå¹³è¡¡äºŒå‰æ ‘ï¼Œå¹¶ä¸”æ¯”èµ·å¹³è¡¡æ ‘æ¥è¯´ï¼Œ è·³è·ƒè¡¨çš„å®ç°è¦ç®€å•ç›´è§‚å¾—å¤šï¼Œæ ¸å¿ƒåŠŸèƒ½åœ¨ 200 è¡Œä»¥å†…å³å¯å®ç°ï¼Œéå†çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(N)ï¼Œä»£ç ç®€å•ï¼Œç©ºé—´ä¸Šä¹Ÿæ¯”è¾ƒèŠ‚çœï¼Œå› æ­¤åœ¨æŒºå¤šçš„åœºæ™¯å¾—åˆ°åº”ç”¨ã€‚æ¯”å¦‚[Redis çš„ Sorted Set](https://redis.io/docs/data-types/sorted-sets/)ã€[LevelDB](https://github.com/google/leveldb/blob/main/db/skiplist.h)ï¼Œè¯¦ç»†åŸç†å’Œç®—æ³•è¯·ç§»æ­¥ä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š[Skip List--è·³è¡¨ï¼ˆå…¨ç½‘æœ€è¯¦ç»†çš„è·³è¡¨æ–‡ç« æ²¡æœ‰ä¹‹ä¸€ï¼‰](https://www.jianshu.com/p/9d8296562806)ï¼Œä¸å†èµ˜è¿°ã€‚

å®Œæ•´ä»£ç è§ï¼š\
[https://github.com/chen3feng/stl4go/blob/master/skiplist.go](https://github.com/chen3feng/stl4go/blob/master/skiplist.go)

é™„å¸¦å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚

SkipList ç”¨äºéœ€è¦æœ‰åºçš„åœºåˆï¼Œåœ¨ä¸éœ€è¦æœ‰åºçš„åœºæ™¯ä¸‹ï¼Œgo è‡ªå¸¦çš„ map å®¹å™¨ä¾ç„¶æ˜¯ä¼˜å…ˆé€‰æ‹©ã€‚

### ä¸‰ã€æ¥å£è®¾è®¡

#### ï¼ˆä¸€ï¼‰åˆ›å»ºå‡½æ•°

`ä¸»è¦è€ƒè™‘å¯ä»¥ç”¨Â <ã€==Â æ¯”è¾ƒçš„ç±»å‹ï¼Œå¯¹ä¸€ä¸å¯ä»¥çš„ï¼Œéœ€è¦æ”¯æŒè‡ªå®šä¹‰çš„æ¯”è¾ƒå‡½æ•°ã€‚//Â å¯¹äºKeyå¯ä»¥ç”¨Â <Â å’ŒÂ ==Â è¿ç®—ç¬¦æ¯”è¾ƒçš„ç±»å‹ï¼Œè°ƒè¿™ä¸ªå‡½æ•°æ¥åˆ›å»º   funcÂ NewSkipList[KÂ Ordered,Â VÂ any]()Â *SkipList[K,Â V]      //Â å…¶ä»–æƒ…å†µï¼Œéœ€è¦è‡ªå®šä¹‰Keyç±»å‹çš„æ¯”è¾ƒå‡½æ•°   funcÂ NewSkipListFunc[KÂ any,Â VÂ any](keyCmpÂ CompareFn[K])Â *SkipList[K,Â V]      //Â ä»ä¸€ä¸ªmapæ¥æ„å»ºï¼Œä»…ä¸ºæ–¹ä¾¿å†™Literalï¼Œgoæ²¡æ³•å¯¹è‡ªå®šä¹‰ç±»å‹ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ã€‚   funcÂ NewSkipListFromMap[KÂ Ordered,Â VÂ any](mÂ map[K]V)Â *SkipList[K,Â V]   `

#### ï¼ˆäºŒï¼‰ä¸»è¦æ–¹æ³•

`IsEmpty()Â boolÂ //Â è¡¨æ˜¯å¦ä¸ºç©º   Len()Â intÂ //Â è¿”å›è¡¨ä¸­å…ƒç´ çš„ä¸ªæ•°   Clear()Â //Â æ¸…ç©ºè·³è¡¨   Has(K)Â boolÂ //Â æ£€æŸ¥è·³è¡¨ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„key   Find(K)Â *VÂ //Â FindsÂ elementÂ withÂ specificÂ key.   Insert(K,Â V)Â //Â InsertsÂ aÂ key-valueÂ pairÂ inÂ toÂ theÂ containerÂ orÂ replaceÂ existingÂ value.   Remove(K)Â boolÂ //Â RemoveÂ elementÂ withÂ specificÂ key.   `

è¿˜æœ‰è¿­ä»£å™¨å’Œéå†åŒºé—´æŸ¥æ‰¾ç­‰åŠŸèƒ½ä¸æœ¬ä¸»é¢˜å…³ç³»ä¸å¤§ç•¥å»ã€‚

å¯ä»¥çœ‹å¾—å‡ºï¼Œå®Œå…¨å¯ä»¥æ»¡è¶³æœ‰åº Map å®¹å™¨çš„è¦æ±‚ã€‚

#### ï¼ˆä¸‰ï¼‰èŠ‚ç‚¹å®šä¹‰

è™½ç„¶ä¸å°‘è®²è·³è¡¨åŸç†ç¤ºæ„å›¾ä¼šæŠŠæ¯å±‚çš„ç´¢å¼•èŠ‚ç‚¹å•ç‹¬åˆ—å‡ºæ¥ï¼š

!\[å›¾ç‰‡\](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å‡ºå¤„ï¼š[Skip List--è·³è¡¨ï¼ˆå…¨ç½‘æœ€è¯¦ç»†çš„è·³è¡¨æ–‡ç« æ²¡æœ‰ä¹‹ä¸€ï¼‰](https://www.jianshu.com/p/9d8296562806)

ä½†æ˜¯ä¸€èˆ¬çš„å®ç°éƒ½ä¼šæŠŠç´¢å¼•èŠ‚ç‚¹å®ç°ä¸ºæœ€åº•å±‚èŠ‚ç‚¹çš„ä¸€ä¸ªæ•°ç»„ï¼Œè¿™æ ·æ¯ä¸ªå…ƒç´ åªéœ€è¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚çœäº†å•ç‹¬çš„ç´¢å¼•èŠ‚ç‚¹çš„å­˜å‚¨å¼€é”€ï¼Œä¹Ÿæé«˜äº†æ€§èƒ½ã€‚

!\[å›¾ç‰‡\](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å› æ­¤èŠ‚ç‚¹å®šä¹‰å¦‚ä¸‹ï¼š

`typeÂ skipListNode[KÂ any,Â VÂ any]Â structÂ {   Â Â Â Â keyÂ K   Â Â Â Â valueÂ V   Â Â Â Â //Â æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆçš„æ•°ç»„ï¼Œä¸åŒæ·±åº¦çš„èŠ‚ç‚¹é•¿åº¦ä¸åŒï¼Œ[0]è¡¨ç¤ºæœ€ä¸‹å±‚   Â Â Â Â nextÂ []*skipListNode[K,Â V]   }   `

### å››ã€ä»£ç ä¼˜åŒ–

ä»£ç å¹¶éå®Œå…¨ä»å¤´å¼€å§‹å†™çš„ï¼Œæˆ‘æ˜¯ä»¥ liyue201@github.com çš„ gostl çš„å®ç°ä¸ºåŸºç¡€çš„ã€‚

https://github.com/liyue201/gostl/blob/master/ds/skiplist/skiplist.go

è¿™ä¸ªå®ç°æ¯”è¾ƒç®€æ´ï¼Œåªæœ‰ 200 å¤šè¡Œä»£ç ï¼Œæ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹æ¯”è¾ƒï¼Œä½†æ˜¯ä¸æ”¯æŒæ³›å‹ã€‚

æˆ‘åœ¨ä»–çš„åŸºç¡€ä¸Šåšäº†ä¸€ç³»åˆ—çš„ç®—æ³•å’Œå†…å­˜åˆ†é…ç­‰æ–¹é¢çš„ä¼˜åŒ–ï¼Œå¹¶å¢åŠ äº†è¿­ä»£å™¨ã€åŒºé—´æŸ¥æ‰¾ç­‰åŠŸèƒ½ã€‚

#### ï¼ˆä¸€ï¼‰ç®—æ³•ä¼˜åŒ–

##### 1.ç”Ÿæˆéšæœº Level çš„ä¼˜åŒ–

æ¯æ¬¡è·³è¡¨æ’å…¥å…ƒç´ æ—¶ï¼Œéœ€è¦éšæœºç”Ÿæˆä¸€ä¸ªæœ¬æ¬¡çš„å±‚æ•°ï¼Œæœ€æœ´ç´ çš„å®ç°æ–¹å¼æ˜¯æŠ›ç¡¬å¸ï¼š

`funcÂ randomLevel()Â intÂ {   Â Â Â Â levelÂ :=Â 0   Â Â Â Â forÂ math.Float64()Â <Â 0.5Â {   Â Â Â Â Â Â Â Â level++   Â Â Â Â }   Â Â Â Â returnÂ level   }   `

ä¹Ÿå°±æ˜¯æ ¹æ®è¿ç»­è·å¾—æ­£é¢çš„æ¬¡æ•°æ¥å†³å®šå±‚æ•°ã€‚

Redis é‡Œçš„ç®—æ³•ç±»ä¼¼ï¼Œåªä¸è¿‡ç”¨çš„æ˜¯ 1/4 çš„çº§æ•°å·®ï¼Œç´¢å¼•å°‘ä¸€åŠï¼Œå¯ä»¥èŠ‚çœä¸€äº›å†…å­˜ï¼š

https://github.com/redis/redis/blob/7.0/src/t_zset.c#L118-L128

`/*Â ReturnsÂ aÂ randomÂ levelÂ forÂ theÂ newÂ skiplistÂ nodeÂ weÂ areÂ goingÂ toÂ create.   Â *Â TheÂ returnÂ valueÂ ofÂ thisÂ functionÂ isÂ betweenÂ 1Â andÂ ZSKIPLIST_MAXLEVEL   Â *Â (bothÂ inclusive),Â withÂ aÂ powerlaw-alikeÂ distributionÂ whereÂ higher   Â *Â levelsÂ areÂ lessÂ likelyÂ toÂ beÂ returned.Â */   intÂ zslRandomLevel(void)Â {   Â Â Â Â staticÂ constÂ intÂ thresholdÂ =Â ZSKIPLIST_P*RAND_MAX;   Â Â Â Â intÂ levelÂ =Â 1;   Â Â Â Â whileÂ (random()Â <Â threshold)   Â Â Â Â Â Â Â Â levelÂ +=Â 1;   Â Â Â Â returnÂ (level<ZSKIPLIST_MAXLEVEL)Â ?Â levelÂ :Â ZSKIPLIST_MAXLEVEL;   }   `

ç®€å•ç›´ç™½ã€‚ä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

- math.Float64() ï¼ˆä»¥åŠä»»ä½•å…¨å±€éšæœºå‡½æ•°ï¼‰å†…éƒ¨ä¸ºå…±äº«çš„éšæœºæ•°ç”Ÿæˆå™¨å¯¹è±¡ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåŠ é”è§£é”ï¼Œåœ¨ç«äº‰æƒ…å†µä¸‹æ€§èƒ½ä¸‹é™å¾ˆå‰å®³ã€‚è¯¦æƒ…å‚è§æºä»£ç  https://cs.opensource.google/go/go/+/refs/tags/go1.19:src/math/rand/rand.go

- å¤šæ¬¡ç”Ÿæˆéšæœºæ•°ã€‚ä¸‹é¢æˆ‘ä»¬å°†çœ‹åˆ°ï¼Œå…¶å®åªç”¨ç”Ÿæˆä¸€æ¬¡å°±å¯ä»¥äº†ã€‚

æ‰€ä»¥åœ¨ gostl çš„å®ç°ä¸­ï¼Œæ”¹ç”¨äº†ç”Ÿæˆä¸€ä¸ªæŸèŒƒå›´å†…çš„éšæœºæ•°ï¼Œæ ¹æ®å…¶å‡åŒ€åˆ†å¸ƒçš„ç‰¹ç‚¹ï¼Œæ¥è®¡ç®— levelï¼š

`funcÂ (slÂ *Skiplist)Â randomLevel()Â intÂ {   Â Â Â Â totalÂ :=Â uint64(1)<<uint64(sl.maxLevel)Â -Â 1Â //Â 2^n-1   Â Â Â Â kÂ :=Â sl.rander.Uint64()Â %Â total   Â Â Â Â levelNÂ :=Â uint64(1)Â <<Â (uint64(sl.maxLevel)Â -Â 1)      Â Â Â Â levelÂ :=Â 1   Â Â Â Â forÂ totalÂ -=Â levelN;Â totalÂ >Â k;Â level++Â {   Â Â Â Â Â Â Â Â levelNÂ >>=Â 1   Â Â Â Â Â Â Â Â totalÂ -=Â levelN   Â Â Â Â }   Â Â Â Â returnÂ level   }   `

è¿™äº›forå¾ªç¯æœ‰äº›æ‹—å£ï¼Œæ”¹å†™ä¸€ä¸‹å°±æ›´æ¸…æ™°äº†ï¼š

```
level :=Â 0forÂ kÂ <Â totalÂ {Â Â Â  levelNÂ >>=Â 1Â Â Â  totalÂ -=Â levelNÂ Â Â Â level++Â Â Â Â }
```

ä¹Ÿå°±æ˜¯ç”Ÿæˆçš„éšæœºæ•°

ä¹Ÿå°±æ˜¯ç”Ÿæˆçš„éšæœºæ•°è¶Šå°ï¼Œlevel è¶Šé«˜ï¼Œæ¯”å¦‚ maxLevel ä¸º 10 æ—¶ï¼Œtotal=1023ï¼Œé‚£ä¹ˆï¼š

- 512\<k\<1023 ä¹‹é—´çš„æ¦‚ç‡ä¸º 1/2ï¼Œlevel=1

- 256\<k\<511 ä¹‹é—´çš„æ¦‚ç‡ä¸º 1/4ï¼Œlevel=2

- 128\<k\<255 ä¹‹é—´çš„æ¦‚ç‡ä¸º 1/8ï¼Œlevel=3

- ...

å½“ level æ¯”è¾ƒé«˜æ—¶ï¼Œå¾ªç¯æ¬¡æ•°å°±ä¼šå¢åŠ ã€‚ä¸è¿‡å¯ä»¥è§‚å¯Ÿåˆ°åœ¨ç”Ÿæˆçš„éšæœºäºŒè¿›åˆ¶ä¸­ï¼Œæ•°å€¼å¢å‡ä¸€åŠæ­£å¥½ç­‰äºæ”¹å˜ä¸€ä¸ª bit ä½ï¼Œå› æ­¤æˆ‘æ”¹ç”¨ç›´æ¥è°ƒç”¨ math/bits é‡Œçš„ Len64()å‡½æ•°æ¥è®¡ç®—ç”Ÿæˆçš„éšæœºæ•°çš„æœ€å°ä½æ•°çš„æ–¹å¼æ¥å®ç°ï¼š

`funcÂ (slÂ *SkipList[K,Â V])Â randomLevel()Â intÂ {   Â Â Â Â totalÂ :=Â uint64(1)<<uint64(skipListMaxLevel)Â -Â 1Â //Â 2^n-1   Â Â Â Â kÂ :=Â sl.rander.Uint64()Â %Â total   Â Â Â Â returnÂ skipListMaxLevelÂ -Â bits.Len64(k)Â +Â 1   }   `

è€Œ Len64 å‡½æ•°æ˜¯ç”¨æŸ¥è¡¨å®ç°çš„ï¼Œç›¸å½“çš„å¿«ï¼š

https://github.com/golang/go/blob/go1.19/src/math/bits/bits.go#L330-L345

`//Â Len64Â returnsÂ theÂ minimumÂ numberÂ ofÂ bitsÂ requiredÂ toÂ representÂ x;   //Â theÂ resultÂ isÂ 0Â forÂ xÂ ==Â 0.   funcÂ Len64(xÂ uint64)Â (nÂ int)Â {   Â Â Â Â //Â ...   Â Â Â Â returnÂ nÂ +Â int(len8tab[x])   }   `

è¿™æ ·å½“ level>1 æ—¶ï¼Œæ—¶é—´å¼€é”€å°±ä»å¾ªç¯å˜æˆå›ºå®šå¼€é”€ï¼Œä¼šå¿«ä¸€ç‚¹ç‚¹ã€‚

##### **2.è‡ªé€‚åº” Level**

å¾ˆå¤šå®ç°éƒ½æŠŠ level ç¡¬ç¼–ç æˆå…¨å±€æˆ–è€…å®ä¾‹çº§åˆ«çš„å¸¸é‡ï¼Œæ¯”å¦‚åœ¨ gostl ä¸­å°±æ˜¯å¦‚æ­¤ã€‚

sl.maxLevel æ˜¯ä¸€ä¸ªå®ä¾‹çº§åˆ«çš„å›ºå®šå¸¸é‡ï¼Œè·³è¡¨åˆ›å»ºåä¾¿ä¸å†ä¿®æ”¹ï¼Œå› æ­¤æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

- å½“å®é™…å…ƒç´ å¾ˆå°‘æ—¶ï¼ŒæŸ¥æ‰¾å‡½æ•°ä¸­å¾ªç¯çš„å‰å‡ æ¬¡ cur å˜é‡åŸºæœ¬ä¸Šéƒ½æ˜¯ç©ºæŒ‡é’ˆï¼Œç™½ç™½æµªè´¹æ—¶é—´æŸ¥æ‰¾ï¼Œæ‰€ä»¥ä»–çš„å®ç°é‡Œ defaultMaxLevel è®¾ç½®çš„å¾ˆå°ã€‚

- ç”±äºé»˜è®¤çš„ maxLevel å¾ˆå°ï¼Œåªæœ‰ 10ï¼Œæ’å…¥ 1024 ä¸ªå…ƒç´ åï¼Œæœ€ä¸Šå±‚åŸºæœ¬ä¸Šå°±æ¥è¿‘å¹³è¡¡äºŒå‰æ ‘çš„æƒ…å†µäº†ï¼Œå¦‚æœå†ç»§ç»­æ’å…¥å¤§é‡çš„å…ƒç´ ï¼Œæ¯å±‚ç´¢å¼•èŠ‚ç‚¹æ•°é‡éƒ½å¿«é€Ÿå¢åŠ ï¼Œæ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚å¦‚æœåœ¨æ„é€ æ—¶å°±æ ¹æ®é¢„ä¼°å®¹é‡è®¾ç½®ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ maxLevel æ—¢å¯é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™è¿™ä¸ªæ•°ä¸æ˜¯é‚£ä¹ˆå¥½é¢„ä¼°ï¼Œè€Œä¸”ç”¨èµ·æ¥ä¸æ–¹ä¾¿ï¼Œæ¼äº†è®¾ç½®åˆå¯èƒ½ä¼šå¯¼è‡´æ„æ–™ä¹‹å¤–çš„æ€§èƒ½æ¶åŒ–ã€‚

å› æ­¤æˆ‘æŠŠ level è®¾è®¡ä¸ºæ ¹æ®å…ƒç´ çš„ä¸ªæ•°åŠ¨æ€è‡ªé€‚åº”è°ƒæ•´ï¼š

- è®¾ç½®ä¸€ä¸ª level æˆå‘˜è®°å½•æœ€é«˜çš„ level å€¼

- å½“æ’å…¥å…ƒç´ æ—¶ï¼Œå¦‚æœå‡ºç°äº†æ›´é«˜çš„å±‚ï¼Œå†æ’å…¥åå°±è°ƒå¤§ level

- å½“åˆ é™¤å…ƒç´ æ—¶ï¼Œå¦‚æœæœ€é¡¶å±‚çš„ç´¢å¼•å˜ç©ºäº†ï¼Œå°±å‡å°‘ levelã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°±è§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚

`//Â InsertÂ insertsÂ aÂ key-valueÂ pairÂ intoÂ theÂ skiplist.   //Â IfÂ theÂ keyÂ isÂ alreadyÂ inÂ theÂ skipÂ list,Â it'sÂ valueÂ willÂ beÂ updated.   funcÂ (slÂ *SkipList[K,Â V])Â Insert(keyÂ K,Â valueÂ V)Â {   Â Â Â Â //Â å¤„ç†keyå·²å­˜åœ¨çš„æƒ…å†µï¼Œç•¥å»      Â Â Â Â levelÂ :=Â sl.randomLevel()   Â Â Â Â nodeÂ =Â newSkipListNode(level,Â key,Â value)      Â Â Â Â //Â æ’å…¥é“¾è¡¨ï¼Œç•¥å»      Â Â Â Â ifÂ levelÂ >Â sl.levelÂ {   Â Â Â Â Â Â Â Â //Â IncreaseÂ theÂ level   Â Â Â Â Â Â Â Â forÂ iÂ :=Â sl.level;Â iÂ <Â level;Â i++Â {   Â Â Â Â Â Â Â Â Â Â Â Â sl.head.next[i]Â =Â node   Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â sl.levelÂ =Â level   Â Â Â Â }   Â Â Â Â sl.len++   }   `

å¦å¤–ä¸ºäº†é˜²æ­¢ä¸‡ä¸€åœ¨ä¸€å¼€å§‹å…ƒç´ ä¸ªæ•°å¾ˆå°æ—¶å°±ç”Ÿæˆäº†å¾ˆå¤§çš„éšæœº levelï¼Œåœ¨ randomLevel é‡Œåšäº†ä¸€ä¸‹é™åˆ¶ï¼Œæœ€å¤§å…è®¸ç”Ÿæˆçš„ level ä¸º log2(Len())+2ã€‚2 æ˜¯ä¸ªæ‹è„‘è¢‹å†³å®šçš„ä½™é‡ã€‚

##### 3.æ’å…¥åˆ é™¤ä¼˜åŒ–

æ’å…¥æ—¶å¦‚æœ key ä¸å­˜åœ¨æˆ–è€…åˆ é™¤æ—¶èŠ‚ç‚¹å­˜åœ¨ï¼Œéƒ½éœ€è¦æ‰¾åˆ°æ¯å±‚ç´¢å¼•ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥ prevs æ•°ç»„è¿”å›ï¼Œç”¨äºæ’å…¥æˆ–è€…åˆ é™¤èŠ‚ç‚¹åå„å±‚é“¾è¡¨çš„é‡æ–°ç»„ç»‡ã€‚

gostl çš„å®ç°ä¸­ï¼Œæ˜¯å…ˆåœ¨ findPrevNodes å‡½æ•°é‡Œçš„å¾ªç¯ä¸­å¾—åˆ°æ‰€æœ‰çš„ prevsï¼Œç„¶åå†æ¯”è¾ƒ\[0\]å±‚çš„å€¼æ¥åˆ¤æ–­ key æ˜¯å¦ç›¸ç­‰å†³å®šæ›´æ–°æˆ–è€…è¿”å›ã€‚

[https://github.com/liyue201/gostl/blob/e5590f19a43ac53f35893c7c679b37d967c4859c/ds/skiplist/skiplist.go#L186-L201](https://github.com/liyue201/gostl/blob/e5590f19a43ac53f35893c7c679b37d967c4859c/ds/skiplist/skiplist.go#L186-L201)

è¿™ä¸ªå‡½æ•°ä¼šä»é¡¶å±‚éå†åˆ°æœ€åº•å±‚ï¼š

`funcÂ (slÂ *Skiplist)Â findPrevNodes(keyÂ interface{})Â []*NodeÂ {   Â Â Â Â prevsÂ :=Â sl.prevNodesCache   Â Â Â Â prevÂ :=Â &sl.head   Â Â Â Â forÂ iÂ :=Â sl.maxLevelÂ -Â 1;Â iÂ >=Â 0;Â i--Â {   Â Â Â Â Â Â Â Â ifÂ sl.head.next[i]Â !=Â nilÂ {   Â Â Â Â Â Â Â Â Â Â Â Â forÂ nextÂ :=Â prev.next[i];Â nextÂ !=Â nil;Â nextÂ =Â next.next[i]Â {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ sl.keyCmp(next.key,Â key)Â >=Â 0Â {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â break   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â prevÂ =Â &next.Node   Â Â Â Â Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â prevs[i]Â =Â prev   Â Â Â Â }   Â Â Â Â returnÂ prevs   }   `

æ’å…¥æ—¶å†å–æœ€åº•å±‚çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªè¿›ä¸€æ­¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰

`//Â InsertÂ insertsÂ aÂ key-valueÂ pairÂ intoÂ theÂ skiplist   funcÂ (slÂ *Skiplist)Â Insert(key,Â valueÂ interface{})Â {   Â Â Â Â prevsÂ :=Â sl.findPrevNodes(key)      Â Â Â Â ifÂ prevs[0].next[0]Â !=Â nilÂ &&Â sl.keyCmp(prevs[0].next[0].key,Â key)Â ==Â 0Â {   Â Â Â Â Â Â Â Â //Â å¦‚æœç›¸ç­‰ï¼Œå…¶å®prevså°±æ²¡ç”¨äº†ï¼Œä½†æ˜¯findPrevNodesé‡Œä¾ç„¶è¿›è¡Œäº†æŸ¥è¯¢   Â Â Â Â Â Â Â Â //Â sameÂ key,Â updateÂ value   Â Â Â Â Â Â Â Â prevs[0].next[0].valueÂ =Â value   Â Â Â Â Â Â Â Â return   Â Â Â Â }   Â Â Â Â ...   }   `

ä½†æ˜¯å†æ’å…¥ key æ—¶å¦‚æœå·²ç»èŠ‚ç‚¹å­˜åœ¨ï¼Œæˆ–è€…åˆ é™¤ key æ—¶èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæ˜¯ä¸éœ€è¦è°ƒæ•´æ¯å±‚èŠ‚ç‚¹çš„ï¼Œå‰é¢è¾›è¾›è‹¦è‹¦æŸ¥æ‰¾çš„ prevs å°±æ²¡ç”¨äº†ã€‚

æˆ‘åœ¨è¿™é‡Œåšäº†ä¸ªä¼˜åŒ–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æå‰è¿”å›ï¼Œä¸å†ç»§ç»­æ‰¾æ‰€æœ‰çš„ prevsã€‚ä»¥æ’å…¥ä¸ºä¾‹ï¼š

`//Â findInsertPointÂ returnsÂ (*node,Â nil)Â toÂ theÂ existedÂ nodeÂ ifÂ theÂ keyÂ exists,   //Â orÂ (nil,Â []*node)Â toÂ theÂ previousÂ nodesÂ ifÂ theÂ keyÂ doesn'tÂ exist   funcÂ (slÂ *skipListOrdered[K,Â V])Â findInsertPoint(keyÂ K)Â (*skipListNode[K,Â V],Â []*skipListNode[K,Â V])Â {   Â Â Â Â prevsÂ :=Â sl.prevsCache[0:sl.level]   Â Â Â Â prevÂ :=Â &sl.head   Â Â Â Â forÂ iÂ :=Â sl.levelÂ -Â 1;Â iÂ >=Â 0;Â i--Â {   Â Â Â Â Â Â Â Â forÂ nextÂ :=Â prev.next[i];Â nextÂ !=Â nil;Â nextÂ =Â next.next[i]Â {   Â Â Â Â Â Â Â Â Â Â Â Â ifÂ next.keyÂ ==Â keyÂ {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â KeyÂ å·²ç»å­˜åœ¨ï¼Œåœæ­¢æœç´¢   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ next,Â nil   Â Â Â Â Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â Â Â Â Â ifÂ next.keyÂ >Â keyÂ {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â AllÂ otherÂ nodeÂ inÂ thisÂ levelÂ mustÂ beÂ greaterÂ thanÂ theÂ key,   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â searchÂ theÂ nextÂ level.   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â break   Â Â Â Â Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â Â Â Â Â prevÂ =Â next   Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â prevs[i]Â =Â prev   Â Â Â Â }   Â Â Â Â returnÂ nil,Â prevs   }   `

nodeå’Œprevsåªä¼šæœ‰ä¸€ä¸ªä¸ç©ºï¼š

`//Â InsertÂ insertsÂ aÂ key-valueÂ pairÂ intoÂ theÂ skiplist.   //Â IfÂ theÂ keyÂ isÂ alreadyÂ inÂ theÂ skipÂ list,Â it'sÂ valueÂ willÂ beÂ updated.   funcÂ (slÂ *SkipList[K,Â V])Â Insert(keyÂ K,Â valueÂ V)Â {   Â Â Â Â node,Â prevsÂ :=Â sl.impl.findInsertPoint(key)   Â Â Â Â ifÂ nodeÂ !=Â nilÂ {   Â Â Â Â Â Â Â Â //Â AlreadyÂ exist,Â updateÂ theÂ value   Â Â Â Â Â Â Â Â node.valueÂ =Â value   Â Â Â Â Â Â Â Â return   Â Â Â Â }   Â Â Â Â //Â ç”ŸæˆåŠæ’å…¥æ–°èŠ‚ç‚¹ï¼Œç•¥å»   }`

åˆ é™¤æ“ä½œçš„ä¼˜åŒ–æ–¹å¼ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚

##### **4.æ•°æ®ç±»å‹ç‰¹æœ‰çš„ä¼˜åŒ–**

å¯¹äº Ordered ç±»å‹çš„è·³è¡¨ï¼Œå¦‚æœæ˜¯å‡åºçš„ï¼Œå¯ä»¥ç›´æ¥ç”¨ NewSkipList æ¥åˆ›å»ºã€‚å¯¹äºç”¨å¾—è¾ƒå°‘çš„é™åºæˆ–è€… Key æ˜¯ä¸å¯æ¯”è¾ƒçš„ç±»å‹ï¼Œå°±éœ€è¦é€šè¿‡ä¼ å…¥çš„æ¯”è¾ƒå‡½æ•°æ¥æ¯”è¾ƒ Keyã€‚

ä¸€å¼€å§‹çš„å®ç°ä¸ºäº†ç®€åŒ–ï¼Œå¯¹äº Ordered çš„ SkipListï¼Œå†…éƒ¨æ˜¯é€šè¿‡è°ƒç”¨ SkipListFunc æ¥å®ç°çš„ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœä¸å°‘ä»£ç ï¼Œå®ç°èµ·æ¥å¾ˆç®€å•ã€‚

ä½†æ˜¯ Benchmark æ—¶ï¼Œè·‘ä¸è¿‡ä¸€äº›è¾ƒå¿«åœ°å®ç°ã€‚åˆ†æä¸»è¦åŸå› å°±åœ¨æ¯”è¾ƒå‡½æ•°çš„å‡½æ•°è°ƒç”¨ä¸Šã€‚ä»¥æŸ¥æ‰¾ä¸ºä¾‹ï¼š

`//Â GetÂ returnsÂ theÂ valueÂ associatedÂ withÂ theÂ passedÂ keyÂ ifÂ theÂ keyÂ isÂ inÂ theÂ skiplist,Â otherwiseÂ returnsÂ nil   funcÂ (slÂ *Skiplist)Â Get(keyÂ interface{})Â interface{}Â {   Â Â Â Â varÂ preÂ =Â &sl.head   Â Â Â Â forÂ iÂ :=Â sl.maxLevelÂ -Â 1;Â iÂ >=Â 0;Â i--Â {   Â Â Â Â Â Â Â Â curÂ :=Â pre.next[i]   Â Â Â Â Â Â Â Â forÂ ;Â curÂ !=Â nil;Â curÂ =Â cur.next[i]Â {   Â Â Â Â Â Â Â Â Â Â Â Â cmpRetÂ :=Â sl.keyCmp(cur.key,Â key)   Â Â Â Â Â Â Â Â Â Â Â Â ifÂ cmpRetÂ ==Â 0Â {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ cur.value   Â Â Â Â Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â Â Â Â Â ifÂ cmpRetÂ >Â 0Â {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â break   Â Â Â Â Â Â Â Â Â Â Â Â }   Â Â Â Â Â Â Â Â Â Â Â Â preÂ =Â &cur.Node   Â Â Â Â Â Â Â Â }   Â Â Â Â }   Â Â Â Â returnÂ nil   }   `

åœ¨ C++ä¸­ï¼Œæ¯”è¾ƒå‡½æ•°å¯ä»¥æ˜¯æ— çŠ¶æ€çš„å‡½æ•°å¯¹è±¡ï¼Œå…¶()è¿ç®—ç¬¦æ˜¯å¯ä»¥ inline çš„ã€‚ä½†æ˜¯åœ¨ Go ä¸­ï¼Œæ¯”è¾ƒå‡½æ•°åªèƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œsl.keyCmp è°ƒç”¨æ— æ³•è¢« inlineã€‚å› æ­¤å¯¹ç®€å•çš„ç±»å‹ï¼Œè¿™éƒ¨åˆ†å¼€é”€å çš„æ¯”ä¾‹å¾ˆå¤§ã€‚

æˆ‘ä¸€å¼€å§‹ç”¨çš„ä¼˜åŒ–æ‰‹æ³•æ˜¯åœ¨è¿è¡ŒæœŸé—´ï¼Œæ ¹æ®ç¡¬ç¼–ç çš„ key çš„ç±»å‹ï¼Œè¿›è¡Œç±»å‹è½¬æ¢åè°ƒä¼˜åŒ–çš„å®ç°

https://github.com/chen3feng/stl4go/commit/1d444f1530cc43c99a978dcf0b1d7f83bcb575ee#diff-37795d4525025da36a8f77e3e5d0b3f6593fd121960e1d563008a6700fb08473

è¿™ç§æ–¹å¼è™½ç„¶å‡‘æ•ˆä½†æ˜¯ä»£ç å¾ˆä¸‘é™‹ï¼Œç”¨åˆ°äº†ç¡¬ç¼–ç çš„ç±»å‹åˆ—è¡¨ï¼Œè¿è¡ŒæœŸç±»å‹ switch ç­‰æœºåˆ¶ï¼Œç”šè‡³è¿˜éœ€è¦ä»£ç ç”Ÿæˆã€‚

åæ¥æˆ‘æ‘¸ç´¢å‡ºé€šè¿‡åŒä¸€ä¸ªæ¥å£ï¼Œæ ¹æ® Key æ˜¯ä½œä¸º Ordered è¿˜æ˜¯é€šè¿‡ Func çš„æ–¹å¼æ¥æ¯”è¾ƒï¼Œæ¥æä¾›äº†ä¸åŒå®ç°çš„æ–¹å¼ï¼Œå°±æ›´ä¼˜é›…åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸éœ€è¦ä»»ä½•å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼š

`typeÂ skipListImpl[KÂ any,Â VÂ any]Â interfaceÂ {   Â Â Â Â findNode(keyÂ K)Â *skipListNode[K,Â V]   Â Â Â Â lowerBound(keyÂ K)Â *skipListNode[K,Â V]   Â Â Â Â upperBound(keyÂ K)Â *skipListNode[K,Â V]   Â Â Â Â findInsertPoint(keyÂ K)Â (*skipListNode[K,Â V],Â []*skipListNode[K,Â V])   Â Â Â Â findRemovePoint(keyÂ K)Â (*skipListNode[K,Â V],Â []*skipListNode[K,Â V])   }      //Â NewSkipListÂ createsÂ aÂ newÂ SkipListÂ forÂ OrderedÂ keyÂ type.   funcÂ NewSkipList[KÂ Ordered,Â VÂ any]()Â *SkipList[K,Â V]Â {   Â Â Â Â slÂ :=Â skipListOrdered[K,Â V]{}   Â Â Â Â sl.init()   Â Â Â Â sl.implÂ =Â (skipListImpl[K,Â V])(&sl)   Â Â Â Â returnÂ &sl.SkipList   }      //Â NewSkipListFuncÂ createsÂ aÂ newÂ SkipListÂ withÂ specifiedÂ compareÂ functionÂ keyCmp.   funcÂ NewSkipListFunc[KÂ any,Â VÂ any](keyCmpÂ CompareFn[K])Â *SkipList[K,Â V]Â {   Â Â Â Â slÂ :=Â skipListFunc[K,Â V]{}   Â Â Â Â sl.init()   Â Â Â Â sl.keyCmpÂ =Â keyCmp   Â Â Â Â sl.implÂ =Â skipListImpl[K,Â V](&sl)   Â Â Â Â returnÂ &sl.SkipList   }   `

å¯¹äº Len()ã€IsEmpty()ç­‰ï¼Œåˆ™ä¸æ”¾è¿›æ¥å£é‡Œï¼Œæœ‰åˆ©äºç¼–è¯‘å™¨ inline ä¼˜åŒ–ã€‚

#### ï¼ˆäºŒï¼‰å†…å­˜åˆ†é…ä¼˜åŒ–

æ— è®ºæ˜¯ç†è®ºä¸Šè¿˜æ˜¯å®æµ‹ï¼Œå†…å­˜åˆ†é…å¯¹æ€§èƒ½çš„å½±å“è¿˜æ˜¯æŒºå¤§çš„ã€‚Go ä¸åƒ Java å’Œ C#çš„å †å†…å­˜åˆ†é…é‚£ä¹ˆç®€å•ï¼Œå› æ­¤åº”å½“å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…ã€‚

!\[å›¾ç‰‡\](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

æ¥æºï¼š[Go ç”Ÿæ€ä¸‹çš„å­—èŠ‚è·³åŠ¨å¤§è§„æ¨¡å¾®æœåŠ¡æ€§èƒ½ä¼˜åŒ–å®è·µ](https://my.oschina.net/u/5632822/blog/5565821)

##### 1.Cache Prevs èŠ‚ç‚¹

åœ¨æ’å…¥æ—¶å¦‚æœèŠ‚ç‚¹å…ˆå‰ä¸å­˜åœ¨ï¼Œæˆ–è€…åˆ é™¤æ—¶èŠ‚ç‚¹å­˜åœ¨ï¼Œé‚£ä¹ˆå°±éœ€è¦è·å¾—æ‰€æœ‰å±‚çš„æŒ‡å‘è¯¥ä½ç½®çš„èŠ‚ç‚¹æ•°ç»„ï¼Œè¿™å€’ä¸æ˜¯æˆ‘åŸåˆ›çš„ï¼Œå› ä¸ºçœ‹åˆ°çš„å¥½å‡ ä¸ªå®ç°ä¸­éƒ½é‡‡ç”¨äº†åœ¨ SkipList å®ä¾‹çº§åˆ«é¢„å…ˆåˆ†é…ä¸€ä¸ª slice çš„åŠæ³•ï¼Œç»æµ‹è¯•æ¯”èµ·æ¯æ¬¡éƒ½åˆ›å»º slice è¿”å›ç¡®å®æœ‰ç›¸å½“æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚

##### 2.èŠ‚ç‚¹åˆ†é…ä¼˜åŒ–

ä¸åŒ level çš„èŠ‚ç‚¹æ•°æ®ç±»å‹æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯å…¶ next æŒ‡é’ˆæ•°ç»„çš„é•¿åº¦ä¸åŒï¼Œä¸€äº›ç®€å•ç²—æš´çš„å®ç°æ˜¯è®¾ç½®ä¸ºå›ºå®šçš„æœ€å¤§æ·±åº¦ï¼Œç”±äºè·³è¡¨ä¸­ç»å¤§å¤šæ•°èŠ‚ç‚¹éƒ½åªè½åœ¨æœ€ä½å‡ å±‚ï¼Œæµªè´¹äº†è¾ƒå¤šçš„å†…å­˜ã€‚

å¦å¤–ä¸€ç§åšæ³•æ˜¯æ”¹ä¸ºåŠ¨æ€åˆ†é…ï¼Œé‚£ä¹ˆå°±å¤šä¸€æ¬¡å†…å­˜åˆ†é…ã€‚

æˆ‘çš„åšæ³•æ˜¯æ ¹æ®ä¸åŒçš„æ·±åº¦ï¼Œå®šä¹‰ä¸åŒçš„ç»“æ„ä½“ï¼Œé¢å¤–åŒ…å«ä¸€ä¸ªç›¸åº”é•¿åº¦çš„ nexts èŠ‚ç‚¹æŒ‡é’ˆæ•°ç»„ï¼Œç„¶ååœ¨ node çš„ next åˆ‡ç‰‡æŒ‡å‘è¿™ä¸ªæ•°ç»„ï¼Œå¯ä»¥å°±å‡å°‘ä¸€æ¬¡å†…å­˜åˆ†é…ã€‚å¹¶ä¸”ç”±äº nexts æ•°ç»„å’Œ node çš„åœ°å€æ˜¯åœ¨ä¸€èµ·çš„ï¼Œcache å±€éƒ¨æ€§ä¹Ÿæ›´å¥½ã€‚

https://github.com/chen3feng/stl4go/blob/master/skiplist_newnode.go

`//Â newSkipListNodeÂ createsÂ aÂ newÂ nodeÂ initializedÂ withÂ specifiedÂ key,Â valueÂ andÂ nextÂ slice.   funcÂ newSkipListNode[KÂ any,Â VÂ any](levelÂ int,Â keyÂ K,Â valueÂ V)Â *skipListNode[K,Â V]Â {   Â Â Â Â switchÂ levelÂ {   Â Â Â Â caseÂ 1:   Â Â Â Â Â Â Â Â nÂ :=Â structÂ {   Â Â Â Â Â Â Â Â Â Â Â Â headÂ skipListNode[K,Â V]   Â Â Â Â Â Â Â Â Â Â Â Â nextsÂ [1]*skipListNode[K,Â V]   Â Â Â Â Â Â Â Â }{head:Â skipListNode[K,Â V]{key,Â value,Â nil}}   Â Â Â Â Â Â Â Â n.head.nextÂ =Â n.nexts[:]   Â Â Â Â Â Â Â Â returnÂ &n.head   Â Â Â Â caseÂ 2:   Â Â Â Â Â Â Â Â nÂ :=Â structÂ {   Â Â Â Â Â Â Â Â Â Â Â Â headÂ skipListNode[K,Â V]   Â Â Â Â Â Â Â Â Â Â Â Â nextsÂ [2]*skipListNode[K,Â V]   Â Â Â Â Â Â Â Â }{head:Â skipListNode[K,Â V]{key,Â value,Â nil}}   Â Â Â Â Â Â Â Â n.head.nextÂ =Â n.nexts[:]   Â Â Â Â Â Â Â Â returnÂ &n.head   Â Â Â Â //Â ä¸€ç›´åˆ°Â caseÂ 40Â ...   Â Â Â Â }   }   `

è¿™ä¹ˆå¤šå•°å—¦çš„ä»£ç æ˜¾ç„¶ä¸é€‚åˆæ‰‹å†™ï¼Œæ˜¯å¼„ä¸ª bash è„šæœ¬é€šè¿‡ go generate ç”Ÿæˆçš„ã€‚

https://github.com/chen3feng/stl4go/blob/master/skiplist_newnode_generate.sh

å¦å¤–æˆ‘åœ¨è°ƒè¯•è¿™æ®µä»£ç æ—¶å‘ç° go çš„ switch case è¯­å¥å³ä½¿å¯¹ç®€å•çš„å…¨æ•°å€¼å±…ç„¶ä¹Ÿæ˜¯é€šè¿‡[äºŒåˆ†æ³•](https://github.com/golang/go/blob/8ee9bca2729ead81da6bf5a18b87767ff396d1b7/src/cmd/compile/internal/gc/swt.go#L375)è€Œé C++å¸¸ç”¨çš„[è·³è½¬è¡¨](https://sites.google.com/site/arch1utep/jump-tables)æ¥å®ç°çš„ã€‚ä¸è¿‡ä¼°è®¡æ˜¯å› ä¸ºæœ‰æ›´è€—æ—¶çš„å†…å­˜åˆ†é…çš„åŸå› ï¼Œå°è¯•æŠŠ case 1ï¼Œ2 ç­‰å•ç‹¬æ‹¿å‡ºæ¥ä¹Ÿæ²¡æœ‰æå‡ï¼Œå› æ­¤ä¼°è®¡è¿™é‡Œå¯¹æ€§èƒ½æ²¡æœ‰å½±å“ã€‚å¦‚æœ case éå¸¸å¤šçš„è¯å¯ä»¥è€ƒè™‘å¯¹æœ€å¸¸è§çš„ case å•ç‹¬å¤„ç†ï¼Œæˆ–è€…ç”¨å‡½æ•°æŒ‡é’ˆæ•°ç»„æ¥ä¼˜åŒ–ã€‚

### äº”ã€C++å®ç°

ç±»ä¼¼çš„ä»£ç åœ¨ C++ä¸­ç”±äºæ”¯æŒæ¨¡æ¿éç±»å‹å‚æ•°ï¼Œå¯ä»¥ç®€å•ä¸å°‘ï¼š

`templateÂ <typenameÂ K,Â typenameÂ V>   structÂ NodeÂ {   Â Â KÂ key;   Â Â VÂ value;   Â Â size_tÂ level;   Â Â Node*Â nexts[0];   Â Â SkipListNode(key,Â VÂ value)Â :Â level(level),Â key(std::move(key)),Â value(std::move(value))Â {}   };      templateÂ <typenameÂ K,Â typenameÂ V,Â intÂ N>Â //Â æ³¨æ„Â NÂ å¯ä»¥ä½œä¸ºæ¨¡æ¿å‚æ•°   structÂ NodeNÂ :Â publicÂ NodeÂ {   Â Â NodeN(KÂ key,Â VÂ value)Â :Â Node(N,Â key,Â value)Â {}   Â Â Node*Â nexts[N]Â =Â {};   };      Node*Â NewNode(intÂ level,Â KÂ key,Â VÂ value)Â {   Â Â switchÂ (level)Â {   Â Â Â Â caseÂ 1:Â returnÂ newÂ NodeN<K,Â V,Â 1>(key,Â value);   Â Â Â Â caseÂ 2:Â returnÂ newÂ NodeN<K,Â V,Â 2>(key,Â value);   Â Â Â Â caseÂ 3:Â returnÂ newÂ NodeN<K,Â V,Â 3>(key,Â value);   Â Â Â Â ...   Â Â }   }   `

ç”¨ Cï¼ˆå½“ç„¶åœ¨ C++ä¸­ä¹Ÿå¯ä»¥ç”¨ï¼‰çš„[flexible array](https://en.wikipedia.org/wiki/Flexible_array_member)ä»£ç åˆ™ä¼šæ›´ç®€å•ä¸€äº›ï¼š

`Node*Â NewNode(intÂ level,Â KÂ key,Â VÂ value)Â {   Â Â autoÂ pÂ =Â malloc(sizeof(Node*)Â +Â levelÂ *Â sizeof(Node*));   Â Â returnÂ new(p)Â Node(std::move(key),Â std::move(value));   }   `

è€Œä¸”ç”±äº C å’Œ C++ä¸­çš„ next æ•°ç»„ä¸éœ€è¦é€šè¿‡åˆ‡ç‰‡ï¼ˆç›¸å½“äºæŒ‡é’ˆï¼‰æ¥æŒ‡å‘ nexts æ•°ç»„ï¼Œå°‘äº†ä¸€æ¬¡å†…å­˜å¯»å€ï¼Œç†è®ºä¸Šæ€§èƒ½æ›´å¥½ä¸€äº›ã€‚

C++å®ç°ä¸º Go ä»£ç çš„æ‰‹å·¥è½¬è¯‘ï¼ŒåŠŸèƒ½æœªåšå……åˆ†çš„éªŒè¯ï¼Œä»…ä¾›å¯¹æ¯”è¯„æµ‹ï¼Œä»£ç åœ¨ï¼š

[https://github.com/chen3feng/skiplist-survey/tree/master/skiplist](https://github.com/chen3feng/skiplist-survey/tree/master/skiplist)

### å…­ã€Benchmark

sean-public@github.com å®ç°äº†ä¸€ä¸ªä»¥ float64 ä¸º key çš„è·³è¡¨ï¼š\
[https://github.com/sean-public/fast-skiplist](https://github.com/sean-public/fast-skiplist)

å¹¶å’Œå…¶ä»–å®ç°åšäº†ä¸ªæ¯”è¾ƒè¯æ˜è‡ªå·±çš„æœ€å¿«ï¼š

https://github.com/sean-public/skiplist-survey

æˆ‘åœ¨ä»–çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€äº›å…¶ä»–çš„å®ç°å’Œæˆ‘çš„å®ç°ï¼Œåšäº† benchmarkï¼Œä¸Šè¿°ä¼˜åŒ–çš„æ•°æ®ç±»å‹ä¼˜åŒ–å°±æ˜¯åŸºäºæ­¤è¯„æµ‹ç»“æœåšçš„ã€‚

[https://github.com/chen3feng/skiplist-survey](https://github.com/chen3feng/skiplist-survey)

ä»¥ä¸‹æ˜¯éƒ¨åˆ†è¯„æµ‹ç»“æœï¼Œæ•°å€¼è¶Šå°è¶Šå¥½ï¼š

!\[å›¾ç‰‡\](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

è™½ç„¶ä¹Ÿæœ‰å°‘é‡æŒ‡æ ‡ä¸æ˜¯æœ€å¿«çš„ï¼Œä½†æ˜¯æ€»ä½“ä¸Šåœ¨å¤§éƒ¨åˆ†æŒ‡æ ‡ä¸Šï¼Œè¶…è¶Šäº†æˆ‘åœ¨ github ä¸Šæ‰¾åˆ°çš„å…¶ä»–å®ç°ã€‚å¹¶ä¸”å¤§éƒ¨åˆ†å…¶ä»–å®ç° key åªæ”¯æŒ int64 æˆ–è€… float64ï¼Œä½¿å¾—æ— æ³•ç”¨äº string ç­‰ç±»å‹ã€‚

å¦å¤–ä¹Ÿå¯¹ C++çš„å®ç°æµ‹äº†ä¸€ä¸‹æ€§èƒ½ï¼š

!\[å›¾ç‰‡\](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å‘ç° Go çš„å®ç°æ€§èƒ½å¾ˆå¤šæŒ‡æ ‡åŸºæœ¬æ¥è¿‘ C++ï¼Œå…¶ä¸­ Delete åè€Œæ›´å¿«ä¸€äº›ï¼Œæ˜¯å› ä¸º C++åœ¨åˆ é™¤æ—¶è¦ææ„èŠ‚ç‚¹å¹¶é‡Šæ”¾å†…å­˜ï¼Œè€Œ Go é‡‡ç”¨ GC çš„æ–¹å¼å»¶åæ—è·¯å¤„ç†ã€‚

### ä¸ƒã€å¿ƒå¾—

1ï¼‰go1.18 å¼•å…¥çš„æ³›å‹è¿˜å¯ä»¥ï¼Œè™½ç„¶åŠŸèƒ½ä¸Šä¸ç®—å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å·²ç»èƒ½æ»¡è¶³æŒºå¤§ä¸€éƒ¨åˆ†çš„éœ€æ±‚ã€‚æˆ‘ä»¬ç»„ç°åœ¨æ­£åœ¨å‡çº§åˆ° go1.19ï¼Œå¾ˆå¿«å°±èƒ½ç”¨å¾—ä¸Šã€‚\
2ï¼‰Go çš„å¼€å‘ç”Ÿæ€è¿˜æ˜¯ä¸é”™çš„ï¼Œgithub ä¸Šå¤§é‡å‚æ‰‹å¯å¾—çš„åº“ï¼ŒVS Code é«˜åº¦é›†æˆï¼Œå„ç§ä¾¿åˆ©çš„å·¥å…·ï¼Œè¿™æ˜¯æˆ‘å†™ C++ä»£ç å¾ˆéš¾ä½“éªŒåˆ°çš„ã€‚å¤§éƒ¨åˆ†ä¼˜åŒ–æ˜¯åŸºäº benchmark test æ¥åšçš„ã€‚\
3ï¼‰å¾ˆå¤šç¼–ç¨‹è¯­è¨€éœ€è¦çš„åŸºç¡€çŸ¥è¯†éƒ½æ˜¯ç›¸é€šçš„ï¼Œæ‰“å¥½åŸºç¡€ï¼Œå­¦ä¹ æ–°æŠ€æœ¯å¹¶ä¸å¤ªéš¾ã€‚\
4ï¼‰è·³å‡ºè‡ªå·±çš„èˆ’é€‚åŒºï¼Œå¤šå­¦ä¹ ä¸€äº›ç¼–ç¨‹è¯­è¨€å¼€é˜”è§†é‡æ¶¨è§è¯†ï¼Œæœ‰åˆ©äºæŒç»­æé«˜è‡ªå·±çš„æŠ€æœ¯èƒ½åŠ›ã€‚

**å‚è€ƒèµ„æ–™**

1. [Wikipedia -- Skip list](https://en.wikipedia.org/wiki/Skip_list)

1. [Go ç”Ÿæ€ä¸‹çš„å­—èŠ‚è·³åŠ¨å¤§è§„æ¨¡å¾®æœåŠ¡æ€§èƒ½ä¼˜åŒ–å®è·µ](https://my.oschina.net/u/5632822/blog/5565821)

1. [Skip List--è·³è¡¨ï¼ˆå…¨ç½‘æœ€è¯¦ç»†çš„è·³è¡¨æ–‡ç« æ²¡æœ‰ä¹‹ä¸€ï¼‰](https://www.jianshu.com/p/9d8296562806)

1. https://github.com/liyue201/gostl/blob/master/ds/skiplist/skiplist.go

1. https://github.com/sean-public/skiplist-survey

**æ¬¢è¿è§‚çœ‹è…¾è®¯ç¨‹åºå‘˜æœ€æ–°è§†é¢‘**

å› è§†é¢‘å·ä½œè€…éšç§è®¾ç½®æš‚æ— æ³•æŸ¥çœ‹

è…¾è®¯ç¨‹åºå‘˜

é˜…è¯»Â 7824

â€‹

å†™ç•™è¨€

[](javacript:;)

![](http://mmbiz.qpic.cn/sz_mmbiz_png/j3gficicyOvauPPfL7J2AVERiaoMJy9NBIwbJE2ZRJX7FZ2Dx7IibtTwdlqYSqTZTCsXkDS2jvNF8wWJKcibxXtOHng/300?wx_fmt=png&wxfrom=18)

è…¾è®¯æŠ€æœ¯å·¥ç¨‹

691022

å†™ç•™è¨€

å†™ç•™è¨€

**ç•™è¨€**

æš‚æ— ç•™è¨€
