# 

CPPå¼€å‘è€…

Â _2021å¹´12æœˆ20æ—¥ 11:55_

ä»¥ä¸‹æ–‡ç« æ¥æºäºé«˜æ€§èƒ½æ¶æ„æ¢ç´¢Â ï¼Œä½œè€…é›¨ä¹

[

![](http://wx.qlogo.cn/mmhead/Q3auHgzwzM5l59Jsg6JicJQAuib8Sc0WPkC0P6LaJzVntCQerzf7bcPg/0)

**é«˜æ€§èƒ½æ¶æ„æ¢ç´¢**.

ä¸“æ³¨äºåˆ†äº«å¹²è´§ï¼Œç¡¬è´§ï¼Œæ¬¢è¿å…³æ³¨ğŸ˜„

](https://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651168448&idx=1&sn=fc9e1723ff80d37f8425ae28da97267a&chksm=80644f9fb713c689527e039547e178920648c10a5b420a770b8b96775ef5314a91ae30d44b12&mpshare=1&scene=24&srcid=1220wBuwF3CzMDVezAzTKsZ6&sharer_sharetime=1639979795708&sharer_shareid=5fb9813bfe9ffc983435bfc8d8c5e9ca&key=daf9bdc5abc4e8d073906315d49fd797da4c5f1764347bbf8273049f9d984f91c1cfbbfcf4ba6c7e4ee0202e10e4216c48979dd3445a57a060be52b3b8ef8c1a2ab32dac049f7f70192ccb3172bb3f1462fba4362e6c495901ee350995a9ccf636e35fbc08ffbbcbd92fd01dfcfacc28f95a9e8fafb6979baf9a54a62806a7f4&ascene=0&uin=MTEwNTU1MjgwMw%3D%3D&devicetype=Windows+11+x64&version=63090b19&lang=zh_CN&countrycode=CN&exportkey=n_ChQIAhIQN5KxW3AzOrjFDq9I8Bp42hLmAQIE97dBBAEAAAAAAF2uGvyVT4IAAAAOpnltbLcz9gKNyK89dVj0kLYM2hgCQWKlmjdFOfPv07jPO1kPGwDykpbFR%2F%2FeuB4JZ4XASW5PNLqBAnfCpgwCQiTsptsyftCQaezI1jOonWTfPXEFdx8vjA%2BOpOWUIs7beNs%2F6CUwkuOrjotM0C5I7sTJSYBP0u6VNyKu0pRgCf2FWOpv1WznVqWip1%2B2MYuc4LshFrxFJuiq8EI%2FcaKCpSfJMO4CzbNDRz%2FYwvzHFTyuzic4yR2rLmKwJBmqWquMZITU7zkTwMl%2BZqb0%2FLyC&acctmode=0&pass_ticket=CB4YacbkD5LBwXroV4Ot3lSOOdujYEMJmV0qCxi6CBLLv84TMWIyRf95ISj8oSBi&wx_header=1&fasttmpl_type=0&fasttmpl_fullversion=7351805-zh_CN-zip&fasttmpl_flag=1#)

åœ¨[ä¹‹å‰çš„æ–‡ç« ](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651168422&idx=1&sn=9c467edbeca10b29ba983c24fdc08f29&chksm=80644ff9b713c6ef8a8ffd8908e24538791544af0b1f5a8a7fb69a25ac89432196bed482a0fa&scene=21#wechat_redirect)ä¸­ï¼Œåˆ†æäº†glibcå†…å­˜ç®¡ç†ç›¸å…³çš„å†…å®¹ï¼Œé‡Œé¢çš„æ˜¯ä¸æ˜¯é€»è¾‘å¤æ‚ğŸ˜ï¼Œæ¯•ç«Ÿå’±ä»¬ç”¨å‡ åè¡Œä»£ç å®Œæˆçš„åŠŸèƒ½ï¼Œglibcè¦ç”¨ä¸Šç™¾ä¹ƒè‡³ä¸Šåƒè¡Œä»£ç æ¥å®ç°ï¼Œæ¯•ç«Ÿå®ƒçš„å—ä¼—å¤ªå¤šäº†ï¼Œéœ€è¦è€ƒè™‘è·¨å¹³å°ï¼Œå„ç§è¾¹ç•Œæ¡ä»¶ç­‰ã€‚

å…¶å®ï¼Œglibcçš„å†…å­˜åˆ†é…åº“ptmallocä¹Ÿå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå†…å­˜æ± ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œæ¯æ¬¡å†…å­˜ç”³è¯·éƒ½æ˜¯å…ˆä»ptmallocä¸­è¿›è¡Œåˆ†é…ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„åˆ™é€šè¿‡ç³»ç»Ÿåˆ†é…å‡½æ•°è¿›è¡Œç”³è¯·ï¼›åœ¨é‡Šæ”¾çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å°†è¢«é‡Šæ”¾å†…å­˜å…ˆæ–¹å¼å†…å­˜æ± ä¸­ï¼Œå†…å­˜æ± æ ¹æ®ä¸€å®šçš„ç­–ç•¥ï¼Œæ¥å†³å®šæ˜¯å¦è¿›è¡Œshrinkä»¥å½’è¿˜OSã€‚

é‚£ä¹ˆï¼Œç°ä¸€ä¸ªå†…å­˜æ± ï¼Ÿæˆ‘ä»¬è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿä»Šå¤©ï¼Œå€ŸåŠ©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥è®¾è®¡å’Œå®ç°ä¸€ä¸ªå†…å­˜æ± (æ–‡æœ«é™„æœ‰githubåœ°å€)ã€‚

## èƒŒæ™¯

é¦–å…ˆéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¯¥å†…å­˜æ± æ˜¯ç¬”è€…åœ¨10å¹´å‰å®Œæˆçš„ï¼Œä¸‹é¢å…ˆè¯´ä¸‹å½“æ—¶æ­¤é¡¹ç›®çš„èƒŒæ™¯ã€‚

09å¹´ï¼Œåœ¨æŸæ‰€çš„æ—¶å€™ï¼Œå‚ä¸äº†æŸä¸ªå›½å®¶çº§é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯é˜²DDOSæ”»å‡»ç›¸å…³ï¼Œå› æ­¤æ›´å¤šçš„æ˜¯è·ŸIPç›¸å…³ï¼Œæ‰€ä»¥æ¯æ¬¡åˆ†é…å’Œé‡Šæ”¾å†…å­˜éƒ½æ˜¯å›ºå®šå¤§å°ï¼Œç»è¿‡æµ‹è¯•ï¼Œæ€§èƒ½ä¸æ˜¯å¾ˆæ»¡æ„ï¼Œæ‰€ä»¥ï¼Œç»è¿‡ä»£ç åˆ†æä»¥åŠæ€§èƒ½æ”»å‡»åˆ†æï¼Œå‘ç°é‡Œé¢æœ‰å¤§é‡çš„malloc/freeï¼Œæ‰€ä»¥ï¼Œå½“æ—¶å°±å†³å®šæ˜¯å¦ä»malloc/freeå…¥æ‰‹ï¼Œèƒ½å¦ä¼˜åŒ–æ•´ä¸ªé¡¹ç›®çš„æ€§èƒ½ã€‚

æ‰€ä»¥ï¼Œå†³å®šå®ç°ä¸€ä¸ªMemory Poolï¼Œåœ¨åšäº†è°ƒç ”ä»¥åŠç ”ç©¶äº†ç›¸å…³è®ºæ–‡åï¼Œå†³å®šå®ç°ä¸€ä¸ªå†…å­˜æ± ï¼Œå…ˆè¯•è¯•æ°´ï¼Œæ‰€å¹¸è¿çš„æ˜¯ï¼Œæ€§èƒ½ç¡®å®æ¯”glibcè‡ªå¸¦çš„malloc/freeè¦é«˜ï¼Œæ‰€ä»¥ä¹Ÿå°±åº”ç”¨äºé¡¹ç›®ä¸Šäº†ã€‚

> â
> 
> æœ¬æ–‡æ‰€è®²çš„Memory Poolä¸ºCè¯­è¨€å®ç°ï¼Œæ—¨åœ¨è®©å¤§å®¶éƒ½èƒ½çœ‹æ‡‚ï¼Œçœ‹æ˜ç™½(è‡³å°‘èƒ½å¤Ÿå®Œå…¨ç†è§£æœ¬æ–‡æ‰€è®²çš„Memory Poolçš„å®ç°åŸç†)ã€‚
> 
> â

## æ¦‚å¿µ

é¦–å…ˆï¼Œæˆ‘ä»¬ä»‹ç»ä¸‹ä»€ä¹ˆæ˜¯å†…å­˜æ± ï¼Ÿ

> â
> 
> é¢„å…ˆåœ¨å†…å­˜ä¸­ç”³è¯·ä¸€å®šæ•°é‡çš„å†…å­˜å—ç•™ä½œå¤‡ç”¨ï¼Œå½“æœ‰æ–°çš„å†…å­˜éœ€æ±‚æ—¶ï¼Œå°±å…ˆä»å†…å­˜æ± ä¸­åˆ†é…å†…å­˜è¿”å›ï¼Œåœ¨é‡Šæ”¾çš„æ—¶å€™ï¼Œå°†å†…å­˜è¿”å›ç»™å†…å­˜æ± è€Œä¸æ˜¯OSï¼Œåœ¨ä¸‹æ¬¡ç”³è¯·çš„æ—¶å€™ï¼Œé‡æ–°è¿›è¡Œåˆ†é…
> 
> â

é‚£ä¹ˆä¸ºä»€ä¹ˆè¦æœ‰å†…å­˜æ± å‘¢ï¼Ÿè¿™å°±éœ€è¦ä»ä¼ ç»Ÿå†…å­˜åˆ†é…çš„ç‰¹ç‚¹æ¥è¿›è¡Œåˆ†æï¼Œä¼ ç»Ÿå†…å­˜åˆ†é…é‡Šæ”¾çš„ä¼˜ç‚¹æ— éå°±æ˜¯é€šç”¨æ€§å¼ºï¼Œåº”ç”¨å¹¿æ³›ï¼Œä½†æ˜¯ä¼ ç»Ÿçš„å†…å­˜åˆ†é…ã€é‡Šæ”¾åœ¨æŸäº›ç‰¹å®šçš„é¡¹ç›®ä¸­ï¼Œå…¶ä¸ä¸€å®šæ˜¯æœ€ä¼˜ã€æ•ˆç‡æœ€é«˜çš„æ–¹æ¡ˆã€‚

ä¼ ç»Ÿå†…å­˜åˆ†é…ã€é‡Šæ”¾çš„ç¼ºç‚¹æ€»ç»“å¦‚ä¸‹ï¼š

1ã€è°ƒç”¨malloc/new,ç³»ç»Ÿéœ€è¦æ ¹æ®â€œæœ€å…ˆåŒ¹é…â€ã€â€œæœ€ä¼˜åŒ¹é…â€æˆ–å…¶ä»–ç®—æ³•åœ¨å†…å­˜ç©ºé—²å—è¡¨ä¸­æŸ¥æ‰¾ä¸€å—ç©ºé—²å†…å­˜ï¼Œè°ƒç”¨free/delete,ç³»ç»Ÿå¯èƒ½éœ€è¦åˆå¹¶ç©ºé—²å†…å­˜å—ï¼Œè¿™äº›ä¼šäº§ç”Ÿé¢å¤–å¼€é”€

2ã€é¢‘ç¹çš„åœ¨å †ä¸Šç”³è¯·å’Œé‡Šæ”¾å†…å­˜å¿…ç„¶éœ€è¦å¤§é‡æ—¶é—´ï¼Œé™ä½äº†ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚å¯¹äºä¸€ä¸ªéœ€è¦é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„ç¨‹åºæ¥è¯´ï¼Œé¢‘ç¹è°ƒç”¨new/mallocç”³è¯·å†…å­˜ï¼Œdelete/freeé‡Šæ”¾å†…å­˜éƒ½éœ€è¦èŠ±è´¹ç³»ç»Ÿæ—¶é—´ï¼Œé¢‘ç¹çš„è°ƒç”¨å¿…ç„¶ä¼šé™ä½ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚

3ã€ç»å¸¸ç”³è¯·å°å—å†…å­˜ï¼Œä¼šå°†ç‰©ç†å†…å­˜â€œåˆ‡â€å¾—å¾ˆç¢ï¼Œå¯¼è‡´å†…å­˜ç¢ç‰‡ã€‚ç”³è¯·å†…å­˜çš„é¡ºåºå¹¶ä¸æ˜¯é‡Šæ”¾å†…å­˜çš„é¡ºåºï¼Œå› æ­¤é¢‘ç¹ç”³è¯·å°å—å†…å­˜å¿…ç„¶ä¼šå¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œé€ æˆâ€œæœ‰å†…å­˜ä½†æ˜¯ç”³è¯·ä¸åˆ°å¤§å—å†…å­˜â€çš„ç°è±¡ã€‚
![[Pasted image 20240911000149.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å†…å­˜åˆ†é…

ä»ä¸Šå›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨ç¨‹åºä¼šè°ƒç”¨glibcè¿è¡Œæ—¶åº“çš„mallocå‡½æ•°è¿›è¡Œå†…å­˜ç”³è¯·ï¼Œè€Œmallocå‡½æ•°åˆ™ä¼šæ ¹æ®å…·ä½“ç”³è¯·çš„å†…å­˜å—å¤§å°ï¼Œæ ¹æ®å®é™…æƒ…å†µæœ€ç»ˆä»sys_brkæˆ–è€…sys_mmap_pgoffç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜ï¼Œè€Œå¤§å®¶éƒ½çŸ¥é“ï¼Œè·Ÿosæ‰“äº¤é“ï¼Œ_æ€§èƒ½æŸå¤±_æ˜¯æ¯‹åº¸ç½®ç–‘çš„ã€‚

å…¶æ¬¡ï¼Œglibcä½œä¸ºé€šç”¨çš„è¿è¡Œæ—¶åº“ï¼Œmalloc/freeéœ€è¦æ»¡è¶³å„ç§åœºæ™¯éœ€æ±‚ï¼Œæ¯”å¦‚ç”³è¯·çš„å­—èŠ‚å¤§å°ä¸ä¸€ï¼Œå¤šçº¿ç¨‹è®¿é—®ç­‰ã€‚
![[Pasted image 20240911000153.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

æ²¡æœ‰æ¯”ä¼ ç»Ÿmalloc/freeæ€§èƒ½æ›´ä¼˜çš„æ–¹æ¡ˆå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šæœ‰ã€‚

åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¢„åˆ†é…ç‰¹å®šæ•°é‡çš„å›ºå®šå¤§å°çš„å—ï¼Œè¿™æ ·æ¯æ¬¡ç”³è¯·çš„æ—¶å€™ï¼Œå°±ä»é¢„åˆ†é…çš„å—ä¸­è·å–ï¼Œé‡Šæ”¾çš„æ—¶å€™ï¼Œå°†å…¶æ”¾å…¥é¢„åˆ†é…å—ä¸­ä»¥å¤‡ä¸‹æ¬¡å¤ç”¨ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„_å†…å­˜æ± æŠ€æœ¯_ï¼Œæ¯ä¸ªå†…å­˜æ± å¯¹åº”ç‰¹å®šåœºæ™¯ï¼Œè¿™æ ·çš„è¯ï¼Œè¾ƒä¼ ç»Ÿçš„ä¼ ç»Ÿçš„malloc/freeå°‘äº†å¾ˆå¤šå¤æ‚é€»è¾‘ï¼Œæ€§èƒ½æ˜¾ç„¶ä¼šæå‡ä¸å°‘ã€‚
![[Pasted image 20240911000159.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ç»“åˆä¼ ç»Ÿmalloc/freeçš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹ä½¿ç”¨å†…å­˜æ± æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š

1ã€æ¯”malloc/freeè¿›è¡Œå†…å­˜ç”³è¯·/é‡Šæ”¾çš„æ–¹å¼å¿«

2ã€ä¸ä¼šäº§ç”Ÿæˆ–å¾ˆå°‘äº§ç”Ÿå †ç¢ç‰‡

3ã€å¯é¿å…å†…å­˜æ³„æ¼

## åˆ†ç±»

æ ¹æ®åˆ†é…å‡ºå»çš„å­—èŠ‚å¤§å°æ˜¯å¦å›ºå®šï¼Œåˆ†ä¸ºå›ºå®šå¤§å°å†…å­˜æ± å’Œå¯å˜å¤§å°å†…å­˜æ± ä¸¤ç±»ã€‚

è€Œå¯å˜å¤§å°å†…å­˜æ± ï¼Œå¯åˆ†é…ä»»æ„å¤§å°çš„å†…å­˜æ± ï¼Œæ¯”å¦‚ptmallocã€jemallocä»¥åŠgoogleçš„tcmallocã€‚
![[Pasted image 20240911000204.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å›ºå®šå¤§å°å†…å­˜æ± ï¼Œé¡¾åæ€ä¹‰ï¼Œæ¯æ¬¡ç”³è¯·å’Œé‡Šæ”¾çš„å†…å­˜å¤§å°éƒ½æ˜¯å›ºå®šçš„ã€‚æ¯æ¬¡åˆ†é…å‡ºå»çš„å†…å­˜å—å¤§å°éƒ½æ˜¯ç¨‹åºé¢„å…ˆå®šä¹‰çš„å€¼ï¼Œè€Œåœ¨é‡Šæ”¾å†…å­˜å—æ—¶å€™ï¼Œåˆ™ç®€å•çš„æŒ‚å›å†…å­˜æ± é“¾è¡¨å³å¯ã€‚
![[Pasted image 20240911000208.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

> â
> 
> æœ¬æ–‡ä¸»è¦è®²çš„æ˜¯å›ºå®šå¤§å°çš„å†…å­˜æ± ã€‚
> 
> â

## åŸç†

å†…å­˜æ± ï¼Œé‡ç‚¹åœ¨â€æ± â€œå­—ä¸Šï¼Œä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºå†…å­˜æ± ï¼Œæ˜¯åœ¨çœŸæ­£ä½¿ç”¨ä¹‹å‰ï¼Œå…ˆé¢„åˆ†é…ä¸€å®šæ•°é‡ã€å¤§å°é¢„è®¾çš„å—ï¼Œå¦‚æœæœ‰æ–°çš„å†…å­˜éœ€æ±‚æ—¶å€™ï¼Œå°±ä»å†…å­˜æ± ä¸­æ ¹æ®ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œåˆ†é…ä¸€ä¸ªå†…å­˜å—ï¼Œè‹¥å½“å‰å†…å­˜å—å·²ç»è¢«å®Œå…¨åˆ†é…å‡ºå»ï¼Œåˆ™ç»§ç»­ç”³è¯·ä¸€å¤§å—ï¼Œç„¶åè¿›è¡Œåˆ†é…ã€‚

å½“è¿›è¡Œå†…å­˜å—é‡Šæ”¾çš„æ—¶å€™ï¼Œåˆ™å°†å…¶å½’è¿˜å†…å­˜æ± ï¼Œåé¢å¦‚æœå†æœ‰ç”³è¯·çš„è¯ï¼Œåˆ™å°†å…¶é‡æ–°åˆ†é…å‡ºå»ã€‚
![[Pasted image 20240911000213.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å†…å­˜æ± ç»“æ„å›¾

ä¸Šå›¾æ˜¯æœ¬æ–‡æ‰€è¦è®¾è®¡çš„ç»“æ„å›¾ï¼Œä¸‹é¢åœ¨å…·ä½“çš„è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®²ä¸‹æœ¬å†…å­˜æ± çš„åŸç†ï¼š

- åˆ›å»ºå¹¶åˆå§‹åŒ–å¤´ç»“ç‚¹MemoryPool
    
- é€šè¿‡MemoryPoolè¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚æœå‘ç°MemoryPoolæ‰€æŒ‡å‘çš„ç¬¬ä¸€å—MemoryBlockæˆ–è€…ç°æœ‰MemoryPoolæ²¡æœ‰ç©ºé—²å†…å­˜å—ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„MemoryBlockåˆå§‹åŒ–ä¹‹åå°†å…¶æ’å…¥MemoryPoolçš„å¤´
    
- åœ¨å†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œéå†MemoryPoolä¸­çš„å•é“¾è¡¨MemoryBlockï¼Œæ ¹æ®åœ°å€åˆ¤æ–­æ‰€è¦é‡Šæ”¾çš„å†…å­˜å±äºå“ªä¸ªMemoryBlockï¼Œç„¶åæ ¹æ®åç§»è®¾ç½®MemoryBlockçš„ç¬¬ä¸€å—ç©ºé—²å—ç´¢å¼•ï¼ŒåŒæ—¶å°†ç©ºé—²å—ä¸ªæ•°+1
    

ä¸Šè¿°åªæ˜¯ä¸€ä¸ªç®€å•çš„é€»è¾‘è®²è§£ï¼Œæ¯”è¾ƒå®è§‚ï¼Œä¸‹é¢æˆ‘ä»¬å°†é€šè¿‡å›¾è§£å’Œä»£ç çš„æ–¹å¼æ¥è¿›è¡Œè®²è§£ã€‚

## è®¾è®¡

åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬ç”»å‡ºäº†å†…å­˜æ± çš„ç»“æ„å›¾ï¼Œä»å›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œæœ‰ä¸¤ä¸ªç»“æ„å˜é‡ï¼Œåˆ†åˆ«ä¸ºMemoryPoolå’ŒMemoryBlockã€‚

ä¸‹é¢æˆ‘ä»¬å°†ä»æ•°æ®ç»“æ„å’Œæ¥å£ä¸¤ä¸ªéƒ¨åˆ†å‡ºå‘ï¼Œè¯¦ç»†è®²è§£å†…å­˜æ± çš„è®¾è®¡ã€‚

### æ•°æ®ç»“æ„

#### MemoryBlock

æœ¬æ–‡ä¸­æ‰€è®²è¿°çš„å†…å­˜å—çš„åˆ†é…å’Œé‡Šæ”¾éƒ½æ˜¯é€šè¿‡è¯¥ç»“æ„è¿›è¡Œæ“ä½œï¼Œä¸‹é¢æ˜¯MemoryBlockçš„ç¤ºä¾‹å›¾ï¼š
![[Pasted image 20240911000220.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

MemoryBlock

åœ¨ä¸Šå›¾ä¸­ï¼ŒHeaderå­˜å‚¨è¯¥MemoryBlockçš„å†…å­˜å—æƒ…å†µï¼Œæ¯”å¦‚å¯ç”¨çš„å†…å­˜å—ç´¢å¼•ã€å½“å‰MemoryBlockä¸­å¯ç”¨å†…å­˜å—çš„ä¸ªæ•°ç­‰ç­‰ã€‚
![[Pasted image 20240911000225.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š
```c
structÂ MemoryBlockÂ {   Â unsignedÂ intÂ size;   Â unsignedÂ intÂ free_size;   Â unsignedÂ intÂ first_free;      Â structÂ MemoryBlockÂ *next;   Â charÂ a_data[0];Â    };   
```
å…¶ä¸­ï¼š

- sizeä¸ºMemoryBlockä¸‹å†…å­˜å—çš„ä¸ªæ•°
    
- free_sizeä¸ºMemoryBlockä¸‹ç©ºé—²å†…å­˜å—çš„ä¸ªæ•°
    
- first_freeä¸ºMemoryBlockä¸­ç¬¬ä¸€ä¸ªç©ºé—²å—çš„ç´¢å¼•
    
- nextæŒ‡å‘ä¸‹ä¸€ä¸ªMemoryBlock
    
- a_dataæ˜¯ä¸€ä¸ªæŸ”æ€§æ•°ç»„
    

> â
> 
> æŸ”æ€§æ•°ç»„å³æ•°ç»„å¤§å°å¾…å®šçš„æ•°ç»„ï¼Œ Cè¯­è¨€ä¸­ç»“æ„ä½“çš„æœ€åä¸€ä¸ªå…ƒç´ å¯ä»¥æ˜¯å¤§å°æœªçŸ¥çš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„0é•¿åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ç»“æ„ä½“æ¥åˆ›å»ºæŸ”æ€§æ•°ç»„ã€‚
> 
> å®ƒçš„ä¸»è¦ç”¨é€”æ˜¯ä¸ºäº†æ»¡è¶³éœ€è¦å˜é•¿åº¦çš„ç»“æ„ä½“ï¼Œä¸ºäº†è§£å†³ä½¿ç”¨æ•°ç»„æ—¶å†…å­˜çš„å†—ä½™å’Œæ•°ç»„çš„è¶Šç•Œé—®é¢˜ã€‚
> 
> â

#### MemoryPool

MemoryPoolä¸ºå†…å­˜æ± çš„å¤´ï¼Œé‡Œé¢å®šä¹‰äº†è¯¥å†…å­˜æ± çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ¬å†…å­˜æ± åˆ†é…çš„å›ºå®šå¯¹è±¡çš„å¤§å°ï¼Œç¬¬ä¸€ä¸ªMemoryBlockç­‰
![[Pasted image 20240911000236.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

`structÂ MemoryPoolÂ {   Â unsignedÂ intÂ obj_size;   Â unsignedÂ intÂ init_size;   Â unsignedÂ intÂ grow_size;      Â MemoryBlockÂ *first_block;   };   `

å…¶ä¸­ï¼š

- obj_sizeä¸ºå†…å­˜æ± åˆ†é…çš„å›ºå®šå†…å­˜å—çš„å¤§å°
    
- init_sizeåˆå§‹åŒ–å†…å­˜æ± æ—¶å€™åˆ›å»ºçš„å†…å­˜å—çš„ä¸ªæ•°
    
- grow_sizeå½“åˆå§‹åŒ–å†…å­˜å—ä½¿ç”¨å®Œåï¼Œå†æ¬¡ç”³è¯·å†…å­˜å—æ—¶å€™çš„ä¸ªæ•°
    
- first_blockæŒ‡å‘ç¬¬ä¸€ä¸ªMemoryBlock
    

### æ¥å£

#### memory_pool_create

`MemoryPoolÂ *memory_pool_create(unsignedÂ intÂ init_size,Â    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â unsignedÂ intÂ grow_size,Â    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â unsignedÂ intÂ size);   `

æœ¬å‡½æ•°ç”¨æ¥åˆ›å»ºä¸€ä¸ªMemoryPoolï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸‹é¢æ˜¯å‚æ•°è¯´æ˜ï¼š

- init_size è¡¨ç¤ºç¬¬ä¸€ä¸ªMemoryBlockä¸­åˆ›å»ºå—çš„ä¸ªæ•°
    
- grow_size è¡¨ç¤ºå½“MemoryPoolä¸­æ²¡æœ‰ç©ºé—²å—å¯ç”¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„MemoryBlockæ—¶å…¶å—çš„ä¸ªæ•°
    
- size ä¸ºå—çš„å¤§å°(å³æ¯æ¬¡åˆ†é…ç›¸åŒå¤§å°çš„å›ºå®šsize)
    

#### memory_alloc

`voidÂ *memory_alloc(MemoryPoolÂ *mp);   `

æœ¬å‡½æ•°ç”¨äº†ä»mpä¸­ç”³è¯·ä¸€å—å†…å­˜è¿”å›

- mp ä¸ºMemoryPoolç±»å‹æŒ‡é’ˆï¼Œå³å†…å­˜æ± çš„å¤´
    
- å¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œåˆ™è¿”å›NULL
    

#### memory_free

Â `void*Â memory_free(MemoryPoolÂ *mp,Â voidÂ *pfree);`

æœ¬å‡½æ•°ç”¨æ¥é‡Šæ”¾å†…å­˜

- mp ä¸ºMemoryPoolç±»å‹æŒ‡é’ˆï¼Œå³å†…å­˜æ± çš„å¤´
    
- pfree ä¸ºè¦é‡Šæ”¾çš„å†…å­˜
    

#### free_memory_pool

`voidÂ free_memory_pool(MemoryPoolÂ *mp);   `

æœ¬å‡½æ•°ç”¨æ¥é‡Šæ”¾å†…å­˜æ± 

## å®ç°

åœ¨è®²è§£æ•´ä¸ªå®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å…ˆå†…å­˜æ± çš„è¯¦ç»†ç»“æ„å›¾ã€‚
![[Pasted image 20240911000249.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

### åˆå§‹åŒ–å†…å­˜æ± 

MemoryPoolæ˜¯æ•´ä¸ªå†…å­˜æ± çš„å…¥å£ç»“æ„ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥åˆ›å»ºMemoryPoolå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨å‚æ•°å¯¹å…¶å†…éƒ¨çš„æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚

å‡½æ•°å®šä¹‰å¦‚ä¸‹:

`MemoryPoolÂ *memory_pool_create(unsignedÂ intÂ init_size,Â unsignedÂ intÂ grow_size,Â unsignedÂ intÂ size)   {   Â MemoryPoolÂ *mp;   Â mpÂ =Â (MemoryPool*)malloc(sizeof(MemoryPool));   Â mp->first_blockÂ =Â NULL;   Â mp->init_sizeÂ =Â init_size;   Â mp->grow_sizeÂ =Â grow_size;      Â if(sizeÂ <Â sizeof(unsignedÂ int))   Â Â mp->obj_sizeÂ =Â sizeof(unsignedÂ int);   Â mp->obj_sizeÂ =Â (sizeÂ +Â (MEMPOOL_ALIGNMENT-1))Â &Â ~(MEMPOOL_ALIGNMENT-1);      Â returnÂ mp;   }   `

### å†…å­˜åˆ†é…

`voidÂ *memory_alloc(MemoryPoolÂ *mp)Â {      Â unsignedÂ intÂ i;   Â unsignedÂ intÂ length;      Â if(mp->first_blockÂ ==Â NULL)Â {   Â Â MemoryBlockÂ *mb;   Â Â lengthÂ =Â (mp->init_size)*(mp->obj_size)Â +Â sizeof(MemoryBlock);   Â Â mbÂ =Â malloc(length);   Â Â if(mbÂ ==Â NULL)Â {   Â Â Â perror("memoryÂ allocateÂ failed!\n");   Â Â Â returnÂ NULL;   Â Â }      Â Â /*Â initÂ theÂ firstÂ blockÂ */   Â Â mb->nextÂ =Â NULL;   Â Â mb->free_sizeÂ =Â mp->init_sizeÂ -Â 1;   Â Â mb->first_freeÂ =Â 1;   Â Â mb->sizeÂ =Â mp->init_size*mp->obj_size;      Â Â mp->first_blockÂ =Â mb;   Â Â    Â Â charÂ *dataÂ =Â mb->a_data;      Â Â /*Â setÂ theÂ markÂ */   Â Â for(i=1;Â i<mp->init_size;Â ++i)Â {   Â Â Â *(unsignedÂ longÂ *)dataÂ =Â i;   Â Â Â dataÂ +=Â mp->obj_size;   Â Â }      Â Â returnÂ (voidÂ *)mb->a_data;   Â }      Â MemoryBlockÂ *pm_blockÂ =Â mp->first_block;      Â while((pm_blockÂ !=Â NULL)Â &&Â (pm_block->free_sizeÂ ==Â 0))Â {   Â Â pm_blockÂ =Â pm_block->next;   Â }      Â if(pm_blockÂ !=Â NULL)Â {   Â Â charÂ *pfreeÂ =Â pm_block->a_dataÂ +Â pm_block->first_freeÂ *Â mp->obj_size;      Â Â pm_block->first_freeÂ =Â *((unsignedÂ longÂ *)pfree);   Â Â pm_block->free_size--;      Â Â returnÂ (voidÂ *)pfree;   Â }Â elseÂ {   Â Â if(mp->grow_sizeÂ ==Â 0)   Â Â Â returnÂ NULL;   Â Â    Â Â Â Â MemoryBlockÂ *new_blockÂ =Â (MemoryBlockÂ *)malloc((mp->grow_size)*(mp->obj_size)Â +Â sizeof(MemoryBlock));      Â Â if(new_blockÂ ==Â NULL)   Â Â Â returnÂ NULL;      Â Â charÂ *dataÂ =Â new_block->a_data;      Â Â for(i=1;Â i<mp->grow_size;Â ++i)Â {   Â Â Â *(unsignedÂ longÂ *)dataÂ =Â i;   Â Â Â dataÂ +=Â mp->obj_size;   Â Â }Â Â       Â Â new_block->sizeÂ =Â mp->grow_size*mp->obj_size;   Â Â new_block->free_sizeÂ =Â mp->grow_size-1;   Â Â new_block->first_freeÂ =Â 1;   Â Â new_block->nextÂ =Â mp->first_block;   Â Â mp->first_blockÂ =Â new_block;   Â Â    Â Â returnÂ (voidÂ *)new_block->a_data;   Â }   }   `

å†…å­˜å—ä¸»è¦åœ¨MemoryBlockç»“æ„ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ç”³è¯·çš„å†…å­˜ï¼Œéƒ½æ˜¯ä»MemoryBlockä¸­è¿›è¡Œè·å–ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- è·å–MemoryPoolä¸­çš„first_blockæŒ‡é’ˆ
    

- å¦‚æœè¯¥æŒ‡é’ˆä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªMemoryBlockï¼Œfirst_blockæŒ‡å‘æ–°å»ºçš„MemoryBlockï¼Œå¹¶è¿”å›
    
- å¦åˆ™ï¼Œä»first_blockè¿›è¡Œå•é“¾è¡¨éå†ï¼ŒæŸ¥æ‰¾ç¬¬ä¸€ä¸ªfree_sizeä¸ä¸º0çš„MemoryBlockï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™å¯¹è¯¥MemoryBlockçš„ç›¸å…³å‚æ•°è¿›è¡Œè®¾ç½®ï¼Œç„¶åè¿”å›å†…å­˜å—
    
- å¦åˆ™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„MemoryBlockï¼Œè¿›è¡Œåˆå§‹åŒ–åˆ†é…ä¹‹åï¼Œå°†å…¶æ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨(è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ä¸‹æ¬¡åˆ†é…æ•ˆç‡ï¼Œå³å‡å°äº†é“¾è¡¨çš„éå†)
    

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¬30-33è¡Œæˆ–è€…67-70è¡Œï¼Œè¿™ä¸¤è¡Œçš„åŠŸèƒ½ä¸€æ ·ï¼Œéƒ½æ˜¯å¯¹æ–°ç”³è¯·çš„å†…å­˜å—è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™å‡ è¡Œçš„æ„æ€ï¼Œæ˜¯è¦å°†ç©ºé—²å—è¿æ¥èµ·æ¥ï¼Œä½†æ˜¯ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é“¾è¡¨æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡indexæ–¹å¼è¿›è¡Œè¿æ¥ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![[Pasted image 20240911000304.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

åœ¨ä¸Šå›¾ä¸­ï¼Œç¬¬0å—ç©ºé—²å—çš„ä¸‹ä¸€ä¸ªç©ºé—²å—ç´¢å¼•ä¸º1ï¼Œè€Œç¬¬1å—ç©ºé—²å—çš„ç´¢å¼•ä¸º2ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå½¢æˆäº†å¦‚ä¸‹é“¾è¡¨æ–¹å¼

> â
> 
> 1->2->3->4->5
> 
> â

å†…å­˜åˆ†é…æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š
![[Pasted image 20240911000311.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

### å†…å­˜é‡Šæ”¾

`void*Â memory_free(MemoryPoolÂ *mp,Â voidÂ *pfree)Â {   Â if(mp->first_blockÂ ==Â NULL)Â {   Â Â Â Â return;   Â Â }      Â MemoryBlockÂ *pm_blockÂ =Â mp->first_block;   Â MemoryBlockÂ *pm_pre_blockÂ =Â mp->first_block;   Â    Â /*Â researchÂ theÂ MemoryBlockÂ whichÂ theÂ pfreeÂ inÂ */   Â while(pm_blockÂ &&Â ((unsignedÂ long)pfreeÂ <Â (unsignedÂ long)pm_block->a_dataÂ ||Â    Â Â (unsignedÂ long)pfree>((unsignedÂ long)pm_block->a_data+pm_block->size)))Â {   Â Â //pm_pre_blockÂ =Â pm_block;   Â Â pm_blockÂ =Â pm_block->next;      Â Â if(pm_blockÂ ==Â NULL)Â {   Â Â Â Â Â Â returnÂ pfree;   Â Â Â Â }   Â }      Â unsignedÂ intÂ offsetÂ =Â pfreeÂ -(void*)Â pm_block->a_data;      Â if((offset&(mp->obj_sizeÂ -1))Â >Â 0)Â {   Â Â Â Â returnÂ pfree;   Â Â }      Â pm_block->free_size++;   Â *((unsignedÂ intÂ *)pfree)Â =Â pm_block->first_free;      Â pm_block->first_free=(unsignedÂ int)(offset/mp->obj_size);      Â returnÂ NULL;   }   `

å†…å­˜é‡Šæ”¾è¿‡ç¨‹å¦‚ä¸‹ï¼š

- åˆ¤æ–­å½“å‰MemoryPoolçš„first_blockæŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›
    
- å¦åˆ™ï¼Œéå†MemoryBlocké“¾è¡¨ï¼Œæ ¹æ®æ‰€é‡Šæ”¾çš„æŒ‡é’ˆå‚æ•°åˆ¤æ–­æ˜¯å¦åœ¨æŸä¸€ä¸ªMemoryBlockä¸­
    

- å¦‚æœæ‰¾åˆ°ï¼Œåˆ™å¯¹MemoryBlockä¸­çš„å„ä¸ªå‚æ•°è¿›è¡Œæ“ä½œï¼Œç„¶åè¿”å›
    
- å¦åˆ™ï¼Œæ²¡æœ‰åˆé€‚çš„MemoryBlockï¼Œåˆ™è¡¨æ˜è¯¥è¢«é‡Šæ”¾çš„æŒ‡é’ˆä¸åœ¨å†…å­˜æ± ä¸­ï¼Œè¿”å›
    

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œéœ€è¦æ³¨æ„ç¬¬20-29è¡Œã€‚

- ç¬¬20è¡Œï¼Œæ±‚å‡ºè¢«é‡Šæ”¾çš„å†…å­˜å—åœ¨MemoryBlockä¸­çš„åç§»
    
- ç¬¬22è¡Œï¼Œåˆ¤æ–­æ˜¯å¦èƒ½è¢«æ•´é™¤ï¼Œå³æ˜¯å¦åœ¨è¿™ä¸ªå†…å­˜å—ä¸­ï¼Œç®—æ˜¯ä¸ªdouble check
    
- ç¬¬26è¡Œï¼Œå°†è¯¥MemoryBlockä¸­çš„ç©ºé—²å—ä¸ªæ•°åŠ 1
    
- ç¬¬27-29è¡Œï¼Œç±»ä¼¼äºé“¾è¡¨çš„æ’å…¥ï¼Œå°†æ–°é‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•æ”¾å…¥é“¾è¡¨å¤´ï¼Œè€Œå…¶å†…éƒ¨çš„æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨å†…å­˜å—
    

ç°åœ¨ä¸¾ä¸ªä¾‹å­ï¼Œä»¥ä¾¿äºç†è§£ï¼Œå‡è®¾åœ¨ä¸€å¼€å§‹æœ‰5ä¸ªç©ºé—²å—ï¼Œå…¶ä¸­å‰ä¸‰ä¸ªç©ºé—²å—éƒ½åˆ†é…å‡ºå»äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œç©ºé—²å—é“¾è¡¨å¦‚ä¸‹:

> â
> 
> 4->5ï¼Œå…¶ä¸­first_free = 4
> 
> â

ç„¶ååœ¨æŸä¸€ä¸ªæ—¶åˆ»ï¼Œç¬¬1å—é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆé‡Šæ”¾å½’è¿˜ä¹‹åï¼Œå¦‚ä¸‹:

> â
> 
> 1->4->5ï¼Œå…¶ä¸­first_free = 1
> 
> â

å†…å­˜é‡Šæ”¾æµç¨‹å›¾å¦‚ä¸‹ï¼š
![[Pasted image 20240911000319.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å†…å­˜é‡Šæ”¾

### é‡Šæ”¾å†…å­˜æ± 

`voidÂ free_memory_pool(MemoryPoolÂ *mp)Â {   Â MemoryBlockÂ *mbÂ =Â mp->first_block;      Â if(mbÂ !=Â NULL)Â {   Â Â while(mb->nextÂ !=Â NULL)Â {   Â Â Â s_memory_blockÂ *delete_blockÂ =Â mb;   Â Â Â mbÂ =Â mb->next;      Â Â Â free(delete_block);   Â Â }      Â Â free(mb);   Â }   Â Â    Â free(mp);   }   `
![[Pasted image 20240911000325.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ä¸Šå›¾æ˜¯ä¸€ä¸ªå®Œæ•´çš„åˆ†é…å’Œé‡Šæ”¾ç¤ºæ„å›¾ï¼Œä¸‹é¢ï¼Œæˆ‘ç»“åˆä»£ç æ¥åˆ†æï¼š

- (a)æ­¥ï¼Œåˆ›å»ºäº†ä¸€ä¸ªMemoryPoolç»“æ„ä½“
    

- obj_size = 4ä»£è¡¨æœ¬å†…å­˜æ± åˆ†é…çš„å†…å­˜å—å¤§å°ä¸º4
    
- init_size = 5ä»£è¡¨åˆ›å»ºå†…å­˜æ± çš„æ—¶å€™ï¼Œç¬¬ä¸€å—MemoryBlockçš„ç©ºé—²å†…å­˜å—ä¸ªæ•°ä¸º5
    
- grow_size = 5ä»£è¡¨å½“ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²å†…å­˜ï¼Œåˆ™åˆ›å»ºçš„æ–°çš„MemoryBlockçš„ç©ºé—²å†…å­˜å—ä¸ªæ•°ä¸º5
    

- (b)æ­¥ï¼Œåˆ†é…å‡ºå»ä¸€å—å†…å­˜
    

- æ­¤æ—¶ï¼Œfree_sizeå³è¯¥MemoryBlockä¸­å¯ç”¨ç©ºé—²å—ä¸ªæ•°ä¸º4
    
- first_free = 1ï¼Œä»£è¡¨å°†å†…å­˜å—åˆ†é…å‡ºå»ä¹‹åï¼Œä¸‹ä¸€ä¸ªå¯ç”¨çš„å†…å­˜å—çš„indexä¸º1
    

- (c)æ­¥ï¼Œåˆ†é…å‡ºå»ä¸€å—å†…å­˜
    

- æ­¤æ—¶ï¼Œfree_sizeå³è¯¥MemoryBlockä¸­å¯ç”¨ç©ºé—²å—ä¸ªæ•°ä¸º3
    
- first_free = 2ï¼Œä»£è¡¨å°†å†…å­˜å—åˆ†é…å‡ºå»ä¹‹åï¼Œä¸‹ä¸€ä¸ªå¯ç”¨çš„å†…å­˜å—çš„indexä¸º2
    

- (d)æ­¥ï¼Œåˆ†é…å‡ºå»ä¸€å—å†…å­˜
    

- æ­¤æ—¶ï¼Œfree_sizeå³è¯¥MemoryBlockä¸­å¯ç”¨ç©ºé—²å—ä¸ªæ•°ä¸º2
    
- first_free = 3ï¼Œä»£è¡¨å°†å†…å­˜å—åˆ†é…å‡ºå»ä¹‹åï¼Œä¸‹ä¸€ä¸ªå¯ç”¨çš„å†…å­˜å—çš„indexä¸º3
    

- (e)æ­¥ï¼Œåˆ†é…å‡ºå»ä¸€å—å†…å­˜
    

- æ­¤æ—¶ï¼Œfree_sizeå³è¯¥MemoryBlockä¸­å¯ç”¨ç©ºé—²å—ä¸ªæ•°ä¸º1
    
- first_free = 4ï¼Œä»£è¡¨å°†å†…å­˜å—åˆ†é…å‡ºå»ä¹‹åï¼Œä¸‹ä¸€ä¸ªå¯ç”¨çš„å†…å­˜å—çš„indexä¸º4
    

- (f)æ­¥ï¼Œé‡Šæ”¾ç¬¬1ä¸ªå†…å­˜å—
    

- å°†free_sizeè¿›è¡Œ+1æ“ä½œ
    
- fire_freeå€¼ä¸ºæ­¤æ¬¡é‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•ï¼Œè€Œé‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•é‡Œé¢çš„å€¼åˆ™ä¸ºä¹‹å‰first_freeçš„å€¼(æ­¤å¤„é‡Šæ”¾ç”¨çš„å‰å·®æ³•)
    

- (g)æ­¥ï¼Œé‡Šæ”¾ç¬¬3ä¸ªå†…å­˜å—
    

- å°†free_sizeè¿›è¡Œ+1æ“ä½œ
    
- fire_freeå€¼ä¸ºæ­¤æ¬¡é‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•ï¼Œè€Œé‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•é‡Œé¢çš„å€¼åˆ™ä¸ºä¹‹å‰first_freeçš„å€¼(æ­¤å¤„é‡Šæ”¾ç”¨çš„å‰å·®æ³•)
    

- (h)æ­¥ï¼Œé‡Šæ”¾ç¬¬3ä¸ªå†…å­˜å—
    

- å°†free_sizeè¿›è¡Œ+1æ“ä½œ
    
- fire_freeå€¼ä¸ºæ­¤æ¬¡é‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•ï¼Œè€Œé‡Šæ”¾çš„å†…å­˜å—çš„ç´¢å¼•é‡Œé¢çš„å€¼åˆ™ä¸ºä¹‹å‰first_freeçš„å€¼(æ­¤å¤„é‡Šæ”¾ç”¨çš„å‰å·®æ³•)
    

## æµ‹è¯•

æµ‹è¯•ä»£ç å¦‚ä¸‹:

`#includeÂ "memory_pool.h"   #includeÂ <sys/time.h>   #includeÂ <malloc.h>   #includeÂ <stdio.h>      intÂ main()Â {   Â Â MemoryPoolÂ *mpÂ =Â memory_pool_create(8);      Â Â structÂ timevalÂ start;   Â Â structÂ timevalÂ end;      Â Â intÂ t[]Â =Â {20000,Â 40000,Â 80000,Â 100000,Â 120000,Â 140000,Â 160000,Â 180000,Â 200000};   Â Â intÂ sÂ =Â sizeof(t)/sizeof(int);   Â Â forÂ (intÂ iÂ =Â 0;Â iÂ <Â s;Â ++i)Â {   Â Â Â Â gettimeofday(&start,Â NULL);   Â Â Â Â forÂ (intÂ jÂ =Â 0;Â jÂ <Â t[i];Â ++j)Â {      Â Â Â Â Â Â voidÂ *pÂ =Â memory_alloc(mp);   Â Â Â Â Â Â memory_free(mp,Â p);   Â Â Â Â Â //   Â Â Â Â Â //voidÂ *pÂ =Â malloc(8);   Â Â Â Â Â //free(p);   Â Â Â Â }   Â Â Â Â gettimeofday(&end,Â NULL);   Â Â Â Â longÂ costÂ =Â 1000000Â *Â (end.tv_secÂ -Â start.tv_sec)Â +   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â end.tv_usecÂ -Â start.tv_usec;      Â Â Â Â printf("%ld\n",cost);   Â Â }   Â Â    Â Â free_memory_pool(mp);   Â Â returnÂ 0;   }   `

æ•°æ®å¯¹æ¯”å¦‚ä¸‹ï¼š
![[Pasted image 20240911000333.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œpoolçš„åˆ†é…æ•ˆç‡é«˜äºä¼ ç»Ÿçš„mallocæ–¹å¼ï¼Œæ€§èƒ½æé«˜æ¥è¿‘100%

> â
> 
> æœ¬æµ‹è¯•ç»“æœä»…é’ˆå¯¹å½“æ—¶çš„é¡¹ç›®ï¼Œå¯¹å…¶ä»–æµ‹è¯•caseä¸å…·æœ‰æ™®éæ€§
> 
> â

## æ‰©å±•

åœ¨æ–‡ç« å‰é¢ï¼Œæˆ‘ä»¬æœ‰æè¿‡æœ¬å†…å­˜æ± æ˜¯_å•çº¿ç¨‹ã€å›ºå®šå¤§å°çš„_ï¼Œä½†æ˜¯å¾€å¾€è¿™ç§è¿˜æ˜¯ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œå¦‚ä¸‹å‡ ä¸ªåœºæ™¯

- å•çº¿ç¨‹å¤šå›ºå®šå¤§å°
    
- å¤šçº¿ç¨‹å›ºå®šå¤§å°
    
- å¤šçº¿ç¨‹å¤šå›ºå®šå¤§å°
    

> â
> 
> å¤šå›ºå®šå¤§å°ï¼ŒæŒ‡çš„æ˜¯æå‰é¢„æ”¯éœ€è¦ç”³è¯·çš„å†…å­˜å¤§å°
> 
> â

å•çº¿ç¨‹å¤šå›ºå®šå¤§å°: é’ˆå¯¹æ­¤åœºæ™¯ï¼Œç”±äºå·²ç»é¢„çŸ¥äº†æ‰€ç”³è¯·çš„sizeï¼Œæ‰€ä»¥å¯ä»¥é’ˆå¯¹æ¯ä¸ªsizeåˆ›å»ºä¸€ä¸ªå†…å­˜æ± 

å¤šçº¿ç¨‹å›ºå®šå¤§å°ï¼šé’ˆå¯¹æ­¤åœºæ™¯ï¼Œæœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ¡ˆ

- ä½¿ç”¨ThreadLocalCache
    
- æ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªå†…å­˜æ± 
    
- ä½¿ç”¨åŠ é”ï¼Œæ“ä½œå…¨å±€å”¯ä¸€å†…å­˜æ± (æ¯æ¬¡åŠ é”è§£é”è€—æ—¶100nså·¦å³)
    

å¤šçº¿ç¨‹å¤šå›ºå®šå¤§å°ï¼šé’ˆå¯¹æ­¤åœºæ™¯ï¼Œå¯ä»¥ç»“åˆä¸Šè¿°ä¸¤ä¸ªæ–¹æ¡ˆï¼Œå³

- ä½¿ç”¨ThreadCacheï¼Œæ¯ä¸ªçº¿ç¨‹å†…åˆ›å»ºå¤šå›ºå®šå¤§å°çš„å†…å­˜æ± 
    
- æ¯ä¸ªçº¿ç¨‹å†…åˆ›å»ºä¸€ä¸ªå¤šå›ºå®šå¤§å°çš„å†…å­˜æ± 
    
- ä½¿ç”¨åŠ é”ï¼Œæ“ä½œå…¨å±€å”¯ä¸€å†…å­˜æ± (æ¯æ¬¡åŠ é”è§£é”è€—æ—¶100nså·¦å³)
    

> â
> 
> ä¸Šè¿°å‡ ç§æ–¹æ¡ˆï¼Œä»…ä»…æ˜¯åœ¨ä½¿ç”¨å›ºå®šå¤§å°å†…å­˜æ± åŸºç¡€ä¸Šè¿›è¡Œçš„æ‰©å±•ï¼Œå…·ä½“çš„æ–¹æ¡ˆï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µæ¥å…·ä½“åˆ†æ
> 
> â

## ç»“è¯­

æœ¬æ–‡ä¸»è¦è®²äº†å›ºå®šå¤§å°å†…å­˜æ± çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºå®ç°æ–¹æ¡ˆçš„å±€é™æ€§ï¼Œæ­¤å†…å­˜æ± è®¾è®¡æ–¹æ¡ˆä»…é€‚ç”¨äºæ¯æ¬¡ç”³è¯·éƒ½æ˜¯ç‰¹å®šå¤§å°çš„åœºæ™¯ã€‚è™½ç„¶åœ¨æ‰©å±•éƒ¨åˆ†åšäº†éƒ¨åˆ†æ€ç»´å‘æ•£ï¼Œä½†å› ä¸ºæœªåšå……åˆ†çš„æ•°æ®å¯¹æ¯”ï¼Œæ‰€ä»¥ä»…é™äºæ€ç»´æ‰©æ•£ã€‚

ç›®å‰ï¼Œå¼€æºçš„å†…å­˜åˆ†é…åº“å¾ˆå¤šï¼Œæ¯”è¾ƒä¼˜ç§€çš„æœ‰è°·æ­Œçš„tcmallocä»¥åŠå¾®è½¯çš„mimallocï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±é¡¹ç›®çš„éœ€æ±‚åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„å†…å­˜åˆ†é…åº“ã€‚

> â
> 
> æœ¬æ–‡æ‰€è®²çš„å†…å­˜æ± æºç åœ°å€ï¼š
> 
> https://github.com/namelij/fixedsize_memorypool
> 
> â

- EOF -

æ¨èé˜…è¯»Â Â ç‚¹å‡»æ ‡é¢˜å¯è·³è½¬

1ã€[2 ä¸‡å­— | 30 å¼ å›¾å¸¦ä½ é¢†ç•¥ glibc å†…å­˜ç®¡ç†ç²¾é«“](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651168422&idx=1&sn=9c467edbeca10b29ba983c24fdc08f29&chksm=80644ff9b713c6ef8a8ffd8908e24538791544af0b1f5a8a7fb69a25ac89432196bed482a0fa&scene=21#wechat_redirect)

2ã€[è…¾è®¯ C++ ç¬”è¯•/é¢è¯•é¢˜åŠç­”æ¡ˆ](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651168373&idx=1&sn=3727d1be774a65e101ead8435585352b&chksm=80644f2ab713c63c7be5e4dd31d9b8c022dd06261416fff13dc9db4935e3599d458f3355497f&scene=21#wechat_redirect)

3ã€[é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰çš„å‰ä¸–ä»Šç”Ÿï¼ˆä¸Šï¼‰](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651168291&idx=1&sn=f68c1d2f2a29577759bee1dd822d576f&chksm=80644f7cb713c66a50c4638f67a28a7ea3e07f541c0b113da178605ad0a33072d120263cf02c&scene=21#wechat_redirect)

  

**å…³æ³¨ã€CPPå¼€å‘è€…ã€**  

çœ‹ç²¾é€‰C++æŠ€æœ¯æ–‡ç«  .Â åŠ C++å¼€å‘è€…ä¸“å±åœˆå­

![](https://res.wx.qq.com/t/fed_upload/b39ef69e-c4d6-4169-8612-5f00a84860e7/wx-avatar-default.svg)

å…¬ä¼—å·

ç‚¹èµå’Œåœ¨çœ‹å°±æ˜¯æœ€å¤§çš„æ”¯æŒâ¤ï¸

é˜…è¯»Â 2812

â€‹

å†™ç•™è¨€

[](javacript:;)

![](http://mmbiz.qpic.cn/mmbiz_png/pldYwMfYJpia3uWic6GbPCC1LgjBWzkBVqYrMfbfT6o9uMDnlLELGNgYDP496LvDfiaAiaOt0cZBlBWw4icAs6OHg8Q/300?wx_fmt=png&wxfrom=18)

CPPå¼€å‘è€…

9åˆ†äº«6

å†™ç•™è¨€

å†™ç•™è¨€

**ç•™è¨€**

æš‚æ— ç•™è¨€