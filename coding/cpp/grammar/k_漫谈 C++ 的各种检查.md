> èƒŒæ™¯é˜…è¯»

åœ¨å­¦ä¹ äº†Â [Chromium/base åº“](https://github.com/chromium/chromium/tree/master/base)ï¼ˆ[ç¬”è®°](http://md.aclickall.com/Chromium-Base-Notes.md)ï¼‰åï¼Œæˆ‘ä½“ä¼šåˆ°äº†ä¸€èˆ¬äººå’ŒÂ **ä¼˜ç§€å·¥ç¨‹å¸ˆ**Â çš„å·®è· â€”â€” æ‹¥æœ‰è¾ƒé«˜çš„ä¸ªäººç´ è´¨å›ºç„¶é‡è¦ï¼Œä½†æ›´é‡è¦çš„æ˜¯èƒ½Â **é™ä½å¼€å‘é—¨æ§›**ï¼Œè®©å…¶ä»–äººæ›´å¿«çš„èå…¥å›¢é˜Ÿï¼Œä¸€èµ·åä½œï¼ˆå°¤å…¶åƒ ChromiumÂ **å¼€æºé¡¹ç›®**Â ç”±ç¤¾åŒºç»´æŠ¤ï¼Œå¼€å‘è€…æ°´å¹³å‚å·®ä¸é½ï¼‰ã€‚

> æ²¡åƒè¿‡çŒªè‚‰ï¼Œä½†è§è¿‡çŒªè·‘ã€‚ğŸ™ƒ

é¡¹ç›®ä¸­ï¼Œé™ä½å¼€å‘é—¨æ§›çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼šé™¤äº† åˆ¶å®šÂ **ä»£ç è§„èŒƒ**ã€åˆ’åˆ†Â **åŠŸèƒ½æ¨¡å—**ã€å®Œå–„Â **å•å…ƒæµ‹è¯•**Â _(unit test)_ã€æ¨è¡ŒÂ **ä»£ç å®¡æŸ¥**Â _(code review)_ã€æ•´ç†Â **ç›¸å…³æ–‡æ¡£**Â ä¹‹å¤–ï¼Œé’ˆå¯¹å¼ºç±»å‹çš„ç¼–è¯‘è¯­è¨€ C++ï¼ŒChromium/base åº“åŠ å…¥äº†å¤§é‡çš„Â **æ£€æŸ¥**Â _(check)_ã€‚

ä¸ºä»€ä¹ˆä»£ç ä¸­éœ€è¦å„ç§æ£€æŸ¥ï¼Ÿåœ¨ C++ ä¸­è°ƒç”¨ä¸€ä¸ªå‡½æ•°ã€ä½¿ç”¨ä¸€ä¸ªç±»ã€å®ä¾‹åŒ–ä¸€ä¸ªæ¨¡æ¿æ—¶ï¼Œå¯¹ä¼ å…¥çš„å‚æ•°ã€ä½¿ç”¨çš„æ—¶æœºï¼Œå¾€å¾€ä¼šæœ‰å¾ˆå¤šÂ **é™åˆ¶**Â _(constraint/restriction)_ï¼ˆä¾‹å¦‚ï¼Œæ•°å€¼å‚æ•°ä¸èƒ½ä¼ å…¥è´Ÿæ•°ã€å¯¹è±¡çš„è®¿é—®ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€å‡½æ•°è°ƒç”¨ä¸èƒ½é‡å…¥ï¼‰ï¼›è€Œå¤„ç†é™åˆ¶çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼š

- å£å£ç›¸ä¼ ï¼šåœ¨Â **ä»£ç å®¡æŸ¥**Â æ—¶ï¼Œæœ‰ç»éªŒçš„å¼€å‘è€… å‘ æ–°æ‰‹å¼€å‘è€… ä¼ æˆç»éªŒï¼ˆå¾ˆå®¹æ˜“å¤±ä¼ ï¼‰
- æ–‡æ¡£è¯´æ˜ï¼šåœ¨Â **ç›¸å…³æ–‡æ¡£**Â ä¸­ï¼Œæç¤ºä½¿ç”¨è€… åŠŸèƒ½æ¨¡å—çš„å„ç§éšå«é™åˆ¶ï¼ˆå¾ˆå®¹æ˜“è¢«å¿½ç•¥ï¼‰
- æ£€æŸ¥é™åˆ¶ï¼šåœ¨åˆç†åˆ’åˆ†Â **åŠŸèƒ½æ¨¡å—**Â çš„å‰æä¸‹ï¼Œå¯¹æ¨¡å—çš„éšå«é™åˆ¶ è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åŠ å…¥é’ˆå¯¹æ£€æŸ¥çš„Â **å•å…ƒæµ‹è¯•**ï¼ˆæœ€å®‰å…¨çš„ä¿éšœï¼Œå•å…ƒæµ‹è¯•å³æ–‡æ¡£ï¼‰

æœ¬æ–‡ä¸»è¦åˆ†äº« Chromium/base åº“ä¸­ä½¿ç”¨çš„ä¸€äº›é™åˆ¶æ£€æŸ¥ã€‚

> æ¼«è°ˆ C++ çš„å„ç§æ£€æŸ¥

## **1 ç¼–è¯‘æ—¶æ£€æŸ¥**

ç¼–è¯‘æ—¶é™æ€æ£€æŸ¥ï¼Œä¸»è¦ä¾é  C++ è¯­è¨€æä¾›çš„Â **è¯­æ³•æ”¯æŒ**/**é™æ€æ–­è¨€**Â å’ŒÂ **ç¼–è¯‘å™¨æ‰©å±•**Â å®ç° â€”â€” åœ¨æ£€æŸ¥å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å¤±è´¥ã€‚

### **1.1 æµ‹è¯•è®¾æ–½**

å¦‚ä½•ç¡®ä¿ä»£ç ä¸­æ·»åŠ çš„æ£€æŸ¥æœ‰æ•ˆå‘¢ï¼Ÿæœ€é«˜æ•ˆçš„æ–¹æ³•æ˜¯ï¼šä¸º â€œæ£€æŸ¥â€ æ·»åŠ å•å…ƒæµ‹è¯•ã€‚ä½†å¯¹äº ç¼–è¯‘æ—¶æ£€æŸ¥ é‡åˆ°äº†ä¸€ä¸ªÂ **éš¾ç‚¹**Â â€”â€” å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé‚£ä¹ˆç¼–è¯‘å°±æ— æ³•é€šè¿‡ã€‚

ä¸ºæ­¤ï¼ŒChromium æ”¯æŒÂ [ç¼–è¯‘å¤±è´¥æµ‹è¯•Â _(no-compile test)_](https://dev.chromium.org/developers/testing/no-compile-tests)ï¼š

- å•å…ƒæµ‹è¯•æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªç”¨ä¾‹é€šè¿‡Â `#ifdef`Â åˆ‡å‰²
- æ¯ä¸ªç”¨ä¾‹ä¸­ï¼Œæ ‡æ˜ ç¼–è¯‘å¤±è´¥åæœŸæœ›çš„ æŠ¥é”™ç»†èŠ‚
- é€šè¿‡Â `#define`Â è¿è¡Œå„ä¸ªç”¨ä¾‹
- åœ¨ç¼–è¯‘å¤±è´¥åï¼Œæ£€æŸ¥ æŠ¥é”™ç»†èŠ‚ æ˜¯å¦å’Œé¢„æœŸä¸€è‡´

å¯¹åº”çš„å•å…ƒæµ‹è¯•æ–‡ä»¶åç¼€ä¸ºÂ `*_unittest.nc`ï¼Œé€šè¿‡Â [`nocompile.gni`](https://github.com/chromium/chromium/blob/master/build/nocompile.gni)Â åŠ å…¥å•å…ƒæµ‹è¯•å·¥ç¨‹ã€‚

### **1.2 å¯æ‹·è´æ€§æ£€æŸ¥**

C++ è¯­è¨€æœ¬èº«æœ‰å¾ˆå¤šç¼–è¯‘æ—¶æ£€æŸ¥ï¼ˆä¾‹å¦‚ ç±»çš„æˆå‘˜è®¿é—®æ§åˆ¶Â _(member access control)_ã€`const`Â å…³é”®å­— åœ¨ç¼–è¯‘æˆæ±‡ç¼–è¯­è¨€åï¼Œä¸èƒ½åç¼–è¯‘è¿˜åŸï¼‰ï¼Œä½† C++ å¯¹è±¡é»˜è®¤æ˜¯å¯æ‹·è´çš„ï¼Œä»è€Œå¸¦æ¥äº†è®¸å¤šé—®é¢˜ï¼ˆå‚è€ƒÂ [èµ„æºç®¡ç†å°è®°](http://md.aclickall.com/2018/Resource-Management.md#%E8%B5%84%E6%BA%90%E5%92%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB)ï¼‰ã€‚

å°¤å…¶æ˜¯Â **å¤šæ€**Â _(polymorphic)_Â ç±»çš„é»˜è®¤æ‹·è´è¡Œä¸ºï¼Œä¸€èˆ¬éƒ½ä¸ç¬¦åˆé¢„æœŸï¼š

- [C.67: A polymorphic class should suppress copying](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rc-copy-virtual)
- [C.130: For making deep copies of polymorphic classes prefer a virtual clone function instead of copy construction/assignment](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rh-copy)

ä¸ºæ­¤ï¼ŒChromium æä¾›äº†ä¸¤ä¸ªÂ [å¸¸ç”¨çš„å®](https://github.com/chromium/chromium/blob/master/base/macros.h)ï¼š

- `DISALLOW_COPY_AND_ASSIGN`Â ç”¨äºç¦ç”¨ç±»çš„ æ‹·è´æ„é€ å‡½æ•° å’Œ æ‹·è´èµ‹å€¼å‡½æ•°
- `DISALLOW_IMPLICIT_CONSTRUCTORS`Â ç”¨äºç¦ç”¨ç±»çš„ é»˜è®¤æ„é€ å‡½æ•° å’Œ æ‹·è´è¡Œä¸º

ç”±äº Chromium å¤§é‡ä½¿ç”¨äº† C++ çš„å¤šæ€ç‰¹æ€§ï¼Œè¿™äº›å®éšå¤„å¯è§ã€‚

### **1.3 å‚æ•°ç±»å‹æ£€æŸ¥**

Chromium è¿˜åŸºäºÂ [ç°ä»£ C++ å…ƒç¼–ç¨‹](http://md.aclickall.com/2017/Cpp-Metaprogramming.md)Â æŠ€æœ¯ï¼Œé€šè¿‡Â `static_assert`Â è¿›è¡Œé™æ€æ–­è¨€ã€‚

åœ¨ä¹‹å‰å†™çš„Â [æ·±å…¥ C++ å›è°ƒ](http://md.aclickall.com/Inside-Cpp-Callback.md)Â ä¸­åˆ†æäº†ï¼š

Chromium çš„`base::Callback <>`Â +

`base::Bind()`Â å›è°ƒæœºåˆ¶ï¼Œæåˆ°äº†ç›¸å…³çš„é™æ€æ–­è¨€æ£€æŸ¥ã€‚

`base::Bind`Â ä¸ºäº†Â [å¤„ç†å¤±æ•ˆçš„ï¼ˆå¼±å¼•ç”¨ï¼‰ä¸Šä¸‹æ–‡](http://md.aclickall.com/Inside-Cpp-Callback.md#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%A4%B1%E6%95%88%E7%9A%84%EF%BC%88%E5%BC%B1%E5%BC%95%E7%94%A8%EF%BC%89%E4%B8%8A%E4%B8%8B%E6%96%87)ï¼Œé’ˆå¯¹å¼±å¼•ç”¨æŒ‡é’ˆ[`base::WeakPtr`](https://github.com/chromium/chromium/blob/master/base/memory/weak_ptr.h)æ‰©å±•äº†`base::IsWeakReceiver`æ£€æŸ¥ï¼Œåˆ¤æ–­å¼±å¼•ç”¨çš„ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆï¼›å¹¶é€šè¿‡é™æ€æ–­è¨€æ£€æŸ¥ä¼ å…¥å‚æ•°ï¼Œ**å¼ºåˆ¶è¦æ±‚ä½¿ç”¨è€…éµå¾ª**Â å¼±å¼•ç”¨æ£€æŸ¥çš„è§„èŒƒï¼š

- `base::Bind`Â ä¸å…è®¸ç›´æ¥å°†Â **`this` æŒ‡é’ˆ**Â ç»‘å®šåˆ° ç±»çš„æˆå‘˜å‡½æ•° ä¸Šï¼Œå› ä¸ºÂ `this`Â è£¸æŒ‡é’ˆå¯èƒ½å¤±æ•ˆ å˜æˆé‡æŒ‡é’ˆ
- `base::Bind`Â ä¸å…è®¸ç»‘å®šÂ **lambda è¡¨è¾¾å¼**ï¼Œå› ä¸ºÂ `base::Bind`Â æ— æ³•æ£€æŸ¥ lambda è¡¨è¾¾å¼æ•è·çš„ å¼±å¼•ç”¨ çš„ æœ‰æ•ˆæ€§
- `base::Bind`Â åªå…è®¸å°†Â `base::WeakPtr`Â æŒ‡é’ˆç»‘å®šåˆ°Â **æ²¡æœ‰è¿”å›å€¼çš„**ï¼ˆè¿”å›Â `void`ï¼‰ç±»çš„æˆå‘˜å‡½æ•° ä¸Šï¼Œå› ä¸º å½“å¼±å¼•ç”¨å¤±æ•ˆæ—¶ä¸è°ƒç”¨å›è°ƒï¼Œä¹Ÿæ²¡æœ‰è¿”å›å€¼

`base::Callback`åŒºåˆ†[å›è°ƒåªèƒ½æ‰§è¡Œä¸€æ¬¡è¿˜æ˜¯å¯ä»¥å¤šæ¬¡](http://md.aclickall.com/Inside-Cpp-Callback.md#%E5%9B%9E%E8%B0%83%E5%8F%AA%E8%83%BD%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E8%BF%98%E6%98%AF%E5%8F%AF%E4%BB%A5%E5%A4%9A%E6%AC%A1)ï¼Œé€šè¿‡å¼•ç”¨é™å®šç¬¦Â _(reference qualifier)_Â `&&`Â /Â `const &`ï¼ŒåŒºåˆ†åœ¨å¯¹è±¡å¤„äº é const å³å€¼ / å…¶ä»–çŠ¶æ€æ—¶çš„Â `Run`Â æˆå‘˜å‡½æ•°ï¼Œåªå…è®¸ä¸€æ¬¡å›è°ƒÂ `base::OnceCallback`Â åœ¨é const å³å€¼çŠ¶æ€ä¸‹è°ƒç”¨Â `Run`Â å‡½æ•°ï¼Œä¿è¯ä¸¥è°¨çš„Â [èµ„æºç®¡ç†è¯­ä¹‰](http://md.aclickall.com/2018/Resource-Management.md#%E8%B5%84%E6%BA%90%E5%92%8C%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB)ï¼š

```
base::OnceClosureÂ cb;Â std::move(cb).Run();//Â OK
base::OnceClosureÂ cb;Â cb.Run();//Â notÂ compile
constÂ base::OnceClosureÂ cb;Â cb.Run();//Â notÂ compile
constÂ base::OnceClosureÂ cb;Â std::move(cb).Run();//Â notÂ compile

```

å¦å¤–ï¼Œé™æ€æ–­è¨€æ£€æŸ¥è¿˜å¹¿æ³›åº”ç”¨åœ¨ Chromium/base çš„**å®¹å™¨**ã€**æ™ºèƒ½æŒ‡é’ˆ**Â æ¨¡æ¿çš„å®ç°ä¸­ï¼Œç”¨äºç”Ÿæˆ[å¯è¯»æ€§æ›´å¥½çš„](http://md.aclickall.com/2017/Cpp-Metaprogramming.md#%E5%AE%9E%E4%BE%8B%E5%8C%96%E9%94%99%E8%AF%AF)**å®ä¾‹åŒ–é”™è¯¯ä¿¡æ¯**ã€‚

### **1.4 çº¿ç¨‹æ ‡è®°æ£€æŸ¥**

æœ€æ–°çš„ Chromium ä½¿ç”¨äº† Clang ç¼–è¯‘ï¼Œé€šè¿‡æ‰©å±•Â **çº¿ç¨‹æ ‡è®°**Â _(thread annotation)_ï¼Œ[é™æ€åˆ†æçº¿ç¨‹å®‰å…¨é—®é¢˜](https://clang.llvm.org/docs/ThreadSafetyAnalysis.html)ã€‚ï¼ˆå‚è€ƒï¼š[Thread Safety Annotations for Clang - DeLesley Hutchins](https://llvm.org/devmtg/2011-11/Hutchins_ThreadSafety.pdf)ï¼‰

Chromium/base çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ ï¼š

[`thread_annotations_unittest.nc`](https://github.com/chromium/chromium/blob/master/base/thread_annotations_unittest.nc)Â æè¿°äº†ä¸€äº› é”çš„é”™è¯¯ä½¿ç”¨åœºæ™¯ï¼ˆå‡è®¾æ•°æ® data è¢«é” lock ä¿æŠ¤ï¼Œå®šä¹‰æ ‡è®°ä¸º Type data GUARDED_BY(lock);ï¼‰ï¼š

- è®¿é—® data ä¹‹å‰ï¼Œå¿˜è®°è·å– lock
- è·å– lock ä¹‹åï¼Œå¿˜è®°é‡Šæ”¾ lock

è¿™äº›é”™è¯¯èƒ½åœ¨ç¼–è¯‘æ—¶è¢« Clang æ£€æŸ¥åˆ°ï¼Œä»è€Œç¼–è¯‘å¤±è´¥ã€‚

## **2 è¿è¡Œæ—¶æ£€æŸ¥**

è¿è¡Œæ—¶åŠ¨æ€æ£€æŸ¥ï¼Œä¸»è¦åŸºäº Chromium/base åº“æä¾›çš„Â **æ–­è¨€Â `DCHECK`/`CHECK`**Â å®ç° â€”â€” å¦‚æœæ–­è¨€å¤±è´¥ï¼Œè¿è¡Œç€çš„ç¨‹åºä¼šç«‹å³ç»ˆæ­¢ã€‚

å…¶ä¸­ï¼Œ`DCHECK`Â åªå¯¹è°ƒè¯•ç‰ˆÂ _(debug)_Â æœ‰æ•ˆï¼Œè€ŒÂ `CHECK`Â ä¹Ÿå¯ç”¨äºå‘å¸ƒç‰ˆÂ _(release)_Â â€”â€” ä»è€Œé¿å…åœ¨å‘å¸ƒç‰ˆè¿›è¡Œæ— ç”¨çš„æ£€æŸ¥ã€‚

### **2.1 æµ‹è¯•è®¾æ–½**

æ£€æŸ¥çš„æ–¹æ³•å¾ˆç›´è§‚ â€”â€” æ„é€ ä¸€ä¸ªæ£€æŸ¥å¤±è´¥çš„åœºæ™¯ï¼ŒæœŸæœ›æ–­è¨€å¤±è´¥ã€‚

Chromium/baseÂ åŸºç¡€è®¾æ–½ä¸­çš„`EXPECT_DCHECK_DEATH`æä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œå¯¹åº”çš„å•å…ƒæµ‹è¯•æ–‡ä»¶åç¼€ä¸ºÂ `*_unittest.cc`ã€‚

### **2.2 æ•°å€¼æº¢å‡ºæ£€æŸ¥**

C++ çš„æ•°å€¼ç±»å‹ï¼Œéƒ½æ˜¯å›ºå®šå¤§å°çš„[æ ‡é‡ç±»å‹](https://en.cppreference.com/w/cpp/language/type)Â â€”â€” å¦‚æœå­˜å‚¨æ•°å€¼è¶…å‡ºèŒƒå›´ï¼Œä¼šå¯¼è‡´**æº¢å‡º**Â _(overflow)_ã€‚

ä¾‹å¦‚ï¼Œå°è¯•é€šè¿‡Â **ä½¿ç”¨æ— ç¬¦å·æ•° é¿å…å‡ºç°è´Ÿæ•°**ï¼Œå¾€å¾€æ˜¯ä¸€ä¸ªå…¸å‹çš„å¾’åŠ³ä¹‹ä¸¾ã€‚ï¼ˆæ¯”å¦‚Â `unsigned(0) - unsigned(1) == UINT_MAX`ï¼Œå‚è€ƒÂ [ES.106: Donâ€™t try to avoid negative values by usingÂ `unsigned`](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Res-nonnegative)ï¼‰

ä¸ºæ­¤ï¼ŒChromium çš„Â [base/numerics](https://github.com/chromium/chromium/tree/master/base/numerics)Â æä¾›äº†ä¸€ä¸ª æ— ä¾èµ–Â _(dependency-free)_ã€ä»…å¤´æ–‡ä»¶Â _(header-only)_Â çš„æ¨¡æ¿åº“ï¼Œå¤„ç†æ•°å€¼æº¢å‡ºé—®é¢˜ï¼š

- `base::StrictNumeric`/`base::strict_cast&lt;&gt;()`Â **ç¼–è¯‘æ—¶ é˜»æ­¢æº¢å‡º**Â â€”â€” å¦‚æœ ç±»å‹è½¬æ¢ æœ‰æº¢å‡ºçš„å¯èƒ½æ€§ï¼Œé€šè¿‡é™æ€æ–­è¨€æŠ¥é”™
- `base::CheckedNumeric`/`base::checked_cast&lt;&gt;()`Â **è¿è¡Œæ—¶ æ£€æŸ¥æº¢å‡º**Â â€”â€” å¦‚æœ æ•°å€¼è¿ç®—/ç±»å‹è½¬æ¢ å‡ºç°æº¢å‡ºï¼Œç«‹å³ç»ˆæ­¢ç¨‹åº
- `base::ClampedNumeric`/`base::saturated_cast&lt;&gt;()`Â **è¿è¡Œæ—¶ æˆªæ–­è¿ç®—**Â â€”â€” å¦‚æœ æ•°å€¼è¿ç®—/ç±»å‹è½¬æ¢ å‡ºç°æº¢å‡ºï¼Œå¯¹è®¡ç®—ç»“æœÂ **æˆªæ–­**Â _(non-sticky saturating)_Â å¤„ç†

### **2.3 çº¿ç¨‹ç›¸å…³æ£€æŸ¥**

æœ€æ–°çš„ Chromium/base çº¿ç¨‹æ¨¡å‹å¼•å…¥äº†çº¿ç¨‹æ± ï¼Œå¹¶æ”¯æŒäº†**åºåˆ—**Â _(sequence)_Â çš„æ¦‚å¿µ â€”â€” ç›¸å¯¹äºçº¿ç¨‹æ± ä¸­çš„æ™®é€šä»»åŠ¡ä¹±åºè°ƒåº¦ï¼ŒåŒä¸€åºåˆ—çš„ä»»åŠ¡ èƒ½ä¿è¯è¢«é¡ºåºè°ƒåº¦ â€”â€” å› æ­¤ï¼Œ[æ¨èä½¿ç”¨é€»è¾‘åºåˆ— è€Œä¸æ˜¯ç‰©ç†çº¿ç¨‹](https://github.com/chromium/chromium/blob/master/docs/threading_and_tasks.md#prefer-sequences-to-physical-threads)ï¼š

- åŒä¸€ç‰©ç†çº¿ç¨‹ åªèƒ½åŒæ—¶è¿è¡Œ ä¸€ä¸ªé€»è¾‘åºåˆ—ï¼Œä½¿å¾— åºåˆ—æ¨¡å‹ ç­‰æ•ˆäº å•çº¿ç¨‹æ¨¡å‹
- åŒä¸€ç‰©ç†çº¿ç¨‹ å¯ä»¥ç”¨äºè¿è¡Œ å¤šä¸ªé€»è¾‘åºåˆ—ï¼Œæé«˜ ç‰©ç†çº¿ç¨‹ çš„åˆ©ç”¨ç‡

çº¿ç¨‹/åºåˆ— ç›¸å…³çš„æ£€æŸ¥ä¸»è¦ä¾èµ–äºÂ **çº¿ç¨‹/åºåˆ— æœ¬åœ°å­˜å‚¨**ï¼š

- æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„Â [`base::ThreadLocalStorage`](https://github.com/chromium/chromium/blob/master/base/threading/thread_local_storage.h)
    
    çº¿ç¨‹æœ¬åœ°å­˜å‚¨Â _(thread local storage, TLS)_
    
- æ¯ä¸ªåºåˆ—æœ‰ç‹¬ç«‹çš„Â [`base::SequenceLocalStorageSlot`](https://github.com/chromium/chromium/blob/master/base/threading/sequence_local_storage_slot.h)
    
    åºåˆ—æœ¬åœ°å­˜å‚¨Â _(sequence local storage, SLS)_
    
- å½“ é€»è¾‘åºåˆ— è¢«æ”¾åˆ° ç‰©ç†çº¿ç¨‹ ä¸Šæ‰§è¡Œæ—¶ï¼ŒæŠŠå½“å‰åºåˆ—çš„ SLS å…³è”åˆ° æ‰§è¡Œçº¿ç¨‹çš„ TLS
    

### **2.3.1 çº¿ç¨‹å®‰å…¨æ£€æŸ¥**

å¾ˆå¤šæ—¶å€™ï¼ŒæŸä¸ªå¯¹è±¡åªä¼šåœ¨Â **åŒä¸€çº¿ç¨‹/åºåˆ—**Â ä¸­Â **åˆ›å»º/è®¿é—®/é”€æ¯**ï¼š

- æ­£å¸¸æƒ…å†µä¸‹ï¼Œ**æ— ç«äº‰**Â _(contention-free)_Â æ¨¡å‹æ²¡å¿…è¦ä¿è¯Â **çº¿ç¨‹å®‰å…¨**Â _(thread-safety)_ï¼Œå› ä¸º çº¿ç¨‹åŒæ­¥æ“ä½œ/åŸå­æ“ä½œ ä¼šå¸¦æ¥Â **ä¸å¿…è¦çš„å¼€é”€**
- å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¸€æ—¦è¢« å¤šçº¿ç¨‹åŒæ—¶ä½¿ç”¨ï¼Œè®¿é—®å†²çªå¯¼è‡´Â **æ•°æ®ç«äº‰**Â _(data race)_ï¼Œå¯èƒ½å‡ºç° æœªå®šä¹‰è¡Œä¸º

ä¸ºæ­¤ï¼ŒChromium å€ŸåŠ©ï¼š

[`base::ThreadChecker`](https://github.com/chromium/chromium/blob/master/base/threading/thread_checker.h)/[`base::SequenceChecker`](https://github.com/chromium/chromium/blob/master/base/sequence_checker.h)

**æ£€æŸ¥å¯¹è±¡æ˜¯å¦åªåœ¨ åŒä¸€çº¿ç¨‹/åºåˆ— ä¸­ä½¿ç”¨**ï¼š

- `[THREAD|SEQUENCE]_CHECKER(checker)`Â åˆ›å»ºå¹¶å…³è” çº¿ç¨‹/åºåˆ—Â `checker`
- `DCHECK_CALLED_ON_VALID_[THREAD|SEQUENCE](<http://md.aclickall.com/checker>)`Â æ£€æŸ¥æˆ–å…³è”Â `checker`Â å’Œ å½“å‰æ‰§è¡Œç¯å¢ƒçš„ çº¿ç¨‹/åºåˆ—
- `DETACH_FROM_[THREAD|SEQUENCE](<http://md.aclickall.com/checker>)`Â è§£é™¤Â `checker`Â å’Œ çº¿ç¨‹/åºåˆ— çš„å…³è”
- å¦å¤–ï¼Œå‘å¸ƒç‰ˆçš„æ£€æŸ¥å®ç°ä¸ºÂ [ç©ºå¯¹è±¡](https://en.wikipedia.org/wiki/Null_object_pattern)ï¼Œå³æ€»èƒ½é€šè¿‡æ£€æŸ¥

å®ç°çš„Â **æ ¸å¿ƒæ€æƒ³**Â éå¸¸ç®€å•ï¼š

- çº¿ç¨‹/åºåˆ— åˆ›å»ºæ—¶ï¼Œé€šè¿‡ TLS/SLS è®°å½• å½“å‰çº¿ç¨‹/åºåˆ—çš„ IDï¼ˆä¾‹å¦‚ çº¿ç¨‹ IDã€åºåˆ— IDï¼‰
- `checker`Â æ„é€ æ—¶ï¼Œè®°å½• å½“å‰çº¿ç¨‹/åºåˆ—çš„ ID
- `checker`Â æ£€æŸ¥æ—¶ï¼Œè¯»å– å½“å‰çº¿ç¨‹/åºåˆ—çš„ IDï¼Œå’ŒÂ `checker`Â è®°å½•çš„ ID æ¯”è¾ƒ
- `checker`Â ææ„æ—¶ï¼Œå…ˆæ‰§è¡Œæ£€æŸ¥ï¼ˆå¯ä»¥æå‰ è§£é™¤å…³è”ï¼‰
- å¦å¤–ï¼Œ`checker`Â è¯»å†™ æ•°æ®æˆå‘˜æ—¶ï¼Œéœ€è¦è¿›è¡Œäº’æ–¥çš„ çº¿ç¨‹åŒæ­¥æ“ä½œï¼ˆé”ï¼‰

åœ¨[sec|é€šçŸ¥è¿­ä»£æ£€æŸ¥] æåˆ°ï¼Œ`base::ObserverList`å€ŸåŠ©Â `iteration_sequence_checker_`Â åœ¨è¿­ä»£æ—¶æ£€æŸ¥ å¯¹è±¡æ“ä½œ æ˜¯å¦çº¿ç¨‹/åºåˆ—å®‰å…¨ã€‚

### **2.3.2 çº¿ç¨‹é™åˆ¶æ£€æŸ¥**

ç¨‹åºä¸­å¸¸å¸¸ä¼šæœ‰ä¸€äº›Â **ç‰¹æ®Šç”¨é€”çš„çº¿ç¨‹**ï¼ˆä¾‹å¦‚ å®¢æˆ·ç«¯ UI ä¸»çº¿ç¨‹ï¼‰ï¼Œè€Œè¿™äº›çº¿ç¨‹å¾€å¾€æœ‰ç€Â **ç‰¹æ®Šçš„é™åˆ¶**ï¼ˆä¾‹å¦‚ï¼ŒUI çº¿ç¨‹è¦æ±‚ä¿æŒÂ **å“åº”æ€§**Â _(responsive)_ï¼Œ[å®æ—¶å“åº”ç”¨æˆ·è¾“å…¥](https://github.com/chromium/chromium/blob/master/docs/threading_and_tasks.md#keeping-the-browser-responsive)ï¼‰ã€‚

ä¸ºæ­¤ï¼ŒChromium å€ŸåŠ© ï¼š

[`base::ThreadRestrictions`](https://github.com/chromium/chromium/blob/master/base/threading/thread_restrictions.h)Â **æ£€æŸ¥å¯èƒ½æ¶‰åŠçº¿ç¨‹é™åˆ¶çš„å‡½æ•°åœ¨å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¸Šæ˜¯å¦å…è®¸**ï¼š

- é˜»å¡Â _(blocking)_Â æ“ä½œ
    - ä¸»è¦åŒ…æ‹¬æ–‡ä»¶ I/O æ“ä½œï¼ˆæœ‰å¯èƒ½è¢«ç³»ç»Ÿç¼“å­˜ï¼Œä»è€Œä¸é˜»å¡ï¼‰
    - å¯èƒ½å¯¼è‡´çº¿ç¨‹ äº¤å‡º CPU æ‰§è¡Œæœºä¼šï¼Œè¿›å…¥ wait çŠ¶æ€
- åŒæ­¥åŸè¯­Â _(sync primitive)_
    - æ‰§è¡Œ çº¿ç¨‹åŒæ­¥æ“ä½œ
    - å¯èƒ½å¯¼è‡´ç¨‹åº æ­»é”Â _(deadlock)_/å¡é¡¿Â _(jank)_
- CPU å¯†é›†å·¥ä½œÂ _(CPU intensive work)_
    - è¶…è¿‡ 100ms CPU æ—¶é—´çš„æ“ä½œ
    - å¯èƒ½å¯¼è‡´ç¨‹åº å¡é¡¿Â _(jank)_
- å•ä¾‹Â _(singleton)_Â æ“ä½œ
    - å¯¹äº éæ³„éœ²å‹Â [`base::Singleton`](https://github.com/chromium/chromium/blob/master/base/memory/singleton.h)ï¼Œä¼šåœ¨Â [`base::AtExitManager`](https://github.com/chromium/chromium/blob/master/base/at_exit.h)Â æ³¨å†Œ â€œé€€å‡ºæ—¶é”€æ¯å•ä¾‹å¯¹è±¡â€
    - å¦‚æœä¸»çº¿ç¨‹å…ˆé€€å‡ºï¼Œåœ¨Â `base::AtExitManager`Â ä¸­é”€æ¯å•ä¾‹ï¼Œå¯¼è‡´ä»åœ¨è¿è¡Œçš„ non-joinable çº¿ç¨‹å†è®¿é—®å•ä¾‹æ—¶ï¼Œå‡ºç°é‡æŒ‡é’ˆå´©æºƒ

å®ç°çš„Â **æ ¸å¿ƒæ€æƒ³**Â ä¹Ÿå¾ˆç®€å•ï¼š

- é€šè¿‡ TLS è®°å½• å½“å‰çº¿ç¨‹çš„é™åˆ¶æƒ…å†µï¼ˆæ¯ç§é™åˆ¶ç”¨ä¸€ä¸ª TLSÂ `bool`Â å­˜å‚¨ï¼‰
- å¯¹äº å¯èƒ½æ¶‰åŠé™åˆ¶çš„å‡½æ•°ï¼Œè°ƒç”¨å‰å…ˆæ£€æŸ¥ å½“å‰çº¿ç¨‹ æ˜¯å¦å…è®¸æŸä¸ªé™åˆ¶

åœ¨æœ€æ–°çš„Chromium/base ä¸­ï¼Œçº¿ç¨‹é™åˆ¶æ£€æŸ¥è¢«è¿›ä¸€æ­¥å°è£…ä¸ºï¼š

[`base::ScopedBlockingCall`](https://github.com/chromium/chromium/blob/master/base/threading/scoped_blocking_call.h)ï¼Œå¹¶åº”ç”¨äºå¤§é‡æ–‡ä»¶ I/O ç›¸å…³å‡½æ•°ä¸­ã€‚

### **2.3.3 æ­»é”æ£€æŸ¥**

Chromium é€šè¿‡Â [`base::internal::CheckedLock`](https://github.com/chromium/chromium/blob/master/base/task/common/checked_lock.h)

æ£€æŸ¥ æ­»é”Â _(deadlock)_ã€‚

å®ç°çš„Â **æ ¸å¿ƒæ€æƒ³**Â éå¸¸ç®€å• â€”â€”Â **æ£€æŸ¥ç­‰å¾…é“¾æ˜¯å¦æˆç¯**ï¼š

- ç»´æŠ¤ä¸€ä¸ª å…¨å±€çš„ <ä»æ¯ä¸ª lock åˆ°å…¶ predecessor lock> æ˜ å°„è¡¨ï¼ˆåˆ›å»ºæ—¶æ·»åŠ ï¼Œé”€æ¯æ—¶ç§»é™¤ï¼‰
- ç»´æŠ¤ä¸€ä¸ª å½“å‰çº¿ç¨‹çš„ <å·²è·å– lock> åˆ—è¡¨ï¼ˆTLS å­˜å‚¨ï¼›è·å–æ—¶è®°å½•ï¼Œé‡Šæ”¾æ—¶ç§»é™¤ï¼‰
- åˆ›å»ºæ—¶ï¼Œæ–­è¨€ predecessor å·²åˆ›å»ºï¼ˆå¦‚æœ predecessor ä¸å­˜åœ¨ï¼Œå¯èƒ½é¡ºåºé”™è¯¯ï¼‰
- è·å–æ—¶ï¼Œæ–­è¨€ predecessor æ˜¯å½“å‰çº¿ç¨‹æœ€è¿‘è·å–çš„ lockï¼ˆè‹¥ä¸æ˜¯ï¼Œå¯èƒ½é¡ºåºé”™è¯¯ï¼‰

### **2.4 è§‚å¯Ÿè€…æ¨¡å¼æ£€æŸ¥**

åœ¨ä¹‹å‰å†™çš„Â [ä»¤äººæŠ“ç‹‚çš„è§‚å¯Ÿè€…æ¨¡å¼](http://md.aclickall.com/Insane-Observer-Pattern.md)Â ä¸­ï¼Œä»‹ç»äº†å¦‚ä½•é€šè¿‡ ï¼š

Chromium/base æä¾›çš„[`base::ObserverList`](https://github.com/chromium/chromium/blob/master/base/observer_list.h)ï¼Œæ£€æŸ¥è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€äº›æ½œåœ¨é—®é¢˜ã€‚

### **2.4.1 ç”Ÿå‘½å‘¨æœŸæ£€æŸ¥**

ç”±äºè§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸå¾€å¾€æ˜¯è§£è€¦çš„ï¼Œæ‰€ä»¥æ€»ä¼šå‡ºç°ä¸€äº›é˜´å·®é˜³é”™çš„é—®é¢˜ï¼š

- [è§‚å¯Ÿè€…å…ˆé”€æ¯](http://md.aclickall.com/Insane-Observer-Pattern.md#%E9%97%AE%E9%A2%98-%E8%A7%82%E5%AF%9F%E8%80%85%E5%85%88%E9%94%80%E6%AF%81)
    
    - é—®é¢˜ï¼šè‹¥Â `base::ObserverList`Â é€šçŸ¥æ—¶ä¸æ£€æŸ¥ è§‚å¯Ÿè€…æ˜¯å¦æœ‰æ•ˆï¼Œå¯èƒ½å¯¼è‡´ é‡æŒ‡é’ˆå´©æºƒ
        
    - è§£å†³ï¼šè§‚å¯Ÿè€…ç»§æ‰¿äºÂ [`base::CheckedObserver`](https://github.com/chromium/chromium/blob/master/base/observer_list_types.h)
        
        åœ¨é€šçŸ¥å‰Â `base::ObserverList`Â æ£€æŸ¥è§‚å¯Ÿè€…å¼±å¼•ç”¨Â `base::WeakPtr`Â çš„æœ‰æ•ˆæ€§
        
- [è¢«è§‚å¯Ÿè€…å…ˆé”€æ¯](http://md.aclickall.com/Insane-Observer-Pattern.md#%E9%97%AE%E9%A2%98-%E8%A2%AB%E8%A7%82%E5%AF%9F%E8%80%85%E5%85%88%E9%94%80%E6%AF%81)
    
    - é—®é¢˜ï¼šè‹¥Â `base::ObserverList`Â é”€æ¯æ—¶ä¸æ£€æŸ¥ è§‚å¯Ÿè€…åˆ—è¡¨æ˜¯å¦ä¸ºç©ºï¼Œå¯èƒ½å¯¼è‡´ è¢«è§‚å¯Ÿè€…é”€æ¯åï¼Œè§‚å¯Ÿè€…ä¸èƒ½å†ç§»é™¤ï¼ˆé‡æŒ‡é’ˆå´©æºƒï¼‰
    - è§£å†³ï¼šæ¨¡æ¿å‚æ•°Â `check_empty`Â è‹¥ä¸ºÂ `true`ï¼Œåœ¨ææ„æ—¶æ–­è¨€ â€œè§‚å¯Ÿè€…å·²è¢«å…¨éƒ¨ç§»é™¤â€

### **2.4.2 é€šçŸ¥è¿­ä»£æ£€æŸ¥**

è§‚å¯Ÿè€…å¯èƒ½åœ¨Â `base::ObserverList`Â é€šçŸ¥æ—¶ï¼Œå†è®¿é—®åŒä¸€ä¸ªÂ `base::ObserverList`Â å¯¹è±¡ï¼š

- æ·»åŠ è§‚å¯Ÿè€…
    
    - é—®é¢˜ï¼šæ˜¯å¦éœ€è¦åœ¨ æœ¬æ¬¡è¿­ä»£ä¸­ï¼Œç»§ç»­é€šçŸ¥ æ–°åŠ å…¥çš„è§‚å¯Ÿè€…
        
    - è§£å†³ï¼šè¢«è§‚å¯Ÿè€…å‚æ•°Â [`base::ObserverListPolicy`](https://github.com/chromium/chromium/blob/master/base/observer_list.h)
        
        å†³å®šè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦é€šçŸ¥ æ–°åŠ å…¥çš„è§‚å¯Ÿè€…
        
- ç§»é™¤è§‚å¯Ÿè€…
    
    - é—®é¢˜ï¼šå¾ªç¯å†…ï¼ˆé—´æ¥ï¼‰åˆ é™¤èŠ‚ç‚¹ï¼Œå¯¼è‡´è¿­ä»£å™¨å¤±æ•ˆï¼ˆå´©æºƒï¼‰`for(auto it = c.begin(); it != c.end(); ++it) c.erase(it);`
    - è§£å†³ï¼šè§‚å¯Ÿè€…èŠ‚ç‚¹Â `MarkForRemoval()`Â æ ‡è®°ä¸º â€œå¾…ç§»é™¤â€ï¼Œç„¶åç­‰è¿­ä»£ç»“æŸåç§»é™¤
- é€šçŸ¥è¿­ä»£é‡å…¥
    
    - é—®é¢˜ï¼šè®¸å¤šæƒ…å†µä¸‹ï¼Œè‹¥ä¸è€ƒè™‘ é‡å…¥æƒ…å†µï¼Œå¯èƒ½ä¼šå¯¼è‡´Â [æ­»å¾ªç¯é—®é¢˜](http://md.aclickall.com/Insane-Observer-Pattern.md#%E9%97%AE%E9%A2%98-%E6%AD%BB%E5%BE%AA%E7%8E%AF)
    - è§£å†³ï¼šæ¨¡æ¿å‚æ•°Â `allow_reentrancy`Â è‹¥ä¸ºÂ `false`ï¼Œåœ¨è¿­ä»£æ—¶æ–­è¨€ â€œæ­£åœ¨é€šçŸ¥è¿­ä»£æ—¶ ä¸å…è®¸é‡å…¥â€
- é”€æ¯è¢«è§‚å¯Ÿè€…
    
    - é—®é¢˜ï¼šéœ€è¦ç«‹å³åœæ­¢ è¿­ä»£è¿‡ç¨‹ï¼Œè®©æ‰€æœ‰è¿­ä»£å™¨ å…¨éƒ¨å¤±æ•ˆ
        
    - è§£å†³ï¼šé€šè¿‡ç‰¹æ®Šçš„Â [`base::internal::WeakLinkNode`](https://github.com/chromium/chromium/blob/master/base/observer_list_internal.h)Â +
        
        åŒå‘é“¾è¡¨Â [`base::LinkedList`](https://github.com/chromium/chromium/blob/master/base/containers/linked_list.h)Â å­˜å‚¨Â `base::ObserverList`Â æ‰€æœ‰çš„è¿­ä»£å™¨ï¼›åœ¨Â `base::ObserverList`Â ææ„æ—¶ï¼Œå°†è¿­ä»£å™¨ æ ‡è®°ä¸ºæ— æ•ˆï¼ˆè‡ªåŠ¨åœæ­¢è¿­ä»£ï¼‰ï¼Œå¹¶ ç§»é™¤ã€é”€æ¯
        
- çº¿ç¨‹å®‰å…¨é—®é¢˜
    
    - é—®é¢˜ï¼šç”±äºÂ `base::ObserverList`Â ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨é€šçŸ¥è¿­ä»£æ—¶ï¼Œéœ€è¦ä¿è¯å…¶ä»–æ“ä½œåœ¨ åŒä¸€çº¿ç¨‹/åºåˆ—
        
    - è§£å†³ï¼šè¢«è§‚å¯Ÿè€…æˆå‘˜Â `iteration_sequence_checker_`
        
        åœ¨è¿­ä»£å¼€å§‹æ—¶å…³è”åºåˆ—ï¼Œåœ¨ç»“æŸæ—¶è§£é™¤å…³è”ï¼Œåœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ£€æŸ¥ ç§»é™¤è§‚å¯Ÿè€…/é€šçŸ¥é‡å…¥/é”€æ¯è¢«è§‚å¯Ÿè€… æ“ä½œæ˜¯å¦åºåˆ—å®‰å…¨ï¼ˆå‚è€ƒ [sec|çº¿ç¨‹å®‰å…¨æ£€æŸ¥]ï¼‰
        

å’ŒÂ [`base::Singleton`](https://github.com/chromium/chromium/blob/master/base/memory/singleton.h)Â ä¸€æ ·ï¼ŒChromium/base çš„è®¾è®¡æ¨¡å¼å®ç° å ªç§° C++ é‡Œçš„å…¸èŒƒ â€”â€” æ— è®ºæ˜¯åŠŸèƒ½ä¸Šï¼Œè¿˜æ˜¯æ€§èƒ½ä¸Šï¼Œå‡ä¸º â€œ**äººæ— æˆ‘æœ‰ï¼Œäººæœ‰æˆ‘ä¼˜**â€ã€‚

> å†™åœ¨æœ€å

> ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€‚â€”â€” è‰¾è¨å…‹Â·ç‰›é¡¿

Chromium/base åº“ä¸€ç›´åœ¨Â **è¿­ä»£ã€ä¼˜åŒ–**ï¼Œ**å­¦ä¹ ã€å€Ÿé‰´**Â è®¸å¤šå…¶ä»–ä¼˜ç§€çš„å¼€æºé¡¹ç›®ã€‚ä¾‹å¦‚ï¼Œ[sec|çº¿ç¨‹æ ‡è®°æ£€æŸ¥] ä½¿ç”¨çš„æ ‡è®°å°±æ¥æºäºÂ [`abseil`](https://github.com/abseil/abseil-cpp)ã€‚

ç”±äº Chromium/base æ”¹åŠ¨é¢‘ç¹ï¼Œæœ¬æ–‡æŸäº›ç»†èŠ‚Â **å¯èƒ½ä¼šè¿‡æœŸ**ã€‚å¦‚æœæœ‰ä»€ä¹ˆæ–°å‘ç°ï¼Œ**æ¬¢è¿è¡¥å……**~ ğŸ˜‰