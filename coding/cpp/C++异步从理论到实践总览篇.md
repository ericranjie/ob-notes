
é«˜æ€§èƒ½æ¶æ„æ¢ç´¢

Â _2022å¹´07æœˆ13æ—¥ 12:06_Â _åŒ—äº¬_

ä»¥ä¸‹æ–‡ç« æ¥æºäºè…¾è®¯æŠ€æœ¯å·¥ç¨‹Â ï¼Œä½œè€…è…¾è®¯ç¨‹åºå‘˜

[

![](http://wx.qlogo.cn/mmhead/Iic9WLWEQMg2jTKicld7jhiagcz7jJxuYcpjicxAAiaVaNpdIiabCLIxOHIZFVsWH3cRNQjLF1TBznTJc/0)

**è…¾è®¯æŠ€æœ¯å·¥ç¨‹**.

è…¾è®¯æŠ€æœ¯å®˜æ–¹å·ã€‚è…¾è®¯æŠ€æœ¯åˆ›æ–°ã€å‰æ²¿é¢†åŸŸå‘å¸ƒè§£è¯»å¹³å°ã€‚

](https://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488887&idx=1&sn=33c2894083a6f9325a7032eb44400d64&chksm=c33773b0f440faa6a41644b5c56414856a5ea615d171f4572f878b856526ed449416224e9750&mpshare=1&scene=24&srcid=0714Ed5K0SrPQFEz5dc6IhVr&sharer_sharetime=1657796539761&sharer_shareid=8397e53ca255d0bca170c6327d62b9af&key=daf9bdc5abc4e8d074fedf34c0c4970d7597b05d732850c788925d32ebfa4ad6892a66e468b82379cd3c82c486906d7f5e16361f36c1980d489ee16869a9b58949fc47f042bbdd8060140b5a933b576d9b6421f5974abdcc49470c3dbe0e8cf94de3758ca2e9da2dcec14a67867c82c4fcef215b406f338d0690079f41a55acc&ascene=0&uin=MTEwNTU1MjgwMw%3D%3D&devicetype=Windows+11+x64&version=63090b19&lang=zh_CN&countrycode=CN&exportkey=n_ChQIAhIQ6LxRU8WdiG4h10RkHJV%2FixLmAQIE97dBBAEAAAAAABM2KQH6YVkAAAAOpnltbLcz9gKNyK89dVj052ZBp4ovnxpHkbIhtcnvqCoW%2BdOnJxdpJQ%2BI8BeYfObbwpaaiAnmoLQqsvvqJbq3P%2F%2BST3v7BWB9tsegbR%2F27GMBiU3dNqClVoNQPB%2FORyBmv3c4PW0opE9%2BXFKU0sFgqqfAaAPP2RrIH01xHsRsjvV3Yx61wz7QvC0ZMraN0%2BkcQa57ZcTE8HCizbDi3lx%2FicrjwrZEfmcAMyvWYezkaYTkK4pcJhTlItTxjtr8AggfaXom%2BZNZqg7vz3vOqWEN&acctmode=0&pass_ticket=ZOcrkmBhYqaKjmM6muWqGcg83GNUJoqjwRYjzAd5rZfetOjVjuI%2FV6dXNbtDID4r&wx_header=1&fasttmpl_type=0&fasttmpl_fullversion=7350504-zh_CN-zip&fasttmpl_flag=1#)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_gif/j3gficicyOvasIjZpiaTNIPReJVWEJf7UGpmokI3LL4NbQDb8fO48fYROmYPXUhXFN8IdDqPcI1gA6OfSLsQHxB4w/640?wx_fmt=gif&wxfrom=13&tp=wxpic)

  

  

ä½œè€…ï¼šfangshenï¼Œè…¾è®¯ IEG å®¢æˆ·ç«¯å¼€å‘å·¥ç¨‹å¸ˆ

> C++20å¸¦æ¥äº†coroutineç‰¹æ€§, åŒæ—¶æ–°çš„executionä¹Ÿåœ¨ææ¡ˆè¿‡ç¨‹ä¸­, è¿™ä¸¤è€…éƒ½ç»™æˆ‘ä»¬åœ¨C++ä¸­è§£å†³å¼‚æ­¥é—®é¢˜å¸¦æ¥äº†æ–°çš„æ€è·¯. ä½†å¯¹æ¯”å…¶ä»–è¯­è¨€çš„å®ç°, C++çš„åç¨‹å’Œåç»­çš„executionéƒ½å­˜åœ¨ä¸€å®šçš„ç†è§£å’Œå°è£…æˆæœ¬, æœ¬ç³»åˆ—çš„åˆ†äº«æˆ‘ä»¬å°†å›´ç»•åŸºæœ¬çš„åŸç†, ç›¸åº”çš„å°è£…, ä»¥åŠå‰¥æä¼˜ç§€çš„ç¬¬ä¸‰æ–¹å®ç°, æœ€ç»ˆç»“åˆç¬”è€…frameworkè½åœ°çš„æƒ…å†µæ¥å±•å¼€.

### 1. çº ç»“çš„å¼€ç¯‡

ä¹‹å‰è®¾è®¡æˆ‘ä»¬æ¸¸æˆç”¨çš„c++æ¡†æ¶çš„æ—¶å€™, åˆšå¥½c++20çš„coroutineå·²ç»å‘å¸ƒ, åˆå› ä¸ºæ˜¯ä¸“é—¨ ç»™game serverç”¨çš„c++ framework, å¯¹å¤šçº¿ç¨‹çš„è¯‰æ±‚ç›¸å¯¹æœ‰é™, æˆ–è€…æœ¬ç€å°‘å¹¶å‘å°‘å¥‡æ€ªçš„é”™è¯¯çš„åŸåˆ™, é™¤ç½‘ç»œå’ŒIOå’Œæ—¥å¿—ç­‰å°‘é‡æ¨¡å—å¤–, å¤§éƒ¨åˆ†æ¨¡å—ä¸»è¦è¿˜æ˜¯å·¥ä½œåœ¨ä¸»çº¿ç¨‹ä¸Šçš„, æ‰€ä»¥å½“æ—¶è®¾è®¡çš„é‡ç‚¹ä¹Ÿå°±æ”¾åœ¨äº†c++20 coroutineçš„åŒ…è£…å’Œä½¿ç”¨ä¸Š, æ›´å¤šçš„ä½¿ç”¨coroutineæ¥å®Œå–„å¼‚æ­¥çš„æ”¯æŒ. ä½†å¦‚æœè€ƒè™‘åˆ°frameworkä½œä¸ºå‰åç«¯å…¬ç”¨æ¡†æ¶çš„è¯, åŸæ¥ä¸»è¦é’ˆå¯¹ä¸»çº¿ç¨‹ä½¿ç”¨çš„åŒ…è£…çš„coroutineè°ƒåº¦å™¨å°±æ˜¾å¾—æœ‰äº›ä¸å¤Ÿç”¨, ä»¥æ­¤ä½œä¸ºåŸºç¡€, æˆ‘ä»¬å¼€å§‹äº†å°è¯•ç»“åˆæ¯”è¾ƒæ–°çš„c++å¼‚æ­¥æ€è·¯, æ¥é‡æ–°æ€è€ƒåº”è¯¥å¦‚ä½•å®ç°ä¸€ä¸ªå°½é‡åˆ©ç”¨c++æ–°ç‰¹æ€§, ä¸šåŠ¡å±‚ç®€å•æ˜“ç”¨çš„å¼‚æ­¥æ¡†æ¶äº†.

æœ¬ç³»åˆ—çš„ä¸»è¦å†…å®¹ä¹Ÿæ˜¯å›´ç»•è¿™æ¡ä¸»çº¿æ¥é“ºå¼€, è¿‡ç¨‹ä¸­æˆ‘ä»¬ ä¸»è¦ä»¥:

1. **è‡ªæœ‰çš„frameworkå¼‚æ­¥å®ç°**Â - ä¸»è¦è½åœ°å°è¯•åˆ©ç”¨c++20çš„coroutineå®ç°ä¸€ä¸ªä¸šåŠ¡çº§çš„è°ƒåº¦å™¨.
    
2. **asio**Â - è¿™ä¸ªåº”è¯¥ä¸ç”¨å¤šè¯´äº†, è¿‘å¹´æ¥ä¸€ç›´é«˜é¢‘è¿­ä»£, ä¸šç•Œå¹¿æ³›ä½¿ç”¨çš„å¼€æºç¬¬ä¸‰æ–¹åº“, ä¸­é—´çš„å¼‚æ­¥ä»»åŠ¡è°ƒåº¦, ç½‘ç»œéƒ¨åˆ†çš„ä»£ç å®ç°éƒ½éå¸¸ä¼˜è´¨.
    
3. **libunifex**Â - æœ€æ¥è¿‘å½“å‰sender/receiverç‰ˆ executionææ¡ˆçš„å¯å®æ“ç‰ˆæœ¬, c++17/20å…¼å®¹, ä½†ä¸æ¨èä½¿ç”¨c++17çš„ç‰ˆæœ¬è¿›è¡Œä»»ä½•å°è¯•, åŸå› åç»­æ–‡ä»¶ä¼šå±•å¼€.  
    è¿™å‡ ä¸ªåº“ä½œä¸ºåŸºç¡€, é€æ­¥å±•å¼€æˆ‘ä»¬å¯¹c++å¼‚æ­¥çš„æ¢ç´¢, ç„¶åå†å›åˆ°è½åœ°å®è·µè¿™æ¡ä¸»çº¿ä¸Š, æ¢è®¨ä¸€ä¸ªä¸šåŠ¡ä¾§ä½¿ç”¨ç®€å•, å†…éƒ¨é«˜æ•ˆçš„å¼‚æ­¥åº“åº”è¯¥å¦‚ä½•æ¥å®ç°å¹¶è½åœ°. Â å½“ç„¶, æˆ‘ä»¬çš„ä¾§é‡ç‚¹ä¸»è¦è¿˜æ˜¯c++å¼‚æ­¥çš„è°ƒåº¦å’Œå¤„ç†ä¸Š, ç½‘ç»œç›¸å…³çš„æœ‰éƒ¨åˆ†å†…å®¹å¯èƒ½ä¼šç®€å•æåˆ°, ä½†ä¸ä¼šè¿›è¡Œæ·±å…¥çš„å±•å¼€. â€ƒâ€ƒå…¶å®æ•´ä¸ªå°è¯•çš„è¿‡ç¨‹åªèƒ½è¯´éå¸¸ä¸é¡ºåˆ©äº†, å½“ç„¶, éšç€å¯¹ç›¸å…³å®ç°çš„æ·±å…¥ç†è§£å’Œç»†èŠ‚çš„æ·±æŒ–, æ”¶ç›Šä¹Ÿæ˜¯é¢‡å¤šçš„. é—²è¯ä¸å¤šè¯´äº†, æˆ‘ä»¬ç›´æ¥åˆ‡å…¥ä¸»é¢˜, ä»¥å¯¹å¼‚æ­¥çš„æ€è€ƒæ¥å±•å¼€è¿™ç¯‡æ€»è§ˆçš„å†…å®¹.
    

  

### 2. å‰å°˜å¾€äº‹ - rstudio frameworkå®ç°

rstudio frameworkçš„å¼‚æ­¥æ¡†æ¶ç”±ä¸¤å—æ¯”è¾ƒç‹¬ç«‹çš„éƒ¨åˆ†ç»„æˆ:

1. ä¸€éƒ¨åˆ†æ˜¯æºè‡ªasioå‡ å¹´å‰ç‰ˆæœ¬çš„postå’Œstrandéƒ¨åˆ†å®ç°, å¦å¤–é™„åŠ äº†ä¸€äº›ä¸šåŠ¡ä¾§è¾ƒå¸¸ç”¨çš„åƒFenceç­‰å¯¹è±¡;
    
2. å¦å¤–ä¸€éƒ¨åˆ†æ˜¯ä¸»çº¿ç¨‹çš„åç¨‹è°ƒåº¦å™¨å®ç°, è¿™éƒ¨åˆ†æœ€æ—©æ˜¯åŸºäºc++17å®ç°çš„ä¸€ç‰ˆstackless åç¨‹; å¦å¤–ä¸€ç‰ˆåˆ™æ˜¯gcc11.1æ­£å¼å‘å¸ƒå, ç›´æ¥ç”¨c++20é‡æ„äº†æ•´ä¸ªå®ç°, ç›´æ¥ä½¿ç”¨c++20çš„coroutineçš„ä¸€ä¸ªç‰ˆæœ¬.
    

#### 2.1 asio éƒ¨åˆ†

â€ƒâ€ƒè¿™ä¸€éƒ¨åˆ†çš„å†…å®¹å› ä¸ºåç»­æœ‰asio schedulerå®ç°å…·ä½“çš„åˆ†æç¯‡ç« , è¿™ä¸ªåœ°æ–¹ä¸»è¦ä»¥ä¸šåŠ¡ä¾§ä½¿ç”¨è¿›è¡Œå±•å¼€äº†.

##### 2.1.1 executoræ¦‚è¿°

- æ¥æºäº1.6X booståŒæœŸçš„asio standaloneç‰ˆæœ¬
    
- å»é™¤äº†å„å¹³å°ç½‘ç»œå¤„ç†ç›¸å…³çš„ä»£ç 
    
- ä»…ä¿ç•™äº†postå’Œç›¸å…³çš„åŠŸèƒ½(æ–°ç‰ˆæœ¬æœ‰executorå®ç°)
    
- æ—©æœŸc++11å…¼å®¹, æ— coroutineæ”¯æŒ
    
- é™¤ç½‘ç»œåº“å¤–, asioéå¸¸æœ‰ä½¿ç”¨ä»·å€¼çš„ä¸€éƒ¨åˆ†ä»£ç 
    

##### 2.1.2 Â ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹

Â Â `GJobSystem->Post([]()Â {   Â Â Â Â Â Â Â Â //someÂ calculateÂ taskÂ here   Â Â Â Â Â Â Â Â //...   Â Â Â Â Â Â Â Â GJobSystem->Post(   Â Â Â Â Â Â Â Â Â Â Â Â []()Â {   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //taskÂ notifyÂ codeÂ here   Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //...   Â Â Â Â Â Â Â Â Â Â Â Â },   Â Â Â Â Â Â Â Â Â Â Â Â rstudio::JobSystemType::kLogicJob);   Â Â Â Â Â Â },Â rstudio::JobSystemType::kWorkJob);`

**ç›¸å…³çš„æ—¶åºå›¾:**

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

##### 2.1.3 Â å½“å‰æ¡†æ¶ä½¿ç”¨çš„çº¿ç¨‹ç»“æ„

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**é¢„å®šä¹‰çš„æšä¸¾å€¼:**

`enumÂ classÂ JobSystemTypeÂ :Â intÂ {   Â Â kLogicJobÂ =Â 0,Â Â Â Â Â Â Â //Â logicÂ thread(mainÂ thread)   Â Â kWorkJob,Â Â Â Â Â Â Â Â Â Â Â Â //Â workÂ thread   Â Â kSlowJob,Â Â Â Â Â Â Â Â Â Â Â Â //Â slowÂ workÂ thread(runÂ ioÂ orÂ otherÂ slowÂ job)   Â Â kNetworkJob,Â Â Â Â Â Â Â Â Â //Â addÂ aÂ separateÂ threadÂ forÂ network   Â Â kNetworkConnectJob,Â Â //Â extraÂ connectÂ threadÂ forÂ network   Â Â kLogJob,Â Â Â Â Â Â Â Â Â Â Â Â Â //Â logÂ thread   Â Â kNotifyExternalJob,Â Â //Â useÂ externalÂ processÂ toÂ reportÂ something,Â 1Â threadÂ only~~   Â Â kTotalJobTypes,   };   `

**ä¸åŒJobè¯´æ˜:**

- **kLogicJob**
    

- ä¸»çº¿ç¨‹(é€»è¾‘çº¿ç¨‹)æ‰§è¡Œä»»åŠ¡
    

- **kWorkJob**
    

- Work Threadçº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡(å¤šä¸ª), ä¸€èˆ¬æ˜¯è®¡ç®—é‡å¯æ§çš„å°ä»»åŠ¡
    

- **kSlowJob**
    

- IOä¸“ç”¨çº¿ç¨‹æ± , IOç›¸å…³çš„ä»»åŠ¡æŠ•é€’åˆ°æœ¬çº¿ç¨‹æ± 
    

- **kNetworkJob**
    

- ç›®å‰tbusppä¸“ç”¨çš„å¤„ç†çº¿ç¨‹
    

- **kNetworkConnectJob**
    

- ä¸“ç”¨çš„ç½‘ç»œè¿æ¥çº¿ç¨‹, tbusppæ¨¡å¼ä¸‹ä¸éœ€è¦
    

- **kLogJob**
    

- æ—¥å¿—ä¸“ç”¨çº¿ç¨‹, ç›®å‰æ—¥å¿—æ¨¡å—æ˜¯è‡ªå·±èµ·çš„çº¿ç¨‹, å¯ä»¥å½’å¹¶åˆ°æ­¤å¤„ç®¡ç†
    

- **kNotifyExternalJob**
    

- ä¸“ç”¨çš„é€šçŸ¥çº¿ç¨‹, å¦‚lua errorçš„ä¸ŠæŠ¥, ä½¿ç”¨è¯¥ç±»å‹
    

##### 2.1.4 Â Timerä»»åŠ¡ç›¸å…³

**ç›¸å…³æ¥å£:**

`//NoIgnoreÂ version   uint64_tÂ JobSystemModule::AddAlwaysRunJob(JobSystemTypeÂ jobType,   Â Â Â Â Â Â threads::ThreadJobFunction&&Â periodJob,Â    Â Â Â Â Â Â unsignedÂ longÂ periodTimeMs);      uint64_tÂ JobSystemModule::AddTimesRunJob(JobSystemTypeÂ jobType,Â    Â Â Â Â Â Â threads::ThreadJobFunction&&Â periodJob,Â    Â Â Â Â Â Â unsignedÂ longÂ periodTimeMs,Â    Â Â Â Â Â Â unsignedÂ intÂ runCount);   Â Â Â Â Â Â    uint64_tÂ JobSystemModule::AddDelayRunJob(JobSystemTypeÂ jobType,Â Â    Â Â Â Â Â Â threads::ThreadJobFunction&&Â periodJob,   Â Â Â Â Â Â unsignedÂ longÂ delayTimeMs);   Â Â Â Â Â Â    voidÂ JobSystemModule::KillTimerJob(uint64_tÂ tid);   `

> æœ¬éƒ¨åˆ†å¹¶æœªç›´æ¥ä½¿ç”¨asioåŸå§‹çš„basic_waitable_timerå®ç°, è€Œæ˜¯è‡ªå·±å®ç°çš„å®šæ—¶ä»»åŠ¡.

##### 2.1.5 åœ¨çº¿ç¨‹æ± ä¸Šå…³è”æ‰§è¡Œä»»åŠ¡ - Strand

- ç‰¹å®šçš„æƒ…å†µä¸‹, è¢«æ´¾å‘åˆ°Workçº¿ç¨‹æ± çš„ä»»åŠ¡å­˜åœ¨ä¾èµ–å…³ç³»
    
- éœ€è¦ä¸²è”æ‰§è¡Œçš„æ—¶å€™, è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦é¢å¤–çš„è®¾æ–½ JobStrand
    
- æ¥ä¿è¯ä»»åŠ¡æ˜¯æŒ‰å…ˆåä¾èµ–å…³ç³»æ¥ä¸²è¡Œæ‰§è¡Œçš„
    
- å¦‚ä¸‹å›¾ä¸­part1, part2, part3, part4ä¸²è¡Œæ‰§è¡Œçš„æƒ…å†µæ‰€ç¤º
    

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**ç¤ºä¾‹ä»£ç :**

`autoÂ strandÂ =Â GJobSystem->RequestStrand(rstudio::JobSystemType::kWorkJob);   starnd.Post([](){Â    Â Â Â Â //part1~   Â Â Â Â //Â ...   });   starnd.Post([](){Â    Â Â Â Â //part2~   Â Â Â Â //Â ...   });   starnd.Post([](){Â    Â Â Â Â //part3~Â    Â Â Â Â //Â ...   });   starnd.Post([](){Â    Â Â Â Â //part4~Â    Â Â Â Â //Â ...   });   starnd.Post([](){Â    Â Â Â Â GJobSystem->Post([](){   Â Â Â Â Â Â Â Â //returnÂ codeÂ here   Â Â Â Â Â Â Â Â //Â ...   Â Â Â Â },Â rstudio::JobSystemType::kLogicJob);Â    });   `

##### 2.1.6 å…¶ä»–è¾…åŠ©è®¾æ–½

###### JobFence

`jobs::JobFencePtrÂ JobSystemModule::RequestFence();   `

- å­—é¢ä¹‰, æ …æ , èµ·åˆ°æ‹¦æˆªæ‰§è¡Œçš„ä½œç”¨.
    
- ä¸€èˆ¬å¤šç”¨äºæ¨¡å—çš„åˆå§‹åŒ–å’Œç»“æŸ
    
- å¦‚tbusppåœ¨kNetworkJobä¸Šçš„åˆå§‹åŒ–å’Œç»“æŸ.
    

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**ç¤ºä¾‹ä»£ç (TcpServiceçš„åˆå§‹åŒ–)**:

`job_system_module_->Post(   Â Â Â Â [this,Â workTicket]()Â {   Â Â Â Â Â Â Â Â ifÂ (!workTicketÂ ||Â workTicket->IsExpired())Â return;      Â Â Â Â Â Â Â Â InitInNetworkThread();   Â Â Â Â },   Â Â Â Â JobSystemType::kNetworkJob);      period_task_ptrÂ =Â job_system_module_->AddAlwaysRunJob(   Â Â Â Â JobSystemType::kNetworkJob,   Â Â Â Â [this,Â workTicket]()Â {   Â Â Â Â Â Â Â Â ifÂ (!workTicketÂ ||Â workTicket->IsExpired())Â return;      Â Â Â Â Â Â Â Â LoopInNetworkThread();   Â Â Â Â },   Â Â Â Â 10);      fence_->FenceTo((int)JobSystemType::kNetworkJob);   fence_->Wait();   `

###### JobNotify && JobWaiter

`jobs::JobWaiterPtrÂ JobSystemModule::RequestWaiter();   jobs::JobNotifyPtrÂ JobSystemModule::RequestNotify();   `

- æ‰¹é‡ä»»åŠ¡ç®¡ç†ä½¿ç”¨
    
- ç­‰å¾…çš„æ–¹å¼çš„åŒºåˆ«
    

- **JobNotify**: æ‰§è¡Œå®Œæˆè°ƒç”¨é¢å¤–æŒ‡å®šçš„å›è°ƒ.
    
- **JobWaiter**: ä»¥Waitçš„æ–¹å¼åœ¨ç‰¹å®šçº¿ç¨‹ç­‰å¾…æ‰€æœ‰Jobæ‰§è¡Œå®Œæˆ.
    

###### JobTicket

`jobs::JobTicketPtrÂ JobSystemModule::RequestTicket();   `

- ä»¤ç‰Œå¯¹è±¡
    
- ä¸€èˆ¬ç”¨æ¥å¤„ç†è·¨çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
    
- å›è°ƒä¹‹å‰å…ˆé€šè¿‡IsExpired()æ¥åˆ¤æ–­å¯¹åº”å¯¹è±¡æ˜¯å¦å·²ç»é‡Šæ”¾
    

ç¤ºä¾‹ä»£ç :

`GJobSystem->Post(   Â Â [this,Â workTicket]()Â {   Â ifÂ (!workTicketÂ ||Â workTicket->IsExpired())Â return;      Â InitInNetworkThread();   Â Â },   Â Â JobSystemType::kNetworkJob);   `

#### 2.2 asio ä¸å…¶ä»–å®ç°çš„å¯¹æ¯”

â€ƒâ€ƒæ­£å¥½ä»Šå¹´çš„GDCä¸Šæœ‰ä¸€ä¸ª<<One Frame In Halo Infinite>>çš„åˆ†äº«, é‡Œé¢ä¸»è¦è®²è¿°çš„æ˜¯å¯¹Halo Infiniteçš„å¼•æ“å‡çº§, æä¾›æ–°çš„JobSystemå’Œæ–°çš„åŠ¨æ€å¸§çš„æœºåˆ¶æ¥æ”¯æ’‘é¡¹ç›®çš„, æˆ‘ä»¬ç›´æ¥ä»¥å®ƒä¸ºä¾‹å­æ¥å¯¹æ¯”ä¸€ä¸‹frameworkå’ŒHaloçš„å®ç°, å¹¶ä¸”ä¹Ÿå€Ÿç”¨Halo Infiniteçš„ä¾‹å­, æ¥æ›´å¥½çš„äº†è§£è¿™ç§lambda postæ¨¡å¼çš„ç¼ºé™·, ä»¥åŠå¯ä»¥æ”¹è¿›çš„ç‚¹. â€ƒâ€ƒHaloå¼•å…¥æ–°çš„JobSystemä¸»è¦æ˜¯ä¸ºäº†å°†è€çš„Tetrisç»“æ„çš„å¹¶å‘æ¨¡å¼:

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å‘æ–°çš„åŸºäºDependencyçš„å›¾çŠ¶ç»“æ„è¿ç§»:![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ä»–ä½¿ç”¨çš„JobSystemçš„ä¸šåŠ¡Apiå…¶å®å¾ˆç®€å•, æˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„ä»£ç :

`JobSystem&Â jobSsytemÂ =Â JobSystem::Get();   JobGraphHandleÂ graphHandleÂ =Â jobSystem.CreateJobGraph();      JobHandleÂ jobAÂ =Â jobSystem.AddJob(Â    Â graphHandle,Â    Â "JobA",   Â [](){...}Â );      JobHandleÂ jobBÂ =Â jobSystem.AddJob(   Â graphHandle,   Â "JobB",   Â [](){...}Â );      jobSystem.AddJobToJobDependency(jobA,Â jobB);      jobSystem.SubmitJobGraph(graphHandle);   `

é€šè¿‡è¿™æ ·çš„æœºåˆ¶, å°±å¾ˆå®¹æ˜“å½¢æˆå¦‚:![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å¦å¤–è¿˜æœ‰ä¸€ä¸ªç”¨äºåŒæ­¥çš„SyncPoint:

`JobSystem&Â jobSystemÂ =Â JobSystem::Get();   JobGraphHandleÂ graphHandleÂ =Â jobSystem.CreateJobGraph();      SyncPointHandleÂ syncPointXÂ =Â jobSystem.CreateSyncPoint(graphHandle,Â "SyncPointX");      JobHandleÂ jobAÂ =Â jobSystem.AddJob(graphHandle,Â "JobA",Â [](){...});   JobHandleÂ jobBÂ =Â jobSystem.AddJob(graphHandle,Â "JobB",Â [](){...});      jobSystem.AddJobToSyncPointDependency(jobA,Â syncPointX);   jobSystem.AddSyncPointToJobDependency(syncPointX,Â jobB);      jobSystem.SubmitJobGraph(graphHandle);   `

å¤§è‡´çš„ä½œç”¨å¦‚ä¸‹:

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

è¿™æ ·åœ¨workloadä¸»åŠ¨è§¦å‘SyncPointå, æ•´ä½“æ‰§è¡Œæ‰ä¼šç»§ç»­å¾€ä¸‹æ¨è¿›, è¿™æ ·å°±èƒ½æ–¹ä¾¿çš„åŠ å…¥ä¸€äº›ä¸»åŠ¨çš„åŒæ­¥ç‚¹å¯¹æ•´ä¸ªGraphçš„æ‰§è¡Œåšç›¸å…³çš„æ§åˆ¶äº†ã€‚

å›åˆ°asio, æˆ‘ä»¬å‰é¢ä¹Ÿä»‹ç»äº†, ä½¿ç”¨strandå’Œpost(), æˆ‘ä»¬ä¹Ÿèƒ½å¾ˆæ–¹ä¾¿çš„æ„é€ å‡ºGraphå½¢çš„æ‰§è¡Œæƒ…å†µ , è€ŒSyncPointå…¶å®ç±»å‹frameworkä¸­æä¾›çš„Event, è¡¨è¾¾ä¸Šä¼šç•¥æœ‰å·®å¼‚, ä½†å¾ˆå®¹æ˜“çœ‹å‡ºä¸¤å¥—å®ç°å…¶å®æ˜¯ç›¸å½“ç±»åŒçš„. è¿™æ ·çš„è¯, Halo çš„JobSystemæœ‰çš„æ‰€æœ‰ä¼˜ç¼ºç‚¹, frameworkåŸºæœ¬ä¹ŸåŒæ ·å­˜åœ¨äº†, è¿™é‡Œç®€å•æ¬è¿ä¸€ä¸‹:

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å¯¹äºå¤æ‚å¹¶å‘ä¸šåŠ¡çš„è¡¨è¾¾ä»¥lambdaå†…åµŒä¸ºä¸», è™½ç„¶è¿™ç§æ–¹å¼å°½å¯èƒ½ä¿è¯æ‰€æœ‰ä»£ç ä¸Šä¸‹æ–‡æ˜¯æ¯”è¾ƒé›†ä¸­çš„, å¯¹æ¯”çº¯ç²¹ä½¿ç”¨callbackçš„æ¨¡å¼æœ‰æ‰€è¿›æ­¥, ä½†è¿™ç§è‡ªç”±åº¦è¿‡é«˜çš„æ–¹å¼æœ¬èº«ä¹Ÿä¼šå­˜åœ¨ä¸€äº›é—®é¢˜, çº¯ç²¹é ç¼–ç è€…æ¥ç»´ç³»å¹¶å‘ä¸Šä¸‹æ–‡çš„æ­£ç¡®æ€§, Â è¿™ç§æƒ…å†µä¸‹çŠ¶æ€å€¼åœ¨lambdaä¹‹é—´çš„ä¼ é€’ä¹Ÿéœ€è¦ç‰¹åˆ«çš„å°å¿ƒ, Â å®¹æ˜“å‡ºé”™, å¹¶ä¸”éš¾ä»¥è°ƒè¯•ã€‚

#### 2.3 coroutineå®ç°éƒ¨åˆ†

coroutineéƒ¨åˆ†ä¹‹å‰çš„å¸–å­é‡Œå·²ç»å†™å¾—æ¯”è¾ƒè¯¦ç»†äº†, è¿™é‡Œä»…ç»™å‡ºé“¾æ¥ä»¥åŠç®€å•çš„ä»£ç ç¤ºä¾‹:

1. å¦‚ä½•åœ¨C++17ä¸­å®ç°stackless coroutineä»¥åŠç›¸å…³çš„ä»»åŠ¡è°ƒåº¦å™¨
    
2. C++20 Coroutineå®ä¾‹æ•™å­¦
    
3. å¦å¤–è¿˜æœ‰ä¸€ä¸ªpurecppå¤§ä¼šçš„æ¼”è®²è§†é¢‘, Â ä¸»è¦å†…å®¹ä¸ä¸Šè¿°çš„ä¸¤ç¯‡æ–‡ç« ç›¸å…³åº¦æ¯”è¾ƒé«˜, è¿™é‡Œä¹Ÿç»™å‡ºç›¸å…³çš„é“¾æ¥, æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œè§‚çœ‹:C++20 coroutineåŸç†ä¸åº”ç”¨
    

**ä»£ç ç¤ºä¾‹:**

`//C++Â 20Â coroutine   autoÂ clientProxyÂ =Â mRpcClient->CreateServiceProxy("mmo.HeartBeat");   mScheduler.CreateTask20([clientProxy]()Â    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ->Â rstudio::logic::CoResumingTaskCpp20Â {   Â Â Â Â auto*Â taskÂ =Â rco_self_task();      Â Â Â Â printf("step1:Â taskÂ isÂ %llu\n",Â task->GetId());   Â Â Â Â co_awaitÂ rstudio::logic::cotasks::NextFrame{};   Â Â Â Â    Â Â Â Â printf("step2Â afterÂ yield!\n");   Â Â Â Â intÂ cÂ =Â 0;   Â Â Â Â whileÂ (cÂ <Â 5)Â {   Â Â Â Â Â Â Â Â printf("inÂ whileÂ loopÂ c=%d\n",Â c);   Â Â Â Â Â Â Â Â co_awaitÂ rstudio::logic::cotasks::Sleep(1000);   Â Â Â Â Â Â Â Â c++;   Â Â Â Â }   Â Â Â Â forÂ (cÂ =Â 0;Â cÂ <Â 5;Â c++)Â {   Â Â Â Â Â Â Â Â printf("inÂ forÂ loopÂ c=%d\n",Â c);   Â Â Â Â Â Â Â Â co_awaitÂ rstudio::logic::cotasks::NextFrame{};   Â Â Â Â }      Â Â Â Â printf("step3Â %d\n",Â c);   Â Â Â Â autoÂ newTaskIdÂ =Â co_awaitÂ rstudio::logic::cotasks::CreateTask(false,Â    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â []()->Â logic::CoResumingTaskCpp20Â {   Â Â Â Â Â Â Â Â printf("fromÂ childÂ coroutine!\n");   Â Â Â Â Â Â Â Â co_awaitÂ rstudio::logic::cotasks::Sleep(2000);   Â Â Â Â Â Â Â Â printf("afterÂ childÂ coroutineÂ sleep\n");   Â Â Â Â });   Â Â Â Â printf("newÂ taskÂ createÂ inÂ coroutine:Â %llu\n",Â newTaskId);   Â Â Â Â printf("BeginÂ waitÂ forÂ task!\n");   Â Â Â Â co_awaitÂ rstudio::logic::cotasks::WaitTaskFinish{Â newTaskId,Â 10000Â };   Â Â Â Â printf("AfterÂ waitÂ forÂ task!\n");      Â Â Â Â rstudio::logic::cotasks::RpcRequestÂ    Â Â Â Â Â Â Â Â rpcReq{clientProxy,Â "DoHeartBeat",Â rstudio::reflection::Args{Â 3Â },Â 5000};   Â Â Â Â auto*Â rpcretÂ =Â co_awaitÂ rpcReq;   Â Â Â Â ifÂ (rpcret->rpcResultTypeÂ ==Â rstudio::network::RpcResponseResultType::RequestSuc)Â {   Â Â Â Â Â Â Â Â assert(rpcret->totalRetÂ ==Â 1);   Â Â Â Â Â Â Â Â autoÂ retvalÂ =Â rpcret->retValue.to<int>();   Â Â Â Â Â Â Â Â assert(retvalÂ ==Â 4);   Â Â Â Â Â Â Â Â printf("rpcÂ coroutineÂ runÂ suc,Â valÂ =Â %d!\n",Â retval);   Â Â Â Â }   Â Â Â Â elseÂ {   Â Â Â Â Â Â Â Â printf("rpcÂ coroutineÂ runÂ failed!Â resultÂ =Â %dÂ \n",Â (int)rpcret->rpcResultType);   Â Â Â Â }   Â Â Â Â co_awaitÂ rstudio::logic::cotasks::Sleep(5000);   Â Â Â Â printf("step4,Â afterÂ 5sÂ sleep\n");   Â Â Â Â co_returnÂ rstudio::logic::CoNil;   }Â );   `

**æ‰§è¡Œç»“æœ:**

`step1:Â taskÂ isÂ 1   step2Â afterÂ yield!   inÂ whileÂ loopÂ c=0   inÂ whileÂ loopÂ c=1   inÂ whileÂ loopÂ c=2   inÂ whileÂ loopÂ c=3   inÂ whileÂ loopÂ c=4   inÂ forÂ loopÂ c=0   inÂ forÂ loopÂ c=1   inÂ forÂ loopÂ c=2   inÂ forÂ loopÂ c=3   inÂ forÂ loopÂ c=4   step3Â 5   newÂ taskÂ createÂ inÂ coroutine:Â 2   BeginÂ waitÂ forÂ task!   fromÂ childÂ coroutine!   afterÂ childÂ coroutineÂ sleep   AfterÂ waitÂ forÂ task!   serviceÂ yieldÂ callÂ finish!   rpcÂ coroutineÂ runÂ suc,Â valÂ =Â 4!   step4,Â afterÂ 5sÂ sleep   `

æ•´ä½“æ¥çœ‹, åç¨‹çš„ä½¿ç”¨è¿˜æ˜¯ç»™å¼‚æ­¥ç¼–ç¨‹å¸¦æ¥äº†å¾ˆå¤šä¾¿åˆ©, ä½†æ¡†æ¶æœ¬èº«çš„å®ç°å…¶å®è¿˜æ˜¯æœ‰æ¯”è¾ƒå¤šè¿­ä»£ä¼˜åŒ–çš„ç©ºé—´çš„:

1. asioçš„è°ƒåº¦éƒ¨åˆ†ä¸coroutineéƒ¨åˆ†çš„å®ç°æ˜¯åˆ†ç¦»çš„
    
2. coroutineæš‚æ—¶åªæ”¯æŒä¸»çº¿ç¨‹
    

#### 2.4 å°ç»“

ä¸Šé¢ä¹Ÿç»“åˆhaloçš„å®ä¾‹è¯´åˆ°äº†ä¸€äº›é™åˆ¶, é‚£ä¹ˆè¿™äº›é—®é¢˜æœ‰æ²¡æœ‰å¥½çš„è§£å†³åŠæ³•äº†, ç­”æ¡ˆæ˜¯è‚¯å®šçš„, è™½ç„¶executionå¹¶æœªå®Œå…¨é€šè¿‡ææ¡ˆ, ä½†æ•´ä½“è€Œè¨€, executionæ–°çš„sender/recieveræ¨¡å‹, å¯¹äºè§£å†³ä¸Šé¢æåˆ°çš„ä¸€äº›ç¼ºé™·, åº”è¯¥æ˜¯æä¾›äº†éå¸¸å¥½çš„æ€è·¯, æˆ‘ä»¬ä¸‹ä¸€ç« èŠ‚ä¸­ç»§ç»­å±•å¼€.

  

### 3. so easy - executionå°±æ˜¯è§£?

æœ€å¼€å§‹çš„æƒ³æ³•å…¶å®æ¯”è¾ƒç®€å•, ç»“åˆåŸæ¥çš„framework, é€‚å½“å¼•å…¥ææ¡ˆä¸­çš„executionä¸€äº›æ¯”è¾ƒå¯å–çš„æ€è·¯, è®©frameworkçš„å¼‚æ­¥ç¼–ç¨‹èƒ½æ›´å¤šçš„å¸å–c++æ–°ç‰¹æ€§å’Œexecutionæ¯”è¾ƒé«˜çº§çš„æ¡†æ¶æŠ½è±¡èƒ½åŠ›, æå‡æ•´ä¸ªå¼‚æ­¥åº“çš„å®ç°è´¨é‡. æ‰€ä»¥æœ€å¼€å§‹å®šçš„ä¸»çº¿æ€è·¯å…¶å®æ˜¯æ›´å¤šçš„å‘executionå€¾æ–œ, æ€ä¹ˆäº†è§£æŒæ¡execution, æ€ä¹ˆä¸ç°åœ¨çš„frameworkç»“åˆæˆäº†ä¸»çº¿æ€è·¯.

æˆ‘ä»¬é€‰æ‹©çš„åŸºç¡€å‚è€ƒåº“æ˜¯æ¥è‡ªå†²å…ƒå®‡å®™è¿™æ³¢æ”¹åçš„Metaå…¬å¸çš„libunifex, å®¢è§‚æ¥è¯´, Metaå…¬å¸çš„follyåº“, ä»¥åŠlibunifexåº“çš„å®ç°è´¨é‡, è‚¯å®šéƒ½æ˜¯ä¸šç•Œå‰æ²¿çš„, å¯¹c++æ–°ç‰¹æ€§çš„ä½¿ç”¨å’Œæ¢ç´¢, ä¹Ÿæ˜¯ç›¸å½“ç»™åŠ›çš„. è¿™äº›æˆ‘ä»¬åç»­åœ¨åˆ†ælibunifexå…·ä½“å®ç°çš„ç¯‡ç« ä¸­ä¹Ÿèƒ½å®é™…æ„Ÿå—åˆ°.

ä½†æ·±å…¥äº†è§£libunifexå, æˆ‘ä»¬ä¼šå‘ç°, å®ƒçš„ä¼˜ç‚¹æœ‰ä¸å°‘:

1. å°è¯•ä¸ºc++æä¾›è¡¨è¾¾å¼‚æ­¥çš„æ¡†æ¶æ€§ç»“æ„.
    
2. æ³›å‹ç”¨å¾—å‡ºç¥å…¥åŒ–, ponderåœ¨å®ƒå‰é¢åŸºæœ¬æ˜¯å°å¼Ÿçº§åˆ«çš„, ä¸€ç³»åˆ—æ³›ç”¨æ€§ç‰¹åˆ«å¼ºçš„template ç¼–ç¨‹ç¤ºä¾‹, æ¯”å¦‚éšå«åœ¨sender/receiveræ€è·¯å†…çš„lazy evaluateè¡¨è¾¾, å¦‚ä½•åœ¨å¤§é‡ä½¿ç”¨æ³›å‹çš„æƒ…å†µä¸‹æä¾›ä¸šåŠ¡å®šåˆ¶ç‚¹ç­‰ç­‰.
    
3. ç»“æ„åŒ–çš„è¡¨è¾¾å¹¶å‘å’Œå¼‚æ­¥, ç›¸å…³ä»£ç çš„ç¼–å†™ä»è‡ªç”±å‘æŒ¥è‡ªä¸»æŠŠæ§èµ°å‘æ¡†æ¶åŒ–, çº¦æŸåŒ–, èƒ½å¤Ÿæ›´æœ‰åºæ›´å¯é çš„è¡¨è¾¾å¤æ‚å¼‚æ­¥é€»è¾‘
    
4. æ•´ä¸ªæ‰§è¡Œpipelineçš„ç»„ç»‡, æ‰€æœ‰ä¿¡æ¯æ˜¯compile timeå’Œruntimeå®Œå¤‡çš„, dependenciesä¸ä¼šä¸¢å¤±.
    
5. èŠ‚ç‚¹ä¹‹é—´çš„å€¼ç±»å‹æ˜¯å¼ºåˆ¶æ£€æŸ¥çš„, æœ‰é—®é¢˜çš„æƒ…å†µ , å¤§å¤šæ—¶å€™compiler timeå°±ä¼šæŠ¥é”™. æœ‰ä¸å°‘ä¼˜ç‚¹çš„åŒæ—¶, ä¹Ÿæœ‰å¾ˆå¤šç¼ºç‚¹:
    
6. æ•´ä¸ªåº“çš„å®ç°ä¸¥é‡ä¾èµ–äº†c++20 rangesé‡‡ç”¨çš„ä¸€ç§å®šåˆ¶æ‰‹æ®µ cpo, å¹¶ä¸”ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼rangesçš„pipeè¡¨è¾¾æ–¹æ³•, ç†è§£ç›¸å…³ä»£ç å­˜åœ¨ä¸€å®šçš„é—¨å.(åç»­ä¼šæœ‰å…·ä½“çš„ç¯‡ç« å±•å¼€ç›¸å…³çš„å†…å®¹)
    
7. åº“åŒæ—¶å‘ä¸‹å…¼å®¹äº†c++17, ä½†ç”±äºc++17æœ¬èº«ç‰¹æ€§çš„é™åˆ¶, å¼•å…¥äº†å¤§é‡çš„å®, ä»¥åŠX Macroså±•å¼€çš„æ–¹å¼, å¯¼è‡´ç›¸å…³çš„ä»£ç é˜…è¯»éš¾åº¦è¿›ä¸€æ­¥æå‡. ä½†å®é™…ä¸Šc++17ç‰ˆæœ¬å¹¶ä¸å…·å¤‡å¯ç»´æŠ¤çš„ä»·å€¼, ä¾èµ–SIFINAEçš„å®ç°, å¦‚æœä¸­é—´ä»»ä½•ä¸€ç¯æŠ¥é”™, å¿…ç„¶éœ€è¦åœ¨Nå±çš„æŠ¥é”™ä¸­å¯»æ‰¾æœ‰æ•ˆä¿¡æ¯.
    
8. libunifexå¯¹coroutineçš„æ”¯æŒå­˜ç–‘, è™½ç„¶è®©coroutineå¯ä»¥ä½œä¸ºä¸€ç§recieverå­˜åœ¨, ä½†æœ¬è´¨ä¸Šæ¥è¯´, coroutineå…¶å®æ›´é€‚åˆæ‹¿æ¥åšæµç¨‹æ§åˆ¶çš„èƒ¶æ°´, è€Œä¸æ˜¯ä½œä¸ºå¼‚æ­¥ä¸­çš„æŸä¸ªèŠ‚ç‚¹å­˜åœ¨.
    
9. é»˜è®¤çš„schedulerå®ç°è´¨é‡ç¦»å·¥ä¸šçº§è¿˜å­˜åœ¨ä¸€å®šçš„è·ç¦», è¿™ä¸€ç‚¹åç»­çš„ä»£ç åˆ†æä¸­ä¹Ÿä¼šå…·ä½“æåˆ°. è¯¸å¤šé—®é¢˜çš„å­˜åœ¨, å¯èƒ½ä¹Ÿæ˜¯executionææ¡ˆæ²¡æœ‰çŸ­æ—¶é—´å†…è·å¾—é€šè¿‡çš„åŸå› å§, ä½†æ•´ä½“æ¥è¯´, executionæœ¬èº«çš„ç†å¿µè¿˜æ˜¯å¾ˆæœ‰å‚è€ƒä»·å€¼çš„, ä½†ä»¥å®ƒçš„ç°çŠ¶æ¥è¯´, ç¦»æœ€ç»ˆçš„è§£è‚¯å®šè¿˜æ˜¯æœ‰æ¯”è¾ƒå¤§çš„è·ç¦»çš„.
    

  

### 4. å°è¯•é‡æ–°æ€è€ƒ - è¦ä»€ä¹ˆ, ç”¨ä»€ä¹ˆ

äº‹æƒ…åˆ°è¿™ä¸ªç‚¹å°±æœ‰ç‚¹å°´å°¬äº†, åŸæœ‰çš„asio, æ¶æ„å±‚é¢æ¥è¯´, è·Ÿæ–°çš„executionæ˜¯å­˜åœ¨è½å·®çš„. è€Œé¡¹ç›®å®è·µä¸Šæ¥è¯´, asioç›¸å½“ç¨³æ‰ç¨³æ‰“, è€Œä»¥libunifexå½“å‰çš„çŠ¶æ€æ¥è¯´, ç¦»å·¥ä¸šåŒ–ä½¿ç”¨å…¶å®æ˜¯æœ‰ä¸€å®šè·ç¦»çš„. ä½†asioä½œè€…åœ¨21å¹´æ—¶å€™çš„ä¸¤ç¯‡æ¼”è®²(æ›´åƒcoding show):

1. Talking Async Ep1: Why C++20 is the Awesomest Language for Network Programming
    
2. Talking Async Ep2: Cancellation in depthç¬¬ä¸€ç¯‡åŸºæœ¬æ•´ä¸ªæ¼”ç¤ºäº†asioä»æœ€å¼€å§‹çš„callback, åˆ°èå…¥c++20 coroutineåçš„ä¼˜é›…å¼‚æ­¥è¡¨è¾¾, æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ç‰‡æ–­æ„Ÿå—ä¸€ä¸‹:
    

#### asioç›¸å…³ç¤ºä¾‹ä»£ç 1

`awaitable<void>Â listen(tcp::acceptor&Â acceptor,Â tcp::endpointÂ target)   {   Â Â forÂ (;;)   Â Â {   Â Â Â Â autoÂ [e,Â client]Â =Â co_awaitÂ acceptor.async_accept(use_nothrow_awaitable);   Â Â Â Â ifÂ (e)   Â Â Â Â Â Â break;      Â Â Â Â autoÂ exÂ =Â client.get_executor();   Â Â Â Â co_spawn(ex,Â proxy(std::move(client),Â target),Â detached);   Â Â }   }   `

#### asioç›¸å…³ç¤ºä¾‹ä»£ç 2

Â Â `autoÂ [e]Â =Â co_awaitÂ server.async_connect(target,Â use_nothrow_awaitable);   Â Â ifÂ (!e)   Â Â {   Â Â Â Â co_awaitÂ (   Â Â Â Â Â Â Â Â (   Â Â Â Â Â Â Â Â Â Â transfer(client,Â server,Â client_to_server_deadline)Â ||   Â Â Â Â Â Â Â Â Â Â watchdog(client_to_server_deadline)   Â Â Â Â Â Â Â Â )   Â Â Â Â Â Â Â Â &&   Â Â Â Â Â Â Â Â (   Â Â Â Â Â Â Â Â Â Â transfer(server,Â client,Â server_to_client_deadline)Â ||   Â Â Â Â Â Â Â Â Â Â watchdog(server_to_client_deadline)   Â Â Â Â Â Â Â Â )   Â Â Â Â Â Â );   Â Â }`

å¯¹æ¯”åŸæ¥æ¯ä¸ªasync_xxx()å‡½æ•°åæ¥callbackçš„æ¨¡å¼, æ•´ä¸ªå®ç°å¯ä»¥è¯´æ˜¯ç›¸å½“çš„ä¼˜é›…äº†, ä»£ç çš„å¯è¯»æ€§ä¹Ÿå¾—åˆ°äº†æå¤§çš„æé«˜, è¿™ä¸¤æ®µä»£ç éƒ½æ¥è‡ªäºä¸Šé¢çš„æ¼”è®²ä¸­, æƒ³æ·±å…¥äº†è§£çš„å¯ä»¥ç›´æ¥æ‰“å¼€ç›¸å…³çš„é“¾æ¥è§‚çœ‹è§†é¢‘, å¾ˆæ¨èå¤§å®¶å»çœ‹ä¸€ä¸‹. â€ƒâ€ƒèƒ½å¤ŸæŠŠå¤æ‚çš„äº‹æƒ…ç”¨æ›´ç®€æ´æ˜“æ‡‚çš„æ–¹æ³•è¡¨è¾¾, è¿™è‚¯å®šæ˜¯è®©äººæŒ¯å¥‹çš„, å½“ç„¶, æ·±å…¥äº†è§£ç›¸å…³å®ç°å, ä¹Ÿä¼šå‘ç°å­˜åœ¨ä¸€äº›é—®é¢˜, ä½†æˆ‘ä»¬çš„æœ¬æ„æ˜¯å‚è€ƒå­¦ä¹ , å¾—å‡ºæœ€ç»ˆæƒ³è¦çš„å¯ä»¥æ¯”è¾ƒå¥½çš„æ”¯æ’‘å¹¶å‘å’Œå¼‚æ­¥ä¸šåŠ¡çš„åŸºç¡€æ¡†æ¶, æœ‰è¿™äº›, å…¶å®å·²ç»å¯ä»¥ç†å‡ºä¸€æ¡æ¯”è¾ƒæ¸…æ™°çš„æ€è·¯äº†:

1. executionéƒ¨åˆ†ä¸»è¦ä½¿ç”¨å®ƒçš„sender/receiveræ¦‚å¿µ, å’Œå®ƒæä¾›çš„ä¸€äº›é€šç”¨çš„ç®—æ³•. ç§»é™¤æ‰æ‰€æœ‰å› ä¸ºfallback c++17å¼•å…¥çš„å¤§é‡ä»£ç å™ªå£°. æŠ›å¼ƒå®ƒå¹¶ä¸å®Œå¤‡çš„å„ç§schedulerå®ç°
    
2. åç¨‹å€Ÿé‰´éƒ¨åˆ†asioçš„æ€è·¯, é¦–å…ˆè®©åç¨‹å¯ä»¥åŸºäºcontextä¸Šä¸‹æ–‡, åœ¨è·¨çº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨, å¦å¤–æ›´å¤šè¿˜æ˜¯ä½¿ç”¨åŸæœ‰æ¡†æ¶æœ‰æ˜ç¡®çš„schedulerçš„æ–¹å¼å¯¹æ‰€æœ‰åç¨‹è¿›è¡Œç®¡ç†å’Œå®šåˆ¶çš„æ¨¡å¼.
    
3. ä½¿ç”¨asioçš„scheduleréƒ¨åˆ†ä½œä¸ºexecutionçš„åº•å±‚schedulerå®ç°, åŒæ—¶ä¹Ÿä½¿ç”¨asioçš„timerè¡¨è¾¾, å»é™¤åŸå§‹libunifexä¾èµ–ä¸åŒscheduleræä¾›schedule_at()æ–¹æ³•æ¥æ‰§è¡Œå®šæ—¶å™¨ç›¸å…³é€»è¾‘çš„å®ç°.
    
4. æ ¹æ®ä¸šåŠ¡éœ€è¦, å®šåˆ¶ä¸€äº›å¿…è¦çš„sender adapterç­‰ç®€åŒ–ä¸šåŠ¡çš„ä½¿ç”¨.
    
5. å°è¯•ç”¨executionæ¡†æ¶å¯¹æ¥ISPCç­‰ç‰¹æ®Šçš„å¹¶å‘åº“, èƒ½å¤Ÿä»¥ä¸€ä¸ªæ¸…æ™°çš„æ–¹å¼æ¥è¡¨è¾¾è¿™ç§æ··åˆç¯å¢ƒä¸Šæ‰§è¡Œçš„é€»è¾‘.
    

æœ¬ç³»åˆ—æ¶‰åŠçš„åŸºç¡€çŸ¥è¯†å’Œç›¸å…³å†…å®¹æ¯”è¾ƒå¤š, å…ˆç»™å‡ºä¸€ä¸ªä¸´æ—¶çš„å¤§çº², åç»­å¯èƒ½ä¼šæœ‰è°ƒæ•´. ç›®å‰çš„æ€è·¯æ˜¯å…ˆä»‹ç»å¤§å®¶ç›¸å¯¹ç†Ÿæ‚‰åº¦ä¸é‚£ä¹ˆé«˜çš„executionåŸºç¡€çŸ¥è¯†å’Œlibunifex, åé¢å†ä»‹ç»asioç›¸å…³çš„schedulerä»¥åŠcoroutineå®ç°, æœ€åå†å›å½’ç¬”è€…æ­£åœ¨è¿­ä»£çš„framework, è¿™æ ·ä¸€ä¸ªé¡ºåºæ¥å±•å¼€.

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

  

**å¾€æœŸ****ç²¾å½©****å›é¡¾**

  

  

  

  

[æƒ¯ç”¨æ³•ä¹‹CRTP](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488842&idx=1&sn=d39efe4a60dfc2a2146bbdfa37442e71&chksm=c337738df440fa9bd4000d097c76ef530b13f0d4c53ee45a03a0a033ea57b7b0b3f436af1e4a&scene=21#wechat_redirect)

[èŠèŠå†…å­˜æ¨¡å‹ä¸å†…å­˜åº](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488826&idx=1&sn=5ec3f6e6959b51de02b850aeee609f34&chksm=c33773fdf440faebd97a0184c3e30ce77b3ce306d7d6dea9967ece6bef41e9f6d9d9030b2a62&scene=21#wechat_redirect)

[vectoråˆå§‹åŒ–ä¸å¦å¯¼è‡´çš„å·¨å¤§æ€§èƒ½å·®å¼‚](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488441&idx=1&sn=f75be00bcd12934c2e7331956707a429&chksm=c337757ef440fc6816fdef3c144361a0e21ebe24da6ea497d8122ca04c81c7dcc40445ae3f1a&scene=21#wechat_redirect)

[é—®é¢˜è§£å†³äº†ï¼Œæˆ‘å´ä¸çŸ¥é“åŸå› ](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488372&idx=1&sn=f3acc2893cbafc99c21203f4db0e24ee&chksm=c33775b3f440fca5410edde4ce29f1cbeec7c1734357e54c02bbe549ed3f435a4243f7e8d297&scene=21#wechat_redirect)

[æ­å¼€lambdaçš„ç¥ç§˜é¢çº±](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488290&idx=1&sn=c4d2416b3ee3968303379a8cef66105d&chksm=c33775e5f440fcf30a3a8bef429eb199577f71a15d688ddf729ed1edbb94d119d58c470195f1&scene=21#wechat_redirect)  

[å¤šæ€å®ç°-è™šå‡½æ•°ã€å‡½æ•°æŒ‡é’ˆä»¥åŠå˜ä½“](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488149&idx=1&sn=4b7718a8798245b3a50e1fc9aebf5dee&chksm=c3377452f440fd44d13a4a99d3e16a2d06de0539b9f8365b7346de9c8037ea91b59f46df934f&scene=21#wechat_redirect)

[ã€Modern C++ã€‘æ·±å…¥ç†è§£ç§»åŠ¨è¯­ä¹‰](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247488000&idx=1&sn=156cad69e290f1e898cded46cd4cedc9&chksm=c33774c7f440fdd1e7db21f175029adcf622fe53f1968bb8acefa027bf95f01d5e2c2bb3d7a7&scene=21#wechat_redirect)

[ã€Modern C++ã€‘æ·±å…¥ç†è§£å·¦å€¼ã€å³å€¼](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247487751&idx=1&sn=3da21227cb1a4c80e36f91dc823529af&chksm=c33777c0f440fed6f9ebaa7f206f1e423f68c09a809a4d30033f34bd123ccf45d9e42655e199&scene=21#wechat_redirect)  

[æ™ºèƒ½æŒ‡é’ˆ-ä½¿ç”¨ã€é¿å‘å’Œå®ç°](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247487474&idx=1&sn=e29d0178bfd4139313c44139e1cb3899&chksm=c3376935f440e023b96e9f8feeb34e4e22fbb74f00ca345a2b867edfd4c088bc595821fe878e&scene=21#wechat_redirect)  

[å†…å­˜æ³„æ¼-åŸå› ã€é¿å…ä»¥åŠå®šä½](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247487009&idx=1&sn=a812d27b9d65369ce2f38375b4a4ee96&chksm=c33768e6f440e1f015252fecf354f9f3712f59fc04b47b03401486c86fe51875428503ee9819&scene=21#wechat_redirect)  

[GDBè°ƒè¯•-ä»å…¥é—¨å®è·µåˆ°åŸç†](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247486816&idx=1&sn=a6dfc1361ce15ce5ad1c7d7734f9c939&chksm=c3376ba7f440e2b18267c303c35572ab089fb97d3b2fe0adb58009637d6631020bb52bd9a28c&scene=21#wechat_redirect)  

[ã€çº¿ä¸Šé—®é¢˜ã€‘P1çº§å…¬å¸æ•…éšœï¼Œå¹´ç»ˆå¥–ä¸ä¿](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247486357&idx=1&sn=3e7b88218f4416980b20add7575baa9a&chksm=c3376d52f440e444d28a01ef930ddfb92b5d30f26e7284012f08624ca1599e7efac1da3fb17c&scene=21#wechat_redirect)

[ã€æ€§èƒ½ä¼˜åŒ–ã€‘é«˜æ•ˆå†…å­˜æ± çš„è®¾è®¡ä¸å®ç°](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247486254&idx=1&sn=ebce58aa6b547af2a818faa5a6412e89&chksm=c3376de9f440e4ffea267926b7ce09ac439ab33a1da9dc6b4d631c971053f628cf91202d0f53&scene=21#wechat_redirect)

[2ä¸‡å­—|30å¼ å›¾å¸¦ä½ é¢†ç•¥glibcå†…å­˜ç®¡ç†ç²¾é«“](http://mp.weixin.qq.com/s?__biz=Mzk0MzI4OTI1Ng==&mid=2247485953&idx=1&sn=f8cd484607ab07f15247ecde773d2e1c&chksm=c3376cc6f440e5d047f7e648c951fd583df82ab4e3dab5767baeddef9fe7c1270f05b039d8c4&scene=21#wechat_redirect)

  

ä½ å¥½ï¼Œæˆ‘æ˜¯é›¨ä¹ï¼Œä»ä¸šåäºŒå¹´æœ‰ä½™ï¼Œå†ç»è¿‡ä¼ ç»Ÿè¡Œä¸šç½‘ç»œç ”å‘ã€äº’è”ç½‘æ¨èå¼•æ“ç ”å‘ï¼Œç›®å‰åœ¨å¹¿å‘Šè¡Œä¸šä»ä¸š8å¹´ã€‚ç›®å‰ä»»èŒæŸäº’è”ç½‘å…¬å¸é«˜çº§æŠ€æœ¯ä¸“å®¶ä¸€èŒï¼Œè´Ÿè´£å¹¿å‘Šå¼•æ“çš„æ¶æ„å’Œç ”å‘ã€‚

æœ¬å…¬ä¼—å·ä¸“æ³¨äºæ¶æ„ã€æŠ€æœ¯ã€çº¿ä¸Šbugåˆ†æç­‰å¹²è´§ï¼Œæ¬¢è¿å…³æ³¨ã€‚

![](http://mmbiz.qpic.cn/mmbiz_png/p3sYCQXkuHhKgtwWvzaYZodgfpphdA6WWKEMXTn6ImCCCuEzlPKicNBcpzBUyjK1XicWwqIwusqLGpwyyOc87JPQ/300?wx_fmt=png&wxfrom=19)

**é«˜æ€§èƒ½æ¶æ„æ¢ç´¢**

ä¸“æ³¨äºåˆ†äº«å¹²è´§ï¼Œç¡¬è´§ï¼Œæ¬¢è¿å…³æ³¨ğŸ˜„

88ç¯‡åŸåˆ›å†…å®¹

å…¬ä¼—å·

  

é˜…è¯»Â 1918

â€‹

å†™ç•™è¨€

[](javacript:;)

![](http://mmbiz.qpic.cn/mmbiz_png/p3sYCQXkuHhKgtwWvzaYZodgfpphdA6WWKEMXTn6ImCCCuEzlPKicNBcpzBUyjK1XicWwqIwusqLGpwyyOc87JPQ/300?wx_fmt=png&wxfrom=18)

é«˜æ€§èƒ½æ¶æ„æ¢ç´¢

6åˆ†äº«2

å†™ç•™è¨€

å†™ç•™è¨€

**ç•™è¨€**

æš‚æ— ç•™è¨€