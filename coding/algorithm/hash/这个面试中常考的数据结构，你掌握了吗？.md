
åŸåˆ›Â é“¶æ–‡æ°Â åšæ–‡è§†ç‚¹Broadview

Â _2022å¹´01æœˆ24æ—¥ 18:58_

ğŸ‘†ç‚¹å‡»â€œåšæ–‡è§†ç‚¹Broadviewâ€ï¼Œè·å–æ›´å¤šä¹¦è®¯

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PW0wIHxgg3nr1VNxfeqxVOw2nPJHVH4xeZibzPY5F4ibOuOZLMsUMrzIibGB6KMw7EurSKv6DkrtLzuhYdBa30A9Q/640?wx_fmt=png&wxfrom=13&tp=wxpic)

ä¸çŸ¥é“å¤§å®¶åœ¨é¢è¯•æ—¶æ˜¯å¦ä¼šè¢«é—®åˆ°ä»€ä¹ˆæ ·çš„å“ˆå¸Œæ•°æ®ç»“æ„å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ

å¾ˆå¤šå°ä¼™ä¼´å¯èƒ½çŸ¥é“æ˜¯ConcurrentHashMapï¼Œå´å¯¹å…¶æ²¡æœ‰å¤ªå¤šäº†è§£ï¼Œæœ¬æ–‡å°±å¸¦å¤§å®¶å…ˆæ¥çœ‹ä¸€ä¸‹ConcurrentHashMapé›†åˆä¸­çš„size()æ–¹æ³•æ˜¯å¦‚ä½•ä¿è¯å‡†ç¡®è·å–é›†åˆå¤§å°çš„ã€‚

æˆ‘ä»¬å¯ä»¥æ€è€ƒä¸€ä¸ªæœ€ç®€å•çš„åœºæ™¯ï¼Œå³**è°ƒç”¨è€…å¦‚ä½•å–å¾—å½“å‰ConcurrentHashMapé›†åˆä¸­çš„æ•°æ®æ€»é‡ï¼Ÿ**

å¯èƒ½æœ‰ä¸€äº›è¯»è€…ä¼šè¯´ï¼Œç›´æ¥è°ƒç”¨ConcurrentHashMapé›†åˆæä¾›çš„size()æ–¹æ³•å³å¯ï¼›æˆ–è€…æœ‰ä¸€äº›è¯»è€…ä¼šæ›´è¿›ä¸€æ­¥è¯´ï¼ŒConcurrentHashMapé›†åˆä¸­æä¾›äº†ä¸€ä¸ªbaseCountå±æ€§ï¼Œæ¯å½“å®Œæˆæ·»åŠ æ“ä½œæ—¶ï¼ŒConcurrentHashMapé›†åˆéƒ½ä¼šåœ¨addCountæ–¹æ³•ä¸­åˆ©ç”¨ä¿è¯åŸå­æ€§çš„æ“ä½œæ¥æ›´æ–°baseCountå±æ€§çš„å€¼ã€‚

æ˜¯çš„ï¼Œä»¥ä¸Šä¸¤ç§æè¿°éƒ½æ²¡é”™ï¼Œä½†æ˜¯éœ€è¦è€ƒè™‘ä¸€ä¸ªå‰æï¼Œé‚£å°±æ˜¯ConcurrentHashMapé›†åˆå·¥ä½œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯èƒ½éšæ—¶æœ‰å¤šä¸ªçº¿ç¨‹åœ¨è¿›è¡Œè¯»å†™æ“ä½œã€‚

åœ¨è¿™æ ·çš„å‰æä¸‹ï¼Œå†å›å¤´çœ‹ä»¥ä¸Šä¸¤ç§æè¿°å¯èƒ½å°±å­˜åœ¨é—®é¢˜äº†ã€‚

**é¦–å…ˆï¼Œ**é€šè¿‡size()æ–¹æ³•å–å¾—çš„å½“å‰é›†åˆä¸­æ•°æ®æ€»é‡çš„å€¼ï¼Œå¾ˆå¯èƒ½ä¸æ˜¯ä¸€ä¸ªç²¾ç¡®å€¼ï¼Œä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨size()æ–¹æ³•è¿˜æœªå¾—åˆ°è¿”å›å€¼æ—¶ï¼Œé›†åˆä¸­çš„æ•°æ®æ€»é‡å¯èƒ½å°±å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚

**ç„¶åï¼Œ**åœ¨addCountæ–¹æ³•ä¸­ç¡®å®å¯ä»¥åˆ©ç”¨ä¿è¯åŸå­æ€§çš„æ“ä½œæ¥æ›´æ–°baseCountå±æ€§çš„å€¼ï¼Œä½†æ˜¯è‹¥baseCountå±æ€§å€¼æ›´æ–°å¤±è´¥äº†è¯¥æ€ä¹ˆåŠï¼Ÿ

æœ€ç›´è§‚çš„å¤„ç†æ€è·¯æ˜¯ï¼Œä¸€æ—¦baseCountå±æ€§å€¼æ›´æ–°å¤±è´¥ï¼Œå°±è¿›è¡Œé‡è¯•ã€‚ä½†å¾ˆæ˜æ˜¾baseCountå±æ€§æ˜¯ä¸€ä¸ªè¢«å¤šçº¿ç¨‹å…±äº«æ“ä½œçš„å±æ€§ï¼Œå¦‚æœé‡‡ç”¨å…¸å‹çš„CASè®¾è®¡æ€è·¯â€”â€”æ“ä½œå¤±è´¥å°±é‡è¯•ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹æ“ä½œä¸‹è¯¥å€¼çš„æ›´æ–°å¤§æ¦‚ç‡ä¼šå¤±è´¥ä¸”éœ€è¦è¿›è¡Œå¤šæ¬¡é‡è¯•ï¼Œä»è€Œå½¢æˆå¹¶å‘åœºæ™¯ä¸‹ConcurrentHashMapé›†åˆæ·»åŠ æ“ä½œçš„æ˜æ˜¾æ€§èƒ½ç“¶é¢ˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
![[Pasted image 20240910173218.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ConcurrentHashMapé›†åˆçš„ä¸»è¦è®¾è®¡æ€è·¯æ˜¯åŸºäºçº¿ç¨‹ç¨³å®šä¸å˜çš„â€œæ¢é’ˆâ€åŠŸèƒ½ï¼Œè®¾ç½®å¤šä¸ªä¸åŒçš„â€œè®¡æ•°æ§½â€ï¼Œä¿è¯å¤§å¤šæ•°çº¿ç¨‹åœ¨æ›´æ–°è®¡æ•°å€¼æ—¶ä¸ä¼šäº§ç”ŸåŸå­æ“ä½œå†²çªã€‚

è¯¥éƒ¨åˆ†çš„è®¾è®¡æ˜¯ConcurrentHashMapé›†åˆä¸­å€¼å¾—è¯»è€…å­¦ä¹ å’Œåœ¨å®é™…å·¥ä½œä¸­å€Ÿé‰´çš„è®¾è®¡æ€è·¯ä¹‹ä¸€ã€‚

###### **ï¼ˆ1ï¼‰Â ConcurrentHashMapé›†åˆä¸­ä¸æ•°é‡è®¡æ•°æœ‰å…³çš„å±æ€§ç»“æ„**

ConcurrentHashMapé›†åˆä¸­ä¸æ•°é‡è®¡æ•°æœ‰å…³çš„å±æ€§ç»“æ„ä¸»è¦æœ‰3ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šÂ 

```java
public class ConcurrentHashMap<K,V> extends AbstractMap<K,V>
    implements ConcurrentMap<K,V>, Serializable {
// ......
  // åŸºç¡€è®¡æ•°å™¨ï¼Œåœ¨æ²¡æœ‰å¹¶å‘ç«äº‰çš„åœºæ™¯ä¸‹ï¼Œè®°å½•ç›®å‰é›†åˆä¸­çš„æ•°æ®æ€»é‡
  private transient volatile long baseCount;
  // è¡¨ç¤ºç›®å‰CounterCellsæ•°é‡è®¡æ•°å™¨æ˜¯å¦ç”±äºæŸç§åŸå› æ— æ³•å·¥ä½œã€‚0è¡¨ç¤ºå¯ä»¥å·¥ä½œï¼›1è¡¨ç¤ºä¸èƒ½å·¥ä½œ
  // å½“CounterCellsæ•°é‡è®¡æ•°å™¨è¢«æ‰©å®¹æˆ–è€…è¢«åˆå§‹åŒ–æ—¶ï¼Œè¯¥å€¼ä¸º1ï¼›å…¶ä»–æƒ…å†µä¸‹è¯¥å€¼ä¸º0
  private transient volatile int cellsBusy;
  // åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œé›†åˆä½¿ç”¨ä¸€ä¸ªCounterCellæ•°ç»„ï¼ŒåŸºäºçº¿ç¨‹â€œæ¢é’ˆâ€è¿›è¡Œæ•°æ®é‡çš„è®°å½•
  private transient volatile CounterCell[] counterCells;
  // ......
}

```

  

###### **ï¼ˆ2ï¼‰Â CounterCellå¹¶å‘è®¡æ•°å™¨çš„å·¥ä½œè¿‡ç¨‹æ¦‚è¦**

ConcurrentHashMapé›†åˆçš„ç¬æ—¶æ•°æ®é‡ç­‰äºbaseCountä¸CounterCellsæ•°ç»„ä¸­æ‰€æœ‰ç´¢å¼•ä½ä¸Šå·²è®°å½•çš„å€¼ä¹‹å’Œã€‚

æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ConcurrentHashMapé›†åˆçš„size()æ–¹æ³•çš„æºä»£ç ï¼š

```java
public int size() {
  long n = sumCount();
  return ((n < 0L) ? 0 : (n > (long)Integer.MAX_VALUE) ? Integer.MAX_VALUE : (int)n);
}
 
// è¯¥æ–¹æ³•æ˜¯ç»Ÿè®¡é›†åˆä¸­æ•°æ®æ€»é‡çš„æ–¹æ³•
final long sumCount() {
  // ç»Ÿè®¡æ–¹å¼æ˜¯ä»¥baseCountå±æ€§å€¼ä¸ºåŸºç¡€çš„
  // ç„¶åç´¯åŠ counterCellsæ¯ä¸€ä¸ªç´¢å¼•ä½ä¸Šçš„æ•°å€¼
  CounterCell[] cs = counterCells;
  long sum = baseCount;
  if (cs != null) {
    for (CounterCell c : cs) {
  if (c != null) {sum += c.value;}
}
  }
  return sum;
}

```

å¦‚æœConcurrentHashMapé›†åˆå·¥ä½œåœ¨ä¸€ä¸ªå¹¶å‘ä¸é«˜çš„ç¯å¢ƒä¸­ï¼ŒConcurrentHashMapé›†åˆä¼šåœ¨æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é›†åˆä¸­åï¼Œç›´æ¥é€šè¿‡ä¿è¯åŸå­æ€§çš„compareAndSetLongæ–¹æ³•æ¥å®ŒæˆbaseCountè®¡æ•°å™¨çš„æ•°å€¼å¢åŠ å·¥ä½œï¼›å¦‚æœå½“å‰é›†åˆå·¥ä½œåœ¨å¹¶å‘è¾ƒé«˜çš„åœºæ™¯ä¸­ï¼ˆä¾æ®æ˜¯é€šè¿‡compareAndSetLongæ–¹æ³•æ¥æ›´æ–°baseCountè®¡æ•°å™¨æ—¶å¤±è´¥ï¼‰ï¼Œå°±åˆå§‹åŒ–counterCellsæ•°ç»„ï¼Œå¹¶åœ¨åç»­çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œåœ¨counterCellsæ•°ç»„ç‰¹å®šçš„ç´¢å¼•ä½å¢åŠ è®¡æ•°å€¼ã€‚

è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯addCountæ–¹æ³•ä¸­ç¬¬ä¸€ä¸ªé€»è¾‘æ­¥éª¤æ‰€å¸Œæœ›è¡¨è¾¾çš„ï¼š

```java
// è¯¥æ–¹æ³•ä¸»è¦æ˜¯ä¸ºæ•°æ®é‡è®¡æ•°å™¨å¢åŠ æ•°å€¼ï¼Œå¹¶åŸºäºå½“å‰çš„æ•°æ®é‡ç¡®è®¤æ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹
private final void addCount(long x, int check) {
  // è¿™æ˜¯è¯¥æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªé€»è¾‘æ­¥éª¤
  // ç”¨æ¥åˆ†åœºæ™¯æ‰§è¡Œæ•°é‡è®¡æ•°å™¨+1çš„æ“ä½œ
  // å¦‚æœå½“å‰é›†åˆä¸­å·²ç»æœ‰å¹¶å‘è®¡æ•°å™¨ï¼Œæˆ–è€…æ›´æ–°baseCountè®¡æ•°å™¨å¤±è´¥
  // å°±è¿›å…¥è¿™ä¸ªé€»è¾‘è¿‡ç¨‹ï¼Œå°†æ•°å€¼å¢åŠ çš„æƒ…å†µè®°å½•åˆ°æ–°çš„æˆ–è€…å·²æœ‰çš„counterCellsæ•°ç»„ä¸­
  if ((cs = counterCells) != null ||
  !U.compareAndSetLong(this, BASECOUNT, b = baseCount, s = b + x)) {
CounterCell c; long v; int m;
// è¯¥å˜é‡è¯´æ˜è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªé»˜è®¤çš„æ— ç«äº‰ç¯å¢ƒ
    boolean uncontended = true;
// ç¨‹åºä»£ç è¯•å›¾åœ¨counterCellsæ•°ç»„å¯¹è±¡æ­£ç¡®ã€counterCellsç‰¹å®šç´¢å¼•ä½ä¸Šæ•°æ®æ­£ç¡®
// çš„å‰æä¸‹ç›´æ¥ç´¯åŠ æ›´æ–°è¿™ä¸ªç´¢å¼•ä½ä¸Šçš„valueæ•°æ®
// å¦‚æœæ¡ä»¶ä¸æ»¡è¶³æˆ–è€…æ›´æ–°å¤±è´¥ï¼Œ
// åˆ™è¿›å…¥fullAddCountæ–¹æ³•ï¼Œè¿›è¡Œä¸€ä¸ªå®Œæ•´çš„counterCellsåˆå§‹åŒ–å’Œæ•°å€¼ç´¯åŠ è¿‡ç¨‹
    if (cs == null || (m = cs.length - 1) < 0 || (c = cs[ThreadLocalRandom.getProbe() & m]) == null
   || !(uncontended = U.compareAndSetLong(c, CELLVALUE, v = c.value, v + x))) {
      fullAddCount(x, uncontended);
      return;
    }
    if (check <= 1) { return; }
    s = sumCount();
  }
  
  // æ£€æŸ¥æ˜¯å¦è¿›è¡Œæ‰©å®¹å’Œæ•°æ®è¿ç§»çš„é€»è¾‘è¿‡ç¨‹
  if (check >= 0) {
    // ...... è¿™é‡Œçœç•¥äº†ä¸€äº›ä»£ç 
  }
}

```

  

è¿™é‡Œæœ‰å‡ ä¸ªå…³é”®ç‚¹éœ€è¦è¿›è¡Œè¯´æ˜ã€‚

- **ConcurrentHashMapé›†åˆä½¿ç”¨counterCellsæ•°ç»„è€Œä¸æ˜¯baseCountå±æ€§è®°å½•é›†åˆä¸­çš„é”®å€¼å¯¹æ•°æ®é‡**ï¼Œå‰ææ¡ä»¶å°±æ˜¯é€šè¿‡compareAndSetLongæ–¹æ³•è¿›è¡ŒbaseCountå±æ€§çš„æ“ä½œæ—¶ï¼Œæ“ä½œå¤±è´¥ã€‚
    
- **ConcurrentHashMapé›†åˆå¯¹counterCellsæ•°ç»„è¿›è¡Œè®¡æ•°å¢åŠ å’Œæ‰©å®¹æ“ä½œçš„å¤„ç†è¿‡ç¨‹ï¼Œè¢«æ”¾ç½®åœ¨fullAddCountæ–¹æ³•ä¸­ã€‚**åè€…ä¹Ÿè´Ÿè´£counterCellsæ•°ç»„çš„åˆå§‹åŒ–ï¼Œå®ƒå°†counterCellsæ•°ç»„çš„åˆå§‹åŒ–é•¿åº¦è®¾ç½®ä¸º2ã€‚counterCellsæ•°ç»„çš„æ¯ä¸€ä¸ªç´¢å¼•ä½åªèƒ½é€šè¿‡ä¿è¯åŸå­æ€§æ“ä½œçš„compareAndSetLongæ–¹æ³•æ¥è¿›è¡Œå†™å¤„ç†ã€‚
    
- **ç‰¹åˆ«æ³¨æ„addCountæ–¹æ³•ä¸­ä½¿ç”¨çš„ThreadLocalRandomç±»ï¼Œæ–¹æ³•ä¸­ä½¿ç”¨äº†è¯¥å·¥å…·ç±»æä¾›çš„getProbe()æ–¹æ³•æ¥è·å–å½“å‰çº¿ç¨‹çš„â€œæ¢é’ˆâ€å€¼ã€‚**è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰å¼€æ”¾ç»™æœ€ç»ˆç¨‹åºå‘˜ä½¿ç”¨çš„åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å°†ä¸ºè°ƒç”¨è€…è¿”å›ä¸€ä¸ªåœ¨å½“å‰çº¿ç¨‹ä¸­ç¨³å®šä¸å˜çš„ä¸”å…¨è¿›ç¨‹å”¯ä¸€çš„hashå€¼ã€‚è¿™ä¸ªhashå€¼å¯ä»¥åœ¨ThreadLocalRandomå¯¹è±¡è°ƒç”¨advanceProbeæ–¹æ³•åå‘ç”Ÿå˜åŒ–ã€‚è€Œå½“è®¡ç®—æŸä¸ªçº¿ç¨‹çš„è®¡æ•°å€¼åº”è¯¥å­˜æ”¾åœ¨counterCellsæ•°ç»„çš„å“ªä¸€ä¸ªç´¢å¼•ä½æ—¶ï¼Œä½¿ç”¨çš„å°±æ˜¯â€œæ¢é’ˆâ€å€¼å’ŒcounterCellsæ•°ç»„é•¿åº¦é€šè¿‡â€œä¸â€è¿ç®—å–ä½™æ•°çš„æ–¹å¼å®Œæˆçš„ã€‚
    
- **è™½ç„¶counterCellsæ•°ç»„çš„åˆå§‹åŒ–é•¿åº¦åªæœ‰2ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬æ—¶åªå…è®¸ä¸¤ä¸ªæ“ä½œçº¿ç¨‹å¯¹counterCellsæ•°ç»„ä¸­çš„ä¸åŒç´¢å¼•ä½ä¸Šçš„è®¡æ•°å€¼è¿›è¡ŒæˆåŠŸä¿®æ”¹ï¼Œä½†è¯¥æ•°ç»„æ˜¯å¯ä»¥è¢«æ‰©å®¹çš„ã€‚**æ¯æ¬¡æ‰©å®¹æŒ‰ç…§counterCellsæ•°ç»„åŸå§‹å®¹é‡çš„2å€è¿›è¡Œï¼ˆå³å®¹é‡å§‹ç»ˆä¸º2çš„å€æ•°ï¼‰ï¼Œä¸”å®¹é‡çš„æœ€å¤§ä¸Šé™ä¸ºå½“å‰è¿›ç¨‹å¯ä½¿ç”¨çš„CPUå†…æ ¸ä¸ªæ•°ï¼ˆNï¼‰â€”â€”è¶…è¿‡å½“å‰è¿›ç¨‹å¯ä½¿ç”¨çš„CPUå†…æ ¸ä¸ªæ•°çš„counterCellsæ•°ç»„å¤§å°æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºä¸ä¼šæœ‰é‚£ä¹ˆå¤šåŒæ—¶å¹¶å‘çš„çº¿ç¨‹æ•°é‡ã€‚
    
- **counterCellsæ•°ç»„æ‰©å®¹çš„æ¡ä»¶å¾ˆå¾®å¦™ï¼Œå®ƒå¹¶ä¸æ˜¯ä»¥æŸä¸ªæ—¢å®šçš„é˜ˆå€¼ä¸ºæ‰©å®¹æ ‡å‡†çš„ï¼Œè€Œæ˜¯â€œä»¥å½“å‰è¿›è¡ŒConcurrentHashMapé›†åˆæ“ä½œçš„å¤šä¸ªçº¿ç¨‹ï¼Œåœ¨å½“å‰æ—¢å®šå®¹é‡çš„counterCellsæ•°ç»„çš„æ”¯æŒä¸‹ï¼Œæ˜¯å¦ä»ç„¶å­˜åœ¨æŠ¢å å†²çªçš„æƒ…å†µâ€æ¥å†³å®šæ˜¯å¦è¿›è¡ŒcounterCellsæ•°ç»„çš„æ‰©å®¹çš„ã€‚**ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ‰§è¡ŒcompareAndSetLong(c, CELLVALUE, v = c.value, v + x)è¯­å¥æ—¶è¿”å›äº†falseçš„åœºæ™¯ã€‚
    
- **ä¸ºä¿è¯æ‰€æœ‰æ“ä½œçº¿ç¨‹éƒ½èƒ½äº†è§£åˆ°counterCellsæ•°ç»„ç›®å‰æ­£åœ¨æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ï¼ˆè¿˜æœ‰counterCellsæ•°ç»„åˆå§‹åŒ–æ—¶æˆ–è€…counterCellsæ•°ç»„æŸä¸€ä¸ªç´¢å¼•ä½åˆå§‹åŒ–æ—¶ï¼‰cellsBusyå±æ€§ä¼šè¢«æ ‡è®°ä¸º1ï¼Œ**ä¸‹å›¾å¯ä»¥æè¿°counterCellsæ•°ç»„å·¥ä½œçš„å¤šä¸ªæ ¸å¿ƒè¦ç‚¹ã€‚
    
![[Pasted image 20240910173322.png]]
![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**æœ€åï¼Œ**counterCellsæ•°ç»„æŸä¸ªç´¢å¼•ä½ä¸Šçš„æ•°æ®é‡è®¡æ•°å€¼æ˜¯ç”±å“ªä¸ªçº¿ç¨‹æ‰§è¡Œå¢åŠ æ“ä½œçš„ï¼Œå®é™…ä¸Šå¯¹äºConcurrentHashMapé›†åˆæ¥è¯´å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä¿è¯æ•°å€¼å¯ä»¥æ­£ç¡®è®°å½•ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šä¸€æ¬¡Thread1å®Œæˆæ•°æ®æ·»åŠ åï¼Œå¯èƒ½åœ¨counterCellsæ•°ç»„çš„0å·ç´¢å¼•ä½ä¸Šè¿›è¡Œè®¡æ•°å€¼å¢åŠ ï¼ˆ+1ï¼‰ï¼Œä½†æ˜¯ä¸‹ä¸€æ¬¡Thread1å®Œæˆæ•°æ®æ·»åŠ åï¼Œåˆå¯èƒ½åœ¨counterCellsæ•°ç»„çš„3å·ç´¢å¼•ä½ä¸Šè¿›è¡Œæ•°å€¼å¢åŠ ï¼ˆ+1ï¼‰ã€‚

ä»¥ä¸ŠThreadçº¿ç¨‹å˜åŒ–æ‰€ä½¿ç”¨çš„counterCellsæ•°ç»„ç´¢å¼•ä½çš„æƒ…å†µç¡®å®æ˜¯ä¼šå‘ç”Ÿçš„ã€‚

æœ€å…¸å‹çš„æƒ…å†µå°±æ˜¯å½“å‰Threadçº¿ç¨‹ä½¿ç”¨åŸå­æ“ä½œæ›´æ–°æŸä¸ªç´¢å¼•ä½çš„è®¡æ•°å€¼å¤±è´¥ï¼Œä½†æ˜¯åˆå› ä¸ºè¾¾åˆ°äº†counterCellsæ•°ç»„çš„æ‰©å®¹ä¸Šé™è€Œæ— æ³•è¿›è¡Œæ‰©å®¹ï¼Œè¿™æ—¶ç³»ç»Ÿå°±ä¼šè°ƒç”¨Threadçº¿ç¨‹å¯¹åº”çš„ThreadLocalRandomå·¥å…·ç±»çš„advanceProbeæ–¹æ³•ï¼Œä»¥æ”¹å˜çº¿ç¨‹çš„â€œæ¢é’ˆâ€å€¼ï¼Œæœ€ç»ˆè¾¾åˆ°æ›´æ”¹å…¶ä½¿ç”¨çš„counterCellsæ•°ç»„ç´¢å¼•ä½çš„ç›®çš„ã€‚

æœ¬æ–‡æ‘˜è‡ª**ã€Š****Javaé«˜å¹¶å‘ä¸é›†åˆæ¡†æ¶ï¼šJCFå’ŒJUCæºç åˆ†æä¸å®ç°****ã€‹**ä¸€ä¹¦ï¼æ¬¢è¿é˜…è¯»æ­¤ä¹¦äº†è§£æ›´å¤šç›¸å…³å†…å®¹ï¼

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E "Javaé«˜å¹¶å‘ä¸é›†åˆæ¡†æ¶ï¼šJCFå’ŒJUCæºç åˆ†æä¸å®ç°.jpg")

**â–Š****ã€ŠJavaé«˜å¹¶å‘ä¸é›†åˆæ¡†æ¶ï¼šJCFå’ŒJUCæºç åˆ†æä¸å®ç°ã€‹**

é“¶æ–‡æ°Â è‘—

  

- æŒæ¡Javaé›†åˆæ¡†æ¶å’ŒJavaå¹¶å‘å·¥å…·åŒ…ï¼Œè½»æ¾åº”å¯¹80%çš„å·¥ä½œåœºæ™¯
    

æœ¬ä¹¦å¹¶ä¸è®²è§£JCFå’ŒJUCä¸­å„ä¸ªç»„ä»¶çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œå› ä¸ºä½œè€…ç›¸ä¿¡JCFå’ŒJUCä¸­å„ç§ç»„ä»¶çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•å¤§å®¶é€šè¿‡æŸ¥çœ‹ç½‘ç»œèµ„æ–™å°±å¯ä»¥è¯¦ç»†äº†è§£ã€‚

æœ¬ä¹¦çš„ä¸»è¦å†…å®¹æ˜¯ä»æºä»£ç çš„å±‚é¢å‰–æJCFå’ŒJUCçš„å®ç°åŸç†ï¼Œä»¥åŠè®²è§£æºä»£ç ä¸­è•´å«çš„ç†è®ºçŸ¥è¯†ï¼Œå¹¶è®²è§£å¦‚ä½•å°†è¿™äº›å¤§å¸ˆçº§çš„ç†è®ºçŸ¥è¯†åº”ç”¨åˆ°å®é™…å·¥ä½œä¸­ã€‚

å› ä¸ºæ˜¯è¿›è¡Œæºä»£ç åˆ†æï¼Œæ‰€ä»¥è¿™æœ¬ä¹¦åŒ…å«äº†å¤§é‡çš„JavaåŸç”Ÿæ¨¡å—çš„æºä»£ç ï¼Œå¹¶ä¸”è¿›è¡Œäº†é€è¡Œæ³¨é‡Šã€‚è¯·æ³¨æ„æ˜¯é€è¡Œæ³¨é‡Šï¼Œæ‰€ä»¥åœ¨å¤§å®¶é˜…è¯»æœ¬ä¹¦æ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ— æ³•è¯»æ‡‚æºä»£ç ã€‚è¿™è§£å†³äº†å¾ˆå¤šè¯»è€…çš„æºä»£ç ææƒ§ç—‡é—®é¢˜ã€‚

è¿™äº›è¢«é€è¡Œæ³¨é‡Šã€é€è¡Œå‰–æè®²è§£çš„æºä»£ç ï¼Œä¹Ÿæ˜¯æœ¬ä¹¦åŒºåˆ«äºå¸‚é¢ä¸ŠåŒç±»ä¹¦ç±çš„ä¸€å¤§äº®ç‚¹ã€‚æœ¬ä¹¦è¿˜åŒ…å«äº†å¤§é‡çš„å·¥ä½œåŸç†å›¾ä¾‹ï¼Œè¿™äº›å›¾ä¾‹ä¸æ¯ä¸€ä¸ªè¿›è¡Œäº†æºç å‰–æçš„çŸ¥è¯†ç‚¹ä¸€ä¸€å¯¹åº”ï¼Œå½¢æˆäº†æœ¬ä¹¦ç‹¬å…·ç‰¹ç‚¹çš„å›¾æ–‡å¹¶èŒ‚çš„è®²è§£æ–¹å¼ã€‚

ä¾‹å¦‚æœ¬ä¹¦å½“ç„¶ä¼šè¯¦ç»†å‰–æConcurrentHashMapé›†åˆçš„ç»“æ„å’Œå·¥ä½œè¿‡ç¨‹ï¼Œä½†æœ¬ä¹¦æ›´å…³æ³¨ConcurrentHashMapé›†åˆä¸ºäº†é€‚åº”é«˜å¹¶å‘åœºæ™¯æ‰€åšçš„å…¸å‹åŒ–è®¾è®¡ã€‚

  

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E "Javaé«˜å¹¶å‘äºŒç»´ç  (2).png")

ï¼ˆæ‰«ç äº†è§£æœ¬ä¹¦è¯¦æƒ…ï¼ï¼‰

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)  

  

å¦‚æœå–œæ¬¢æœ¬æ–‡

æ¬¢è¿Â **åœ¨çœ‹**ä¸¨**ç•™è¨€**ä¸¨**åˆ†äº«è‡³æœ‹å‹åœˆ**Â ä¸‰è¿

  

  

Â **çƒ­æ–‡æ¨è**Â Â 

  

- [ä¹¦å• | è‡´æ•¬è®¡ç®—æœºè§†è§‰é¢†åŸŸç»å…¸è‘—ä½œï¼](http://mp.weixin.qq.com/s?__biz=MjM5NTk0NjMwOQ==&mid=2651147098&idx=1&sn=6bac384de1b514abc9ca7fcae987bdbb&chksm=bd0121708a76a8662f8d0c7dca91bbef983e5815ce6a8a1375acb32ce6c8214202149cb7877d&scene=21#wechat_redirect)  
    
- [é”€é‡ä¹‹ç‹ï¼Œå»å¹´ç¨‹åºå‘˜æœ€çˆ±çœ‹çš„æŠ€æœ¯ä¹¦å°±æ˜¯å®ƒï¼](http://mp.weixin.qq.com/s?__biz=MjM5NTk0NjMwOQ==&mid=2651147049&idx=1&sn=22301cf96ae8fa4b130ec52b688973fd&chksm=bd0121038a76a8155dffef2e0dc58cef2da1f6d81b163edb1eee12cbac3d6d91f9008e2bed4e&scene=21#wechat_redirect)  
    
- [ç®—æ³•å¤§ä½¬Carlçš„é¢è¯•ç®€å†é•¿å•¥æ ·ï¼Ÿ](http://mp.weixin.qq.com/s?__biz=MjM5NTk0NjMwOQ==&mid=2651147022&idx=1&sn=93e0776ea73ad96e59eaaff03e8a4493&chksm=bd0121248a76a83263c52197fd1fff804397170e60f5fc92aa86aa0b44704b0c09f56d6402db&scene=21#wechat_redirect)  
    
- [ä¸€ç é€šçš„æ—¶ä»£ï¼Œå¦‚ä½•å®ç°äºŒç»´ç çš„æ£€æµ‹å’Œè§£ç ï¼Ÿ](http://mp.weixin.qq.com/s?__biz=MjM5NTk0NjMwOQ==&mid=2651146975&idx=1&sn=15ee9686cb7740c90b4256a638b64a59&chksm=bd0120f58a76a9e368006ba27d3d4144afca3ce7d2469329b2e82d0da8fe30ebcc35b9089637&scene=21#wechat_redirect)
    

  

---

  

![å›¾ç‰‡](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

â–¼ç‚¹å‡»é˜…è¯»åŸæ–‡ï¼ŒæŸ¥çœ‹æœ¬ä¹¦è¯¦æƒ…~

é˜…è¯»åŸæ–‡

é˜…è¯»Â 1096

â€‹