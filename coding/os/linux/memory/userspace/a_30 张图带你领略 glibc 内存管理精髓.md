 
CPPå¼€å‘è€…

Â _2022å¹´05æœˆ12æ—¥ 11:50_Â _æµ™æ±Ÿ_

The following article is from é«˜æ€§èƒ½æ¶æ„æ¢ç´¢Â Author é›¨ä¹

[

![](http://wx.qlogo.cn/mmhead/Q3auHgzwzM5l59Jsg6JicJQAuib8Sc0WPkC0P6LaJzVntCQerzf7bcPg/0)

**é«˜æ€§èƒ½æ¶æ„æ¢ç´¢**.

ä¸“æ³¨äºåˆ†äº«å¹²è´§ï¼Œç¡¬è´§ï¼Œæ¬¢è¿å…³æ³¨ğŸ˜„

](https://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651170981&idx=1&sn=61be27deb019126bb32fd6d8da71d44a&chksm=806479fab713f0ec2c47394610dc0e91e7fd51d01b473566f10d9adfa3dda9a8a48bfa5d15ae&mpshare=1&scene=24&srcid=0512SAyJ9OJxGdXLQ7YCVAjs&sharer_sharetime=1652338318591&sharer_shareid=8397e53ca255d0bca170c6327d62b9af&key=daf9bdc5abc4e8d0587970c94857179744e0205b2a8b610acadc576e8a17dd598be9fe9bdf2324916f995c39d585c306ab622680f4f0df9f3d46433d2db46cd37539ed4c65502e372c9bd6c8aec76ce508dff7e3f9933aaaeffa3741106b262cd0246c9323c2379fda1143ceed5438f481258103507a6c05b6c0d1f72092c79a&ascene=14&uin=MTEwNTU1MjgwMw%3D%3D&devicetype=iMac+MacBookAir10%2C1+OSX+OSX+14.6.1+build(23G93)&version=13080710&nettype=WIFI&lang=en&session_us=gh_e829fd9228a9&countrycode=CN&fontScale=100&exportkey=n_ChQIAhIQ02wLcyO%2B3%2Fj%2FRmT%2B6lGfRxKUAgIE97dBBAEAAAAAAARMFt%2FXnXcAAAAOpnltbLcz9gKNyK89dVj0pIZOhCMoj51%2Fbd2zR%2B2Kka0Vvs8Q3HWgtAdfntSTklobIVWavD5FvwsFLIyXLX5RiiAXfLqamW7P1MqDIr0gV9immhm%2Bf5VIsLyGDmUqvuyhA9jGid0Fg%2B0BvxCtdIxhsmNDr1AFeY7sBI2hmy3QjVaCGaJISbwynacz75cdE8hyS9zAoF3Y%2F4pPoUpYOtM7kZN0s9BmUuw%2B1m8yI%2Bn0SdJxnJXvIHLNzdz2wZ%2FPd73sqyVyKmVdMUGpufqQqqgx8jsiivv5cwfp44aaLDveX%2Fw%2BeU507rV6pkoYRWCg%2BjbIm3YoGVrFJZIuZRNd%2Fg%3D%3D&acctmode=0&pass_ticket=q6POhk3Bct7s1ht4Sq%2BwmceZMpwDuNxcMqFo88t1VUhRzhjl%2F%2BnXe83K0Ts2j52V&wx_header=0#)

åœ¨é€›çŸ¥ä¹çš„æ—¶å€™ï¼Œçœ‹åˆ°ç¯‡å¸–å­ï¼Œå¦‚ä¸‹ï¼š  

![Image](https://mmbiz.qpic.cn/mmbiz_png/p3sYCQXkuHhRXIkKJ7KWooq2f0YibyXX9AAGq6Vqp50R6onibERQV75sBiaIyuI8LEOUVNWQicQLJs99FOuVcVHTdw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

çœ‹äº†ä¸‹é¢æ‰€æœ‰çš„å›ç­”ï¼Œè¦ä¹ˆæ˜¯æ²¡æœ‰å›ç­”åˆ°ç‚¹ä¸Šï¼Œè¦ä¹ˆæ˜¯å›ç­”ä¸å¤Ÿæ·±å…¥ï¼Œæ‰€ä»¥ï¼Œå€ŸåŠ©æœ¬æ–‡ï¼Œæ·±å…¥è®²è§£C/C++å†…å­˜ç®¡ç†ã€‚

## 1 å†™åœ¨å‰é¢

æºç åˆ†ææœ¬èº«å°±å¾ˆæ¯ç‡¥ä¹å‘³ï¼Œå°¤å…¶æ˜¯è¦å°†å…¶å†™æˆé€šä¿—æ˜“æ‡‚çš„æ–‡ç« ï¼Œæ›´æ˜¯éš¾ä¸ŠåŠ éš¾ã€‚

æœ¬æ–‡å°½å¯èƒ½çš„ä»è¯»è€…è§’åº¦å»è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å†™å¤§å®¶å…³å¿ƒçš„ç‚¹ï¼Œå¿…è¦çš„æ—¶å€™ï¼Œä¼šè´´å‡ºéƒ¨åˆ†æºç ï¼Œä»¥åŠ æ·±å¤§å®¶çš„ç†è§£ï¼Œå°½å¯èƒ½çš„é€šè¿‡æœ¬æ–‡ï¼Œè®©å¤§å®¶ç†è§£å†…å­˜åˆ†é…é‡Šæ”¾çš„æœ¬è´¨åŸç†ã€‚

æ¥ä¸‹æ¥çš„å†…å®¹ï¼Œå¹²è´§æ»¡æ»¡ï¼Œå¯¹äºä½ æˆ‘éƒ½æ˜¯ä¸€æ¬¡æ”¶è·çš„è¿‡ç¨‹ã€‚ä¸»è¦ä»å†…å­˜å¸ƒå±€ã€glibcå†…å­˜ç®¡ç†ã€mallocå®ç°ä»¥åŠfreeå®ç°å‡ ä¸ªç‚¹æ¥å¸¦ä½ é¢†ç•¥glibcå†…å­˜ç®¡ç†ç²¾é«“ã€‚æœ€åï¼Œé’ˆå¯¹é¡¹ç›®ä¸­çš„é—®é¢˜ï¼ŒæŒ‡å‡ºäº†è§£å†³æ–¹æ¡ˆã€‚å¤§çº²å†…å®¹å¦‚ä¸‹ï¼š
![[Pasted image 20240914160557.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ä¸»è¦å†…å®¹

  

## 2 èƒŒæ™¯

å‡ å¹´å‰ï¼Œåœ¨ä¸Šå®¶å…¬å¸åšäº†ä¸€ä¸ªé¡¹ç›®ï¼Œæš‚ä¸”ç§°ä¹‹ä¸ºSeedServiceå§ã€‚SeedServiceä»kafkaè·å–feedæµçš„è½¬ã€è¯„ã€èµä¿¡æ¯ï¼ŒåŠ è½½åˆ°å†…å­˜ã€‚å› ä¸ºæ¯å¤©æ•°æ®ä¸ä¸€æ ·ï¼Œæ‰€ä»¥kafkaçš„topicä¹Ÿæ˜¯æŒ‰å¤©æ¥åˆ‡åˆ†ï¼Œæ•´ä¸ªserverå†…éƒ¨ï¼Œç±»ä¼¼äºåŒæŒ‡é’ˆå®ç°ï¼Œå½“å¤©0ç‚¹é‡Šæ”¾å¤´ä¸€å¤©çš„æ•°æ®ã€‚  

é¡¹ç›®ä¸Šçº¿ï¼Œä¸€åˆ‡è¿è¡Œæ­£å¸¸ã€‚

ä½†æ˜¯å‡ å¤©ä¹‹åï¼Œè¿›ç¨‹å¼€å§‹æ— ç¼˜æ— æ•…çš„æ¶ˆå¤±ã€‚å¼€å§‹å®šä½é—®é¢˜ï¼Œæœ€ç»ˆå‘ç°æ˜¯å› ä¸ºå†…å­˜æš´å¢å¯¼è‡´OOMï¼Œæœ€ç»ˆè¢«æ“ä½œç³»ç»Ÿkillæ‰ã€‚

å¼„æ¸…æ¥šäº†è¿›ç¨‹æ¶ˆå¤±çš„åŸå› ä¹‹åï¼Œå¼€å§‹ç€æ‰‹åˆ†æå†…å­˜æ³„æ¼ã€‚åœ¨è§£å†³äº†å‡ ä¸ªå†…å­˜æ³„éœ²çš„æ½œåœ¨é—®é¢˜ä»¥åï¼Œå‘ç°ç³»ç»Ÿåœ¨é«˜å‹åŠ›é«˜å¹¶å‘ç¯å¢ƒä¸‹é•¿æ—¶é—´è¿è¡Œä»ç„¶ä¼šå‘ç”Ÿå†…å­˜æš´å¢çš„ç°è±¡ï¼Œæœ€ç»ˆè¿›ç¨‹å› OOMè¢«æ“ä½œç³»ç»Ÿæ€æ‰ã€‚

ç”±äºå†…å­˜ç®¡ç†ä¸å¤–ä¹ä¸‰ä¸ªå±‚é¢ï¼Œç”¨æˆ·ç®¡ç†å±‚ï¼ŒC è¿è¡Œæ—¶åº“å±‚ï¼Œæ“ä½œç³»ç»Ÿå±‚ï¼Œåœ¨æ“ä½œç³»ç»Ÿå±‚å‘ç°è¿›ç¨‹çš„å†…å­˜æš´å¢ï¼ŒåŒæ—¶åˆç¡®è®¤äº†ç”¨æˆ·ç®¡ç†å±‚æ²¡æœ‰å†…å­˜æ³„éœ²ï¼Œå› æ­¤æ€€ç–‘æ˜¯ C è¿è¡Œæ—¶åº“çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯Glibc çš„å†…å­˜ç®¡ç†æ–¹å¼å¯¼è‡´äº†è¿›ç¨‹çš„å†…å­˜æš´å¢ã€‚

é—®é¢˜ç¼©å°åˆ°glibcçš„å†…å­˜ç®¡ç†æ–¹é¢ï¼ŒæŠŠä¸‹é¢å‡ ä¸ªé—®é¢˜å¼„æ¸…æ¥šï¼Œæ‰èƒ½è§£å†³SeedServiceè¿›ç¨‹æ¶ˆå¤±çš„é—®é¢˜ï¼š

- glibc åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¸ä¼šå°†å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Ÿ
    
- glibc çš„å†…å­˜ç®¡ç†æ–¹å¼æœ‰å“ªäº›çº¦æŸ?é€‚åˆä»€ä¹ˆæ ·çš„å†…å­˜åˆ†é…åœºæ™¯ï¼Ÿ
    
- æˆ‘ä»¬çš„ç³»ç»Ÿä¸­çš„å†…å­˜ç®¡ç†æ–¹å¼æ˜¯ä¸glibc çš„å†…å­˜ç®¡ç†çš„çº¦æŸç›¸æ‚–çš„ï¼Ÿ
    
- glibc æ˜¯å¦‚ä½•ç®¡ç†å†…å­˜çš„ï¼Ÿ
    

å¸¦ç€ä¸Šé¢è¿™äº›é—®é¢˜ï¼Œå¤§æ¦‚ç”¨äº†å°†è¿‘ä¸€ä¸ªæœˆçš„æ—¶é—´åˆ†æäº†glibcè¿è¡Œæ—¶åº“çš„å†…å­˜ç®¡ç†ä»£ç ï¼Œä»Šå¤©å°†å½“æ—¶çš„ç¬”è®°æ•´ç†äº†å‡ºæ¥ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹å¤§å®¶æœ‰ç”¨ã€‚

## 3 åŸºç¡€

Linux ç³»ç»Ÿåœ¨è£…è½½ elf æ ¼å¼çš„ç¨‹åºæ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ loader æŠŠå¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å„ä¸ªæ®µä¾æ¬¡è½½å…¥åˆ°ä»æŸä¸€åœ°å€å¼€å§‹çš„ç©ºé—´ä¸­ã€‚

ç”¨æˆ·ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥ç®¡ç† heap å’Œmmap æ˜ å°„åŒºåŸŸï¼Œä½†æ›´å¤šçš„æ—¶å€™ç¨‹åºéƒ½æ˜¯ä½¿ç”¨ C è¯­è¨€æä¾›çš„ malloc()å’Œ free()å‡½æ•°æ¥åŠ¨æ€çš„åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚stackåŒºåŸŸæ˜¯å”¯ä¸€ä¸éœ€è¦æ˜ å°„ï¼Œç”¨æˆ·å´å¯ä»¥è®¿é—®çš„å†…å­˜åŒºåŸŸï¼Œè¿™ä¹Ÿæ˜¯åˆ©ç”¨å †æ ˆæº¢å‡ºè¿›è¡Œæ”»å‡»çš„åŸºç¡€ã€‚

### 3.1 è¿›ç¨‹å†…å­˜å¸ƒå±€

è®¡ç®—æœºç³»ç»Ÿåˆ†ä¸º32ä½å’Œ64ä½ï¼Œè€Œ32ä½å’Œ64ä½çš„è¿›ç¨‹å¸ƒå±€æ˜¯ä¸ä¸€æ ·çš„ï¼Œå³ä½¿æ˜¯åŒä¸º32ä½ç³»ç»Ÿï¼Œå…¶å¸ƒå±€ä¾èµ–äºå†…æ ¸ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯ä¸åŒçš„ã€‚

åœ¨ä»‹ç»è¯¦ç»†çš„å†…å­˜å¸ƒå±€ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæè¿°å‡ ä¸ªæ¦‚å¿µï¼š

- æ ˆåŒºï¼ˆStackï¼‰â€” å­˜å‚¨ç¨‹åºæ‰§è¡ŒæœŸé—´çš„æœ¬åœ°å˜é‡å’Œå‡½æ•°çš„å‚æ•°ï¼Œä»é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿
    
- å †åŒºï¼ˆHeapï¼‰åŠ¨æ€å†…å­˜åˆ†é…åŒºåŸŸï¼Œé€šè¿‡ mallocã€newã€free å’Œ delete ç­‰å‡½æ•°ç®¡ç†
    
- æœªåˆå§‹åŒ–å˜é‡åŒºï¼ˆBSSï¼‰â€” å­˜å‚¨æœªè¢«åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡
    
- æ•°æ®åŒºï¼ˆDataï¼‰â€” å­˜å‚¨åœ¨æºä»£ç ä¸­æœ‰é¢„å®šä¹‰å€¼çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡
    
- ä»£ç åŒºï¼ˆTextï¼‰â€” å­˜å‚¨åªè¯»çš„ç¨‹åºæ‰§è¡Œä»£ç ï¼Œå³æœºå™¨æŒ‡ä»¤
    

#### 3.1.1 32ä½è¿›ç¨‹å†…å­˜å¸ƒå±€

###### ç»å…¸å¸ƒå±€

åœ¨Linuxå†…æ ¸2.6.7ä»¥å‰ï¼Œè¿›ç¨‹å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
![[Pasted image 20240914160612.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

32ä½ç»å…¸å¸ƒå±€

åœ¨è¯¥å†…å­˜å¸ƒå±€ç¤ºä¾‹å›¾ä¸­ï¼Œmmap åŒºåŸŸä¸æ ˆåŒºåŸŸç›¸å¯¹å¢é•¿ï¼Œè¿™æ„å‘³ç€å †åªæœ‰ 1GB çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¯ä»¥ä½¿ç”¨ï¼Œç»§ç»­å¢é•¿å°±ä¼šè¿›å…¥ mmap æ˜ å°„åŒºåŸŸï¼Œ è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚è¿™æ˜¯ç”±äº 32 æ¨¡å¼åœ°å€ç©ºé—´é™åˆ¶é€ æˆçš„ï¼Œæ‰€ä»¥å†…æ ¸å¼•å…¥äº†å¦ä¸€ç§è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€å½¢å¼ã€‚ä½†å¯¹äº 64 ä½ç³»ç»Ÿï¼Œå› ä¸ºæä¾›äº†å·¨å¤§çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ‰€ä»¥64ä½ç³»ç»Ÿå°±é‡‡ç”¨çš„è¿™ç§å¸ƒå±€æ–¹å¼ã€‚

###### é»˜è®¤å¸ƒå±€

å¦‚ä¸Šæ‰€ç¤ºï¼Œç”±äºç»å…¸å†…å­˜å¸ƒå±€å…·æœ‰ç©ºé—´å±€é™æ€§ï¼Œå› æ­¤åœ¨å†…æ ¸2.6.7ä»¥åï¼Œå°±å¼•å…¥äº†ä¸‹å›¾è¿™ç§é»˜è®¤è¿›ç¨‹å¸ƒå±€æ–¹å¼ã€‚
![[Pasted image 20240914160623.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

32ä½é»˜è®¤å¸ƒå±€

ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ ˆè‡³é¡¶å‘ä¸‹æ‰©å±•ï¼Œå¹¶ä¸”æ ˆæ˜¯æœ‰ç•Œçš„ã€‚å †è‡³åº•å‘ä¸Šæ‰©å±•ï¼Œmmap æ˜ å°„åŒºåŸŸè‡³é¡¶å‘ä¸‹æ‰©å±•ï¼Œmmap æ˜ å°„åŒºåŸŸå’Œå †ç›¸å¯¹æ‰©å±•ï¼Œç›´è‡³è€—å°½è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å‰©ä½™åŒºåŸŸï¼Œè¿™ç§ç»“æ„ä¾¿äºCè¿è¡Œæ—¶åº“ä½¿ç”¨ mmap æ˜ å°„åŒºåŸŸå’Œå †è¿›è¡Œå†…å­˜åˆ†é…ã€‚

#### 3.1.2 64ä½è¿›ç¨‹å†…å­˜å¸ƒå±€

å¦‚ä¹‹å‰æ‰€è¿°ï¼Œ64ä½è¿›ç¨‹å†…å­˜å¸ƒå±€æ–¹å¼ç”±äºå…¶åœ°å€ç©ºé—´è¶³å¤Ÿï¼Œä¸”å®ç°æ–¹ä¾¿ï¼Œæ‰€ä»¥é‡‡ç”¨çš„ä¸32ä½ç»å…¸å†…å­˜å¸ƒå±€çš„æ–¹å¼ä¸€è‡´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:
![[Pasted image 20240914160644.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

64ä½è¿›ç¨‹å¸ƒå±€

### 3.2 æ“ä½œç³»ç»Ÿå†…å­˜åˆ†é…å‡½æ•°

åœ¨ä¹‹å‰ä»‹ç»å†…å­˜å¸ƒå±€çš„æ—¶å€™ï¼Œæœ‰æåˆ°è¿‡ï¼Œheap å’Œmmap æ˜ å°„åŒºåŸŸæ˜¯å¯ä»¥æä¾›ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•è·å¾—è¯¥åŒºåŸŸçš„å†…å­˜å‘¢ï¼Ÿ

æ“ä½œç³»ç»Ÿæä¾›äº†ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆå†…å­˜åˆ†é…å·¥ä½œã€‚

- å¯¹äºheapçš„æ“ä½œï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†brk()å‡½æ•°ï¼Œcè¿è¡Œæ—¶åº“æä¾›äº†sbrk()å‡½æ•°ã€‚
    
- å¯¹äºmmapæ˜ å°„åŒºåŸŸçš„æ“ä½œï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†mmap()å’Œmunmap()å‡½æ•°ã€‚
    

sbrk()ï¼Œbrk() æˆ–è€… mmap() éƒ½å¯ä»¥ç”¨æ¥å‘æˆ‘ä»¬çš„è¿›ç¨‹æ·»åŠ é¢å¤–çš„è™šæ‹Ÿå†…å­˜ã€‚è€Œglibcå°±æ˜¯ä½¿ç”¨è¿™äº›å‡½æ•°æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œä»¥å®Œæˆå†…å­˜åˆ†é…çš„ã€‚

> â
> 
> è¿™é‡Œè¦æåˆ°ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå†…å­˜çš„å»¶è¿Ÿåˆ†é…ï¼Œåªæœ‰åœ¨çœŸæ­£è®¿é—®ä¸€ä¸ªåœ°å€çš„æ—¶å€™æ‰å»ºç«‹è¿™ä¸ªåœ°å€çš„ç‰©ç†æ˜ å°„ï¼Œè¿™æ˜¯ Linux å†…å­˜ç®¡ç†çš„åŸºæœ¬æ€æƒ³ä¹‹ä¸€ã€‚Linux å†…æ ¸åœ¨ç”¨æˆ·ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œåªæ˜¯ç»™å®ƒåˆ†é…äº†ä¸€ä¸ªçº¿æ€§åŒºï¼ˆä¹Ÿå°±æ˜¯è™šæ‹Ÿå†…å­˜ï¼‰ï¼Œå¹¶æ²¡æœ‰åˆ†é…å®é™…ç‰©ç†å†…å­˜ï¼›åªæœ‰å½“ç”¨æˆ·ä½¿ç”¨è¿™å—å†…å­˜çš„æ—¶å€™ï¼Œå†…æ ¸æ‰ä¼šåˆ†é…å…·ä½“çš„ç‰©ç†é¡µé¢ç»™ç”¨æˆ·ï¼Œè¿™æ—¶å€™æ‰å ç”¨å®è´µçš„ç‰©ç†å†…å­˜ã€‚å†…æ ¸é‡Šæ”¾ç‰©ç†é¡µé¢æ˜¯é€šè¿‡é‡Šæ”¾çº¿æ€§åŒºï¼Œæ‰¾åˆ°å…¶æ‰€å¯¹åº”çš„ç‰©ç†é¡µé¢ï¼Œå°†å…¶å…¨éƒ¨é‡Šæ”¾çš„è¿‡ç¨‹ã€‚
> 
> â
![[Pasted image 20240914160658.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å†…å­˜åˆ†é…

è¿›ç¨‹çš„å†…å­˜ç»“æ„ï¼Œåœ¨å†…æ ¸ä¸­ï¼Œæ˜¯ç”¨mm_structæ¥è¡¨ç¤ºçš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```c
structÂ mm_structÂ {Â ...Â unsignedÂ longÂ (*get_unmapped_area)Â (structÂ fileÂ *filp,Â unsignedÂ longÂ addr,Â unsignedÂ longÂ len,Â unsignedÂ longÂ pgoff,Â unsignedÂ longÂ flags);Â ...Â unsignedÂ longÂ mmap_base;Â /*Â baseÂ ofÂ mmapÂ areaÂ */Â unsignedÂ longÂ task_size;Â /*Â sizeÂ ofÂ taskÂ vmÂ spaceÂ */Â ...Â unsignedÂ longÂ start_code,Â end_code,Â start_data,Â end_data;Â unsignedÂ longÂ start_brk,Â brk,Â start_stack;Â unsignedÂ longÂ arg_start,Â arg_end,Â env_start,Â env_end;Â ...}
```

åœ¨ä¸Šè¿°mm_structç»“æ„ä¸­ï¼š

- [start_code,end_code)è¡¨ç¤ºä»£ç æ®µçš„åœ°å€ç©ºé—´èŒƒå›´ã€‚
    
- [start_data,end_start)è¡¨ç¤ºæ•°æ®æ®µçš„åœ°å€ç©ºé—´èŒƒå›´ã€‚
    
- [start_brk,brk)åˆ†åˆ«è¡¨ç¤ºheapæ®µçš„èµ·å§‹ç©ºé—´å’Œå½“å‰çš„heapæŒ‡é’ˆã€‚
    
- [start_stack,end_stack)è¡¨ç¤ºstackæ®µçš„åœ°å€ç©ºé—´èŒƒå›´ã€‚
    
- mmap_baseè¡¨ç¤ºmemory mappingæ®µçš„èµ·å§‹åœ°å€ã€‚
    

Cè¯­è¨€çš„åŠ¨æ€å†…å­˜åˆ†é…åŸºæœ¬å‡½æ•°æ˜¯ malloc()ï¼Œåœ¨ Linux ä¸Šçš„å®ç°æ˜¯é€šè¿‡å†…æ ¸çš„ brk ç³»ç»Ÿè°ƒç”¨ã€‚brk()æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ åªæ˜¯ç®€å•åœ°æ”¹å˜mm_structç»“æ„çš„æˆå‘˜å˜é‡ brk çš„å€¼ã€‚
![[Pasted image 20240914160709.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

mm_struct

#### 3.2.1 Heapæ“ä½œ

åœ¨å‰é¢æœ‰æè¿‡ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥ä»å †(Heap)ç”³è¯·å†…å­˜ï¼Œbrk()å‡½æ•°ä¸ºç³»ç»Ÿè°ƒç”¨ï¼Œsbrk()ä¸ºcåº“å‡½æ•°ã€‚

ç³»ç»Ÿè°ƒç”¨é€šå¸¸æè¿‡ä¸€ç§æœ€å°çš„åŠŸèƒ½ï¼Œè€Œåº“å‡½æ•°ç›¸æ¯”ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™æä¾›äº†æ›´å¤æ‚çš„åŠŸèƒ½ã€‚åœ¨glibcä¸­ï¼Œmallocå°±æ˜¯è°ƒç”¨sbrk()å‡½æ•°å°†æ•°æ®æ®µçš„ä¸‹ç•Œç§»åŠ¨ä»¥æ¥ä»£è¡¨å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚sbrk()å‡½æ•°åœ¨å†…æ ¸çš„ç®¡ç†ä¸‹ï¼Œå°†è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„åˆ°å†…å­˜ï¼Œä¾›malloc()å‡½æ•°ä½¿ç”¨ã€‚

ä¸‹é¢ä¸ºbrk()å‡½æ•°å’Œsbrk()å‡½æ•°çš„å£°æ˜ã€‚

```c
#includeÂ <unistd.h>
intÂ brk(voidÂ *addr);voidÂ *sbrk(intptr_tÂ increment);
```

> â
> 
> éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå½“sbrk()çš„å‚æ•°incrementä¸º0æ—¶å€™ï¼Œsbrk()è¿”å›çš„æ˜¯è¿›ç¨‹å½“å‰brkå€¼ã€‚increment ä¸ºæ­£æ•°æ—¶æ‰©å±• brk å€¼ï¼Œå½“ increment ä¸ºè´Ÿå€¼æ—¶æ”¶ç¼© brk å€¼ã€‚
> 
> â

#### 3.2.2 MMapæ“ä½œ

åœ¨LINUXä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨mmapç”¨æ¥åœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ä¸­åˆ†é…åœ°å€ç©ºé—´ï¼Œåˆ›å»ºå’Œç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ã€‚
![[Pasted image 20240914160730.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

å…±äº«å†…å­˜

mmap()å‡½æ•°å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„è¿›å†…å­˜ã€‚æ–‡ä»¶è¢«æ˜ å°„åˆ°å¤šä¸ªé¡µä¸Šï¼Œå¦‚æœæ–‡ä»¶çš„å¤§å°ä¸æ˜¯æ‰€æœ‰é¡µçš„å¤§å°ä¹‹å’Œï¼Œæœ€åä¸€ä¸ªé¡µä¸è¢«ä½¿ç”¨çš„ç©ºé—´å°†ä¼šæ¸…é›¶ã€‚

munmap æ‰§è¡Œç›¸åçš„æ“ä½œï¼Œåˆ é™¤ç‰¹å®šåœ°å€åŒºåŸŸçš„å¯¹è±¡æ˜ å°„ã€‚

å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š

```c
#includeÂ <sys/mman.h>
voidÂ *mmap(voidÂ *addr,Â size_tÂ length,Â intÂ prot,Â intÂ flags,Â intÂ fd,Â off_tÂ offset);Â intÂ munmap(voidÂ *addr,Â size_tÂ length);
```

Â·æ˜ å°„å…³ç³»åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š

- æ–‡ä»¶æ˜ å°„: ç£ç›˜æ–‡ä»¶æ˜ å°„è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½¿ç”¨æ–‡ä»¶å†…å®¹åˆå§‹åŒ–ç‰©ç†å†…å­˜ã€‚
    
- åŒ¿åæ˜ å°„: åˆå§‹åŒ–å…¨ä¸º0çš„å†…å­˜ç©ºé—´
    

æ˜ å°„å…³ç³»æ˜¯å¦å…±äº«ï¼Œå¯ä»¥åˆ†ä¸º:

- ç§æœ‰æ˜ å°„(MAP_PRIVATE)
    

- å¤šè¿›ç¨‹é—´æ•°æ®å…±äº«ï¼Œä¿®æ”¹ä¸ååº”åˆ°ç£ç›˜å®é™…æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªcopy-on-writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰çš„æ˜ å°„æ–¹å¼ã€‚
    

- å…±äº«æ˜ å°„(MAP_SHARED)
    

- å¤šè¿›ç¨‹é—´æ•°æ®å…±äº«ï¼Œä¿®æ”¹ååº”åˆ°ç£ç›˜å®é™…æ–‡ä»¶ä¸­ã€‚
    

å› æ­¤ï¼Œæ•´ä¸ªæ˜ å°„å…³ç³»æ€»ç»“èµ·æ¥åˆ†ä¸ºä»¥ä¸‹å››ç§:

- ç§æœ‰æ–‡ä»¶æ˜ å°„å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒæ ·çš„ç‰©ç†å†…å­˜é¡µè¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯å„ä¸ªè¿›ç¨‹å¯¹å†…å­˜æ–‡ä»¶çš„ä¿®æ”¹ä¸ä¼šå…±äº«ï¼Œä¹Ÿä¸ä¼šååº”åˆ°ç‰©ç†æ–‡ä»¶ä¸­
    
- ç§æœ‰åŒ¿åæ˜ å°„
    

- mmapä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„ï¼Œå„ä¸ªè¿›ç¨‹ä¸å…±äº«ï¼Œè¿™ç§ä½¿ç”¨ä¸»è¦ç”¨äºåˆ†é…å†…å­˜(mallocåˆ†é…å¤§å†…å­˜ä¼šè°ƒç”¨mmap)ã€‚ä¾‹å¦‚å¼€è¾Ÿæ–°è¿›ç¨‹æ—¶ï¼Œä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…è™šæ‹Ÿçš„åœ°å€ç©ºé—´ï¼Œè¿™äº›è™šæ‹Ÿåœ°å€æ˜ å°„çš„ç‰©ç†å†…å­˜ç©ºé—´å„ä¸ªè¿›ç¨‹é—´è¯»çš„æ—¶å€™å…±äº«ï¼Œå†™çš„æ—¶å€™ä¼šcopy-on-writeã€‚
    

- å…±äº«æ–‡ä»¶æ˜ å°„
    

- å¤šä¸ªè¿›ç¨‹é€šè¿‡è™šæ‹Ÿå†…å­˜æŠ€æœ¯å…±äº«åŒæ ·çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå¯¹å†…å­˜æ–‡ä»¶çš„ä¿®æ”¹ä¼šååº”åˆ°å®é™…ç‰©ç†æ–‡ä»¶ä¸­ï¼Œä¹Ÿæ˜¯è¿›ç¨‹é—´é€šä¿¡(IPC)çš„ä¸€ç§æœºåˆ¶ã€‚
    

- å…±äº«åŒ¿åæ˜ å°„
    

- è¿™ç§æœºåˆ¶åœ¨è¿›è¡Œforkçš„æ—¶å€™ä¸ä¼šé‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼Œçˆ¶å­è¿›ç¨‹å®Œå…¨å…±äº«åŒæ ·çš„ç‰©ç†å†…å­˜é¡µï¼Œè¿™ä¹Ÿå°±å®ç°äº†çˆ¶å­è¿›ç¨‹é€šä¿¡(IPC)ã€‚
    

è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œmmapåªæ˜¯åœ¨è™šæ‹Ÿå†…å­˜åˆ†é…äº†åœ°å€ç©ºé—´ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿå†…å­˜çš„æ—¶å€™æ‰åˆ†é…ç‰©ç†å†…å­˜ã€‚

åœ¨mmapä¹‹åï¼Œå¹¶æ²¡æœ‰åœ¨å°†æ–‡ä»¶å†…å®¹åŠ è½½åˆ°ç‰©ç†é¡µä¸Šï¼Œåªæœ‰åœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…äº†åœ°å€ç©ºé—´ã€‚å½“è¿›ç¨‹åœ¨è®¿é—®è¿™æ®µåœ°å€æ—¶ï¼Œé€šè¿‡æŸ¥æ‰¾é¡µè¡¨ï¼Œå‘ç°è™šæ‹Ÿå†…å­˜å¯¹åº”çš„é¡µæ²¡æœ‰åœ¨ç‰©ç†å†…å­˜ä¸­ç¼“å­˜ï¼Œåˆ™äº§ç”Ÿ"ç¼ºé¡µ"ï¼Œç”±å†…æ ¸çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºå¤„ç†ï¼Œå°†æ–‡ä»¶å¯¹åº”å†…å®¹ï¼Œä»¥é¡µä¸ºå•ä½(4096)åŠ è½½åˆ°ç‰©ç†å†…å­˜ï¼Œæ³¨æ„æ˜¯åªåŠ è½½ç¼ºé¡µï¼Œä½†ä¹Ÿä¼šå—æ“ä½œç³»ç»Ÿä¸€äº›è°ƒåº¦ç­–ç•¥å½±å“ï¼ŒåŠ è½½çš„æ¯”æ‰€éœ€çš„å¤šã€‚

> â
> 
> ä¸‹é¢çš„å†…å®¹å°†æ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¸­çš„é‡ç‚¹ï¼Œå¯¹äºäº†è§£å†…å­˜å¸ƒå±€ä»¥åŠåé¢glibcçš„å†…å­˜åˆ†é…åŸç†è‡³å…³é‡è¦ï¼Œå¿…è¦çš„è¯ï¼Œå¯ä»¥å¤šé˜…è¯»å‡ æ¬¡ã€‚
> 
> â

## 4 æ¦‚è¿°

åœ¨å‰é¢ï¼Œæˆ‘ä»¬æœ‰æåˆ°åœ¨å †ä¸Šåˆ†é…å†…å­˜æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ä¸ºbrk()ç³»ç»Ÿè°ƒç”¨å’Œsbrk()cè¿è¡Œæ—¶åº“å‡½æ•°ï¼Œåœ¨å†…å­˜æ˜ å°„åŒºåˆ†é…å†…å­˜æœ‰mmapå‡½æ•°ã€‚

ç°åœ¨æˆ‘ä»¬å‡è®¾ä¸€ç§æƒ…å†µï¼Œå¦‚æœæ¯æ¬¡åˆ†é…ï¼Œéƒ½ç›´æ¥ä½¿ç”¨brk(),sbrk()æˆ–è€…mmap()å‡½æ•°è¿›è¡Œå¤šæ¬¡å†…å­˜åˆ†é…ã€‚å¦‚æœç¨‹åºé¢‘ç¹çš„è¿›è¡Œå†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œéƒ½æ˜¯å’Œæ“ä½œç³»ç»Ÿç›´æ¥æ‰“äº¤é“ï¼Œé‚£ä¹ˆæ€§èƒ½å¯æƒ³è€ŒçŸ¥ã€‚

è¿™å°±å¼•å…¥äº†ä¸€ä¸ªæ¦‚å¿µï¼Œã€Œå†…å­˜ç®¡ç†ã€ã€‚

æœ¬èŠ‚å¤§çº²å¦‚ä¸‹ï¼š
![[Pasted image 20240914160821.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

### 4.1 å†…å­˜ç®¡ç†

å†…å­˜ç®¡ç†æ˜¯æŒ‡è½¯ä»¶è¿è¡Œæ—¶å¯¹è®¡ç®—æœºå†…å­˜èµ„æºçš„åˆ†é…å’Œä½¿ç”¨çš„æŠ€æœ¯ã€‚å…¶æœ€ä¸»è¦çš„ç›®çš„æ˜¯å¦‚ä½•é«˜æ•ˆï¼Œå¿«é€Ÿçš„åˆ†é…ï¼Œå¹¶ä¸”åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾å’Œå›æ”¶å†…å­˜èµ„æºã€‚

ä¸€ä¸ªå¥½çš„å†…å­˜ç®¡ç†å™¨ï¼Œéœ€è¦å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š1ã€è·¨å¹³å°ã€å¯ç§»æ¤é€šå¸¸æƒ…å†µä¸‹ï¼Œå†…å­˜ç®¡ç†å™¨å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åè¿›è¡Œå†æ¬¡åˆ†é…ã€‚æ‰€ä»¥ï¼Œé’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œå†…å­˜ç®¡ç†å™¨å°±éœ€è¦æ”¯æŒæ“ä½œç³»ç»Ÿå…¼å®¹ï¼Œè®©ä½¿ç”¨è€…åœ¨è·¨å¹³å°çš„æ“ä½œä¸Šæ²¡æœ‰åŒºåˆ«ã€‚

2ã€æµªè´¹ç©ºé—´å°å†…å­˜ç®¡ç†å™¨ç®¡ç†å†…å­˜ï¼Œå¦‚æœå†…å­˜æµªè´¹æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™å°±ä¸æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å†…å­˜ç®¡ç†å™¨ã€‚é€šå¸¸è¯´çš„å†…å­˜ç¢ç‰‡ï¼Œå°±æ˜¯æµªè´¹ç©ºé—´çš„ç½ªé­ç¥¸é¦–ï¼Œè‹¥å†…å­˜ç®¡ç†å™¨ä¸­æœ‰å¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼Œå®ƒä»¬æ˜¯ä¸€äº›ä¸è¿ç»­çš„å°å—å†…å­˜ï¼Œå®ƒä»¬æ€»é‡å¯èƒ½å¾ˆå¤§ï¼Œä½†æ— æ³•ä½¿ç”¨ï¼Œè¿™æ˜¾ç„¶ä¹Ÿä¸æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å†…å­˜ç®¡ç†å™¨ã€‚

3ã€é€Ÿåº¦å¿«ä¹‹æ‰€ä»¥ä½¿ç”¨å†…å­˜ç®¡ç†å™¨ï¼Œæ ¹æœ¬åŸå› å°±æ˜¯ä¸ºäº†åˆ†é…/é‡Šæ”¾å¿«ã€‚

4ã€è°ƒè¯•åŠŸèƒ½ä½œä¸ºä¸€ä¸ª C/C++ç¨‹åºå‘˜ï¼Œå†…å­˜é”™è¯¯å¯ä»¥è¯´æ˜¯æˆ‘ä»¬çš„å™©æ¢¦ï¼Œä¸Šä¸€æ¬¡çš„å†…å­˜é”™è¯¯ä¸€å®šè¿˜è®©ä½ è®°å¿†çŠ¹æ–°ã€‚å†…å­˜ç®¡ç†å™¨æä¾›çš„è°ƒè¯•åŠŸèƒ½ï¼Œå¼ºå¤§æ˜“ç”¨ï¼Œç‰¹åˆ«å¯¹äºåµŒå…¥å¼ç¯å¢ƒæ¥è¯´ï¼Œå†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·ç¼ºä¹ï¼Œå†…å­˜ç®¡ç†å™¨æä¾›çš„è°ƒè¯•åŠŸèƒ½å°±æ›´æ˜¯ä¸å¯æˆ–ç¼ºäº†ã€‚

### 4.2 ç®¡ç†æ–¹å¼

å†…å­˜ç®¡ç†çš„ç®¡ç†æ–¹å¼ï¼Œåˆ†ä¸ºÂ æ‰‹åŠ¨ç®¡ç†Â å’ŒÂ è‡ªåŠ¨ç®¡ç†Â ä¸¤ç§ã€‚

æ‰€è°“çš„æ‰‹åŠ¨ç®¡ç†ï¼Œå°±æ˜¯ä½¿ç”¨è€…åœ¨ç”³è¯·å†…å­˜çš„æ—¶å€™ä½¿ç”¨mallocç­‰å‡½æ•°è¿›è¡Œç”³è¯·ï¼Œåœ¨éœ€è¦é‡Šæ”¾çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨freeå‡½æ•°è¿›è¡Œé‡Šæ”¾ã€‚ä¸€æ—¦ç”¨è¿‡çš„å†…å­˜æ²¡æœ‰é‡Šæ”¾ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œå ç”¨æ›´å¤šçš„ç³»ç»Ÿå†…å­˜ï¼›å¦‚æœåœ¨ä½¿ç”¨ç»“æŸå‰é‡Šæ”¾ï¼Œä¼šå¯¼è‡´å±é™©çš„æ‚¬æŒ‚æŒ‡é’ˆï¼Œå…¶ä»–å¯¹è±¡æŒ‡å‘çš„å†…å­˜å·²ç»è¢«ç³»ç»Ÿå›æ”¶æˆ–è€…é‡æ–°ä½¿ç”¨ã€‚

è‡ªåŠ¨ç®¡ç†å†…å­˜ç”±ç¼–ç¨‹è¯­è¨€çš„å†…å­˜ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ä½¿ç”¨è€…çš„å‚ä¸ï¼Œèƒ½å¤Ÿè‡ªåŠ¨é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚

#### 4.2.1 æ‰‹åŠ¨ç®¡ç†

æ‰‹åŠ¨ç®¡ç†å†…å­˜æ˜¯ä¸€ç§æ¯”è¾ƒä¼ ç»Ÿçš„å†…å­˜ç®¡ç†æ–¹å¼ï¼ŒC/C++ è¿™ç±»ç³»ç»Ÿçº§çš„ç¼–ç¨‹è¯­è¨€ä¸åŒ…å«ç‹­ä¹‰ä¸Šçš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä½¿ç”¨è€…éœ€è¦ä¸»åŠ¨ç”³è¯·æˆ–è€…é‡Šæ”¾å†…å­˜ã€‚ç»éªŒä¸°å¯Œçš„å·¥ç¨‹å¸ˆèƒ½å¤Ÿç²¾å‡†çš„ç¡®å®šå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ—¶æœºï¼Œäººè‚‰çš„å†…å­˜ç®¡ç†ç­–ç•¥åªè¦åšåˆ°è¶³å¤Ÿç²¾å‡†ï¼Œä½¿ç”¨æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„æ–¹å¼å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ€§èƒ½ï¼Œä¹Ÿä¸ä¼šé€ æˆå†…å­˜å®‰å…¨é—®é¢˜ã€‚

ä½†æ˜¯ï¼Œæ¯•ç«Ÿè¿™ç§ç»éªŒä¸°å¯Œä¸”èƒ½ç²¾å‡†ç¡®å®šå†…å­˜å’Œåˆ†é…é‡Šæ”¾å®é™…çš„ä½¿ç”¨è€…è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œåªè¦æ˜¯äººå·¥å¤„ç†ï¼Œæ€»ä¼šå¸¦æ¥ä¸€äº›é”™è¯¯ï¼Œå†…å­˜æ³„æ¼å’Œæ‚¬æŒ‚æŒ‡é’ˆåŸºæœ¬æ˜¯ C/C++ è¿™ç±»è¯­è¨€ä¸­æœ€å¸¸å‡ºç°çš„é”™è¯¯ï¼Œæ‰‹åŠ¨çš„å†…å­˜ç®¡ç†ä¹Ÿä¼šå ç”¨å·¥ç¨‹å¸ˆçš„å¤§é‡ç²¾åŠ›ï¼Œå¾ˆå¤šæ—¶å€™éƒ½éœ€è¦æ€è€ƒå¯¹è±¡åº”è¯¥åˆ†é…åˆ°æ ˆä¸Šè¿˜æ˜¯å †ä¸Šä»¥åŠå †ä¸Šçš„å†…å­˜åº”è¯¥ä½•æ—¶é‡Šæ”¾ï¼Œç»´æŠ¤æˆæœ¬ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè¿™ä¹Ÿæ˜¯å¿…ç„¶è¦åšçš„æƒè¡¡ã€‚

#### 4.2.2 è‡ªåŠ¨ç®¡ç†

è‡ªåŠ¨ç®¡ç†å†…å­˜åŸºæœ¬æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€çš„æ ‡é…ï¼Œå› ä¸ºå†…å­˜ç®¡ç†æ¨¡å—çš„åŠŸèƒ½éå¸¸ç¡®å®šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘æœŸæˆ–è€…è¿è¡Œæ—¶ä¸­å¼•å…¥è‡ªåŠ¨çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼Œæœ€å¸¸è§çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶å°±æ˜¯åƒåœ¾å›æ”¶ï¼Œä¸è¿‡é™¤äº†åƒåœ¾å›æ”¶ä¹‹å¤–ï¼Œä¸€äº›ç¼–ç¨‹è¯­è¨€ä¹Ÿä¼šä½¿ç”¨è‡ªåŠ¨å¼•ç”¨è®¡æ•°è¾…åŠ©å†…å­˜çš„ç®¡ç†ã€‚

è‡ªåŠ¨çš„å†…å­˜ç®¡ç†æœºåˆ¶å¯ä»¥å¸®åŠ©å·¥ç¨‹å¸ˆèŠ‚çœå¤§é‡çš„ä¸å†…å­˜æ‰“äº¤é“çš„æ—¶é—´ï¼Œè®©ä½¿ç”¨è€…å°†å…¨éƒ¨çš„ç²¾åŠ›éƒ½æ”¾åœ¨æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ä¸Šï¼Œæé«˜å¼€å‘çš„æ•ˆç‡ï¼›åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ç§è‡ªåŠ¨çš„å†…å­˜ç®¡ç†æœºåˆ¶éƒ½å¯ä»¥å¾ˆå¥½åœ°è§£å†³å†…å­˜æ³„æ¼å’Œæ‚¬æŒ‚æŒ‡é’ˆçš„é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¹Ÿä¼šå¸¦æ¥é¢å¤–å¼€é”€å¹¶å½±å“è¯­è¨€çš„è¿è¡Œæ—¶æ€§èƒ½ã€‚

### 4.1 å¸¸è§çš„å†…å­˜ç®¡ç†å™¨

1 ptmallocï¼šptmallocæ˜¯éš¶å±äºglibc(GNU Libc)çš„ä¸€æ¬¾å†…å­˜åˆ†é…å™¨ï¼Œç°åœ¨åœ¨Linuxç¯å¢ƒä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨çš„è¿è¡Œåº“çš„å†…å­˜åˆ†é…(malloc/new)å’Œé‡Šæ”¾(free/delete)å°±æ˜¯ç”±å…¶æä¾›ã€‚

2 BSD Mallocï¼šBSD Malloc æ˜¯éš 4.2 BSD å‘è¡Œçš„å®ç°ï¼ŒåŒ…å«åœ¨ FreeBSD ä¹‹ä¸­ï¼Œè¿™ä¸ªåˆ†é…ç¨‹åºå¯ä»¥ä»é¢„å…ˆç¡®å®å¤§å°çš„å¯¹è±¡æ„æˆçš„æ± ä¸­åˆ†é…å¯¹è±¡ã€‚å®ƒæœ‰ä¸€äº›ç”¨äºå¯¹è±¡å¤§å°çš„size ç±»ï¼Œè¿™äº›å¯¹è±¡çš„å¤§å°ä¸º 2 çš„è‹¥å¹²æ¬¡å¹‚å‡å»æŸä¸€å¸¸æ•°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ‚¨è¯·æ±‚ç»™å®šå¤§å°çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå°±ç®€å•åœ°åˆ†é…ä¸€ä¸ªä¸ä¹‹åŒ¹é…çš„ size ç±»ã€‚è¿™æ ·å°±æä¾›äº†ä¸€ä¸ªå¿«é€Ÿçš„å®ç°ï¼Œä½†æ˜¯å¯èƒ½ä¼šæµªè´¹å†…å­˜ã€‚

3 Hoardï¼šç¼–å†™ Hoard çš„ç›®æ ‡æ˜¯ä½¿å†…å­˜åˆ†é…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¿›è¡Œå¾—éå¸¸å¿«ã€‚å› æ­¤ï¼Œå®ƒçš„æ„é€ ä»¥é”çš„ä½¿ç”¨ä¸ºä¸­å¿ƒï¼Œä»è€Œä½¿æ‰€æœ‰è¿›ç¨‹ä¸å¿…ç­‰å¾…åˆ†é…å†…å­˜ã€‚å®ƒå¯ä»¥æ˜¾è‘—åœ°åŠ å¿«é‚£äº›è¿›è¡Œå¾ˆå¤šåˆ†é…å’Œå›æ”¶çš„å¤šçº¿ç¨‹è¿›ç¨‹çš„é€Ÿåº¦ã€‚

4 TCMallocï¼šGoogle å¼€å‘çš„å†…å­˜åˆ†é…å™¨ï¼Œåœ¨ä¸å°‘é¡¹ç›®ä¸­éƒ½æœ‰ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨ Golang ä¸­å°±ä½¿ç”¨äº†ç±»ä¼¼çš„ç®—æ³•è¿›è¡Œå†…å­˜åˆ†é…ã€‚å®ƒå…·æœ‰ç°ä»£åŒ–å†…å­˜åˆ†é…å™¨çš„åŸºæœ¬ç‰¹å¾ï¼šå¯¹æŠ—å†…å­˜ç¢ç‰‡ã€åœ¨å¤šæ ¸å¤„ç†å™¨èƒ½å¤Ÿ scaleã€‚æ®ç§°ï¼Œå®ƒçš„å†…å­˜åˆ†é…é€Ÿåº¦æ˜¯ glibc2.3 ä¸­å®ç°çš„ mallocçš„æ•°å€ã€‚

## 5 glibcä¹‹å†…å­˜ç®¡ç†(ptmalloc)

å› ä¸ºæœ¬æ¬¡äº‹æ•…å°±æ˜¯ç”¨çš„è¿è¡Œåº“å‡½æ•°new/deleteè¿›è¡Œçš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œæ‰€ä»¥æœ¬æ–‡å°†ç€é‡åˆ†æglibcä¸‹çš„å†…å­˜åˆ†é…åº“ptmallocã€‚

æœ¬èŠ‚å¤§çº²å¦‚ä¸‹ï¼š
![[Pasted image 20240914160834.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

åœ¨c/c++ä¸­ï¼Œæˆ‘ä»¬åˆ†é…å†…å­˜æ˜¯åœ¨å †ä¸Šè¿›è¡Œåˆ†é…ï¼Œé‚£ä¹ˆè¿™ä¸ªå †ï¼Œåœ¨glibcä¸­æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„å‘¢ï¼Ÿ

æˆ‘ä»¬å…ˆçœ‹ä¸‹å †çš„ç»“æ„å£°æ˜:

```c
typedefÂ structÂ _heap_info{Â Â mstateÂ ar_ptr;Â Â Â Â Â Â Â Â Â Â Â Â /*Â ArenaÂ forÂ thisÂ heap.Â */Â Â structÂ _heap_infoÂ *prev;Â Â /*Â PreviousÂ heap.Â */Â Â size_tÂ size;Â Â Â Â Â Â Â Â Â Â Â Â Â Â /*Â CurrentÂ sizeÂ inÂ bytes.Â */Â Â size_tÂ mprotect_size;Â Â Â Â Â /*Â SizeÂ inÂ bytesÂ thatÂ hasÂ beenÂ mprotectedÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â PROT_READ|PROT_WRITE.Â Â */Â Â /*Â MakeÂ sureÂ theÂ followingÂ dataÂ isÂ properlyÂ aligned,Â particularlyÂ Â Â Â Â thatÂ sizeofÂ (heap_info)Â +Â 2Â *Â SIZE_SZÂ isÂ aÂ multipleÂ ofÂ Â Â Â Â MALLOC_ALIGNMENT.Â */Â Â charÂ pad[-6Â *Â SIZE_SZÂ &Â MALLOC_ALIGN_MASK];
```

åœ¨å †çš„ä¸Šè¿°å®šä¹‰ä¸­ï¼Œar_ptræ˜¯æŒ‡å‘åˆ†é…åŒºçš„æŒ‡é’ˆï¼Œå †ä¹‹é—´æ˜¯ä»¥é“¾è¡¨æ–¹å¼è¿›è¡Œè¿æ¥ï¼Œåé¢æˆ‘ä¼šè¯¦ç»†è®²è¿°è¿›ç¨‹å¸ƒå±€ä¸‹ï¼Œå †çš„ç»“æ„è¡¨ç¤ºå›¾ã€‚

åœ¨å¼€å§‹è¿™éƒ¨åˆ†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä¸€äº›æ¦‚å¿µã€‚

### 5.1 åˆ†é…åŒº(arena)

> â
> 
> ptmallocå¯¹è¿›ç¨‹å†…å­˜æ˜¯é€šè¿‡ä¸€ä¸ªä¸ªArenaæ¥è¿›è¡Œç®¡ç†çš„ã€‚
> 
> â

åœ¨ptmallocä¸­ï¼Œåˆ†é…åŒºåˆ†ä¸ºä¸»åˆ†é…åŒº(arena)å’Œéä¸»åˆ†é…åŒº(narena)ï¼Œåˆ†é…åŒºç”¨struct malloc_stateæ¥è¡¨ç¤ºã€‚ä¸»åˆ†é…åŒºå’Œéä¸»åˆ†é…åŒºçš„åŒºåˆ«æ˜¯Â ä¸»åˆ†é…åŒºå¯ä»¥ä½¿ç”¨sbrkå’Œmmapå‘osç”³è¯·å†…å­˜ï¼Œè€Œéåˆ†é…åŒºåªèƒ½é€šè¿‡mmapå‘osç”³è¯·å†…å­˜ã€‚

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨mallocç”³è¯·å†…å­˜æ—¶ï¼Œè¯¥çº¿ç¨‹å…ˆæŸ¥çœ‹çº¿ç¨‹ç§æœ‰å˜é‡ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªåˆ†é…åŒºã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™å¯¹è¯¥åˆ†é…åŒºåŠ é”ï¼ŒåŠ é”æˆåŠŸçš„è¯å°±ç”¨è¯¥åˆ†é…åŒºè¿›è¡Œå†…å­˜åˆ†é…ï¼›å¤±è´¥çš„è¯åˆ™æœç´¢ç¯å½¢é“¾è¡¨æ‰¾ä¸€ä¸ªæœªåŠ é”çš„åˆ†é…åŒºã€‚å¦‚æœæ‰€æœ‰åˆ†é…åŒºéƒ½å·²ç»åŠ é”ï¼Œé‚£ä¹ˆmallocä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„åˆ†é…åŒºåŠ å…¥ç¯å½¢é“¾è¡¨å¹¶åŠ é”ï¼Œç”¨å®ƒæ¥åˆ†é…å†…å­˜ã€‚é‡Šæ”¾æ“ä½œåŒæ ·éœ€è¦è·å¾—é”æ‰èƒ½è¿›è¡Œã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéä¸»åˆ†é…åŒºæ˜¯é€šè¿‡mmapå‘osç”³è¯·å†…å­˜ï¼Œä¸€æ¬¡ç”³è¯·64MBï¼Œä¸€æ—¦ç”³è¯·äº†ï¼Œè¯¥åˆ†é…åŒºå°±ä¸ä¼šè¢«é‡Šæ”¾ï¼Œä¸ºäº†é¿å…èµ„æºæµªè´¹ï¼Œptmallocå¯¹åˆ†é…åŒºæ˜¯æœ‰ä¸ªæ•°é™åˆ¶çš„ã€‚

> â
> 
> å¯¹äº32ä½ç³»ç»Ÿï¼Œåˆ†é…åŒºæœ€å¤§ä¸ªæ•° = 2 * CPUæ ¸æ•° + 1
> 
> å¯¹äº64ä½ç³»ç»Ÿï¼Œåˆ†é…åŒºæœ€å¤§ä¸ªæ•° = 8 * CPUæ ¸æ•° + 1
> 
> â

å †ç®¡ç†ç»“æ„ï¼š

```c
structÂ malloc_stateÂ {Â mutex_tÂ mutex;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â /*Â SerializeÂ access.Â */Â intÂ flags;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â /*Â FlagsÂ (formerlyÂ inÂ max_fast).Â */Â #ifÂ THREAD_STATSÂ /*Â StatisticsÂ forÂ locking.Â OnlyÂ usedÂ ifÂ THREAD_STATSÂ isÂ defined.Â */Â longÂ stat_lock_direct,Â stat_lock_loop,Â stat_lock_wait;Â #endifÂ mfastbinptrÂ fastbins[NFASTBINS];Â Â Â Â /*Â FastbinsÂ */Â mchunkptrÂ top;Â mchunkptrÂ last_remainder;Â mchunkptrÂ bins[NBINSÂ *Â 2];Â unsignedÂ intÂ binmap[BINMAPSIZE];Â Â Â /*Â BitmapÂ ofÂ binsÂ */Â structÂ malloc_stateÂ *next;Â Â Â Â Â Â Â Â Â Â Â /*Â LinkedÂ listÂ */Â INTERNAL_SIZE_TÂ system_mem;Â INTERNAL_SIZE_TÂ max_system_mem;Â };
```
![[Pasted image 20240914160902.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

malloc_state

æ¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªä¸»åˆ†é…åŒºå’Œè‹¥å¹²ä¸ªéä¸»åˆ†é…åŒºã€‚ä¸»åˆ†é…åŒºç”±mainçº¿ç¨‹æˆ–è€…ç¬¬ä¸€ä¸ªçº¿ç¨‹æ¥åˆ›å»ºæŒæœ‰ã€‚ä¸»åˆ†é…åŒºå’Œéä¸»åˆ†é…åŒºç”¨ç¯å½¢é“¾è¡¨è¿æ¥èµ·æ¥ã€‚åˆ†é…åŒºå†…æœ‰ä¸€ä¸ªå˜é‡mutexä»¥æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ã€‚
![[Pasted image 20240914160924.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ç¯å½¢é“¾è¡¨é“¾æ¥çš„åˆ†é…åŒº

åœ¨å‰é¢æœ‰æåˆ°ï¼Œåœ¨æ¯ä¸ªåˆ†é…åŒºä¸­éƒ½æœ‰ä¸€ä¸ªå˜é‡mutexæ¥æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ã€‚æ¯ä¸ªçº¿ç¨‹ä¸€å®šå¯¹åº”ä¸€ä¸ªåˆ†é…åŒºï¼Œä½†æ˜¯ä¸€ä¸ªåˆ†é…åŒºå¯ä»¥ç»™å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ŒåŒæ—¶ä¸€ä¸ªåˆ†é…åŒºå¯ä»¥ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªçš„å †ç»„æˆï¼ŒåŒä¸€ä¸ªåˆ†é…åŒºä¸‹çš„å †ä»¥é“¾è¡¨æ–¹å¼è¿›è¡Œè¿æ¥ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š
![[Pasted image 20240914161039.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

çº¿ç¨‹-åˆ†é…åŒº-å †

ä¸€ä¸ªè¿›ç¨‹çš„åŠ¨æ€å†…å­˜ï¼Œç”±åˆ†é…åŒºç®¡ç†ï¼Œä¸€ä¸ªè¿›ç¨‹å†…æœ‰å¤šä¸ªåˆ†é…åŒºï¼Œä¸€ä¸ªåˆ†é…åŒºæœ‰å¤šä¸ªå †ï¼Œè¿™å°±ç»„æˆäº†å¤æ‚çš„è¿›ç¨‹å†…å­˜ç®¡ç†ç»“æ„ã€‚
![[Pasted image 20240914161047.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

éœ€è¦æ³¨æ„å‡ ä¸ªç‚¹ï¼š

- ä¸»åˆ†é…åŒºé€šè¿‡brkè¿›è¡Œåˆ†é…ï¼Œéä¸»åˆ†é…åŒºé€šè¿‡mmapè¿›è¡Œåˆ†é…
    
- éä¸»åˆ†é…åŒºè™½ç„¶æ˜¯mmapåˆ†é…ï¼Œä½†æ˜¯å’Œå¤§äº128Kç›´æ¥ä½¿ç”¨mmapåˆ†é…æ²¡æœ‰ä»»ä½•è”ç³»ã€‚å¤§äº128Kçš„å†…å­˜ä½¿ç”¨mmapåˆ†é…ï¼Œä½¿ç”¨å®Œä¹‹åç›´æ¥ç”¨ummapè¿˜ç»™ç³»ç»Ÿ
    
- æ¯ä¸ªçº¿ç¨‹åœ¨mallocä¼šå…ˆè·å–ä¸€ä¸ªareaï¼Œä½¿ç”¨areaå†…å­˜æ± åˆ†é…è‡ªå·±çš„å†…å­˜ï¼Œè¿™é‡Œå­˜åœ¨ç«äº‰é—®é¢˜
    
- ä¸ºäº†é¿å…ç«äº‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼Œthread cacheï¼ˆtcmallocä¸­çš„tcæ­£æ˜¯æ­¤æ„ï¼‰ï¼Œçº¿ç¨‹å±€éƒ¨å­˜å‚¨å¯¹areaçš„æ”¹è¿›åŸç†å¦‚ä¸‹ï¼š
    
- å¦‚æœéœ€è¦åœ¨ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„å„ä¸ªå‡½æ•°è°ƒç”¨éƒ½èƒ½è®¿é—®ã€ä½†å…¶å®ƒçº¿ç¨‹ä¸èƒ½è®¿é—®çš„å˜é‡ï¼ˆè¢«ç§°ä¸ºstatic memory local to a thread çº¿ç¨‹å±€éƒ¨é™æ€å˜é‡ï¼‰ï¼Œå°±éœ€è¦æ–°çš„æœºåˆ¶æ¥å®ç°ã€‚è¿™å°±æ˜¯TLSã€‚
    
- thread cacheæœ¬è´¨ä¸Šæ˜¯åœ¨staticåŒºä¸ºæ¯ä¸€ä¸ªthreadå¼€è¾Ÿä¸€ä¸ªç‹¬æœ‰çš„ç©ºé—´ï¼Œå› ä¸ºç‹¬æœ‰ï¼Œä¸å†æœ‰ç«äº‰
    
- æ¯æ¬¡mallocæ—¶ï¼Œå…ˆå»çº¿ç¨‹å±€éƒ¨å­˜å‚¨ç©ºé—´ä¸­æ‰¾areaï¼Œç”¨thread cacheä¸­çš„areaåˆ†é…å­˜åœ¨thread areaä¸­çš„chunkã€‚å½“ä¸å¤Ÿæ—¶æ‰å»æ‰¾å †åŒºçš„areaã€‚
    

### 5.2 chunk

ptmallocé€šè¿‡malloc_chunkæ¥ç®¡ç†å†…å­˜ï¼Œç»™User dataå‰å­˜å‚¨äº†ä¸€äº›ä¿¡æ¯ï¼Œä½¿ç”¨è¾¹ç•Œæ ‡è®°åŒºåˆ†å„ä¸ªchunkã€‚

chunkå®šä¹‰å¦‚ä¸‹:

```c
structÂ malloc_chunkÂ {Â Â Â Â INTERNAL_SIZE_TÂ Â Â Â Â Â prev_size;Â Â Â Â /*Â SizeÂ ofÂ previousÂ chunkÂ (ifÂ free).Â Â */Â Â Â Â INTERNAL_SIZE_TÂ Â Â Â Â Â size;Â Â Â Â Â Â Â Â Â /*Â SizeÂ inÂ bytes,Â includingÂ overhead.Â */Â Â Â Â Â Â structÂ malloc_chunk*Â fd;Â Â Â Â Â Â Â Â Â Â Â /*Â doubleÂ linksÂ --Â usedÂ onlyÂ ifÂ free.Â */Â Â Â Â structÂ malloc_chunk*Â bk;Â Â Â Â Â Â /*Â OnlyÂ usedÂ forÂ largeÂ blocks:Â pointerÂ toÂ nextÂ largerÂ size.Â Â */Â Â Â Â structÂ malloc_chunk*Â fd_nextsize;Â Â Â Â Â Â /*Â doubleÂ linksÂ --Â usedÂ onlyÂ ifÂ free.Â */Â Â Â Â structÂ malloc_chunk*Â bk_nextsize;Â };Â Â 
```

- prev_size: å¦‚æœå‰ä¸€ä¸ªchunkæ˜¯ç©ºé—²çš„ï¼Œåˆ™è¯¥åŸŸè¡¨ç¤ºå‰ä¸€ä¸ªchunkçš„å¤§å°ï¼Œå¦‚æœå‰ä¸€ä¸ªchunkä¸ç©ºé—²ï¼Œè¯¥åŸŸæ— æ„ä¹‰ã€‚
    

ä¸€æ®µè¿ç»­çš„å†…å­˜è¢«åˆ†æˆå¤šä¸ªchunkï¼Œprev_sizeè®°å½•çš„å°±æ˜¯ç›¸é‚»çš„å‰ä¸€ä¸ªchunkçš„sizeï¼ŒçŸ¥é“å½“å‰chunkçš„åœ°å€ï¼Œå‡å»prev_sizeä¾¿æ˜¯å‰ä¸€ä¸ªchunkçš„åœ°å€ã€‚prev_sizeä¸»è¦ç”¨äºç›¸é‚»ç©ºé—²chunkçš„åˆå¹¶ã€‚

- size ï¼šå½“å‰ chunk çš„å¤§å°ï¼Œå¹¶ä¸”è®°å½•äº†å½“å‰ chunk å’Œå‰ä¸€ä¸ª chunk çš„ä¸€äº›å±æ€§ï¼ŒåŒ…æ‹¬å‰ä¸€ä¸ª chunk æ˜¯å¦åœ¨ä½¿ç”¨ä¸­ï¼Œå½“å‰ chunk æ˜¯å¦æ˜¯é€šè¿‡ mmap è·å¾—çš„å†…å­˜ï¼Œå½“å‰ chunk æ˜¯å¦å±äºéä¸»åˆ†é…åŒºã€‚
    
- fd å’Œ bk ï¼šæŒ‡é’ˆ fd å’Œ bk åªæœ‰å½“è¯¥ chunk å—ç©ºé—²æ—¶æ‰å­˜åœ¨ï¼Œå…¶ä½œç”¨æ˜¯ç”¨äºå°†å¯¹åº”çš„ç©ºé—² chunk å—åŠ å…¥åˆ°ç©ºé—²chunk å—é“¾è¡¨ä¸­ç»Ÿä¸€ç®¡ç†ï¼Œå¦‚æœè¯¥ chunk å—è¢«åˆ†é…ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæŒ‡é’ˆä¹Ÿå°±æ²¡æœ‰ç”¨ï¼ˆè¯¥ chunk å—å·²ç»ä»ç©ºé—²é“¾ä¸­æ‹†å‡ºï¼‰äº†ï¼Œæ‰€ä»¥ä¹Ÿå½“ä½œåº”ç”¨ç¨‹åºçš„ä½¿ç”¨ç©ºé—´ï¼Œè€Œä¸è‡³äºæµªè´¹ã€‚
    
- fd_nextsize å’Œ bk_nextsize: å½“å‰çš„ chunk å­˜åœ¨äº large bins ä¸­æ—¶ï¼Œ large bins ä¸­çš„ç©ºé—² chunk æ˜¯æŒ‰ç…§å¤§å°æ’åºçš„ï¼Œä½†åŒä¸€ä¸ªå¤§å°çš„ chunk å¯èƒ½æœ‰å¤šä¸ªï¼Œå¢åŠ äº†è¿™ä¸¤ä¸ªå­—æ®µå¯ä»¥åŠ å¿«éå†ç©ºé—² chunk ï¼Œå¹¶æŸ¥æ‰¾æ»¡è¶³éœ€è¦çš„ç©ºé—² chunk ï¼Œ fd_nextsize æŒ‡å‘ä¸‹ä¸€ä¸ªæ¯”å½“å‰ chunk å¤§å°å¤§çš„ç¬¬ä¸€ä¸ªç©ºé—² chunk ï¼Œ bk_nextszie æŒ‡å‘å‰ä¸€ä¸ªæ¯”å½“å‰ chunk å¤§å°å°çš„ç¬¬ä¸€ä¸ªç©ºé—² chunk ã€‚ï¼ˆåŒä¸€å¤§å°çš„chunkå¯èƒ½æœ‰å¤šå—ï¼Œåœ¨æ€»ä½“å¤§å°æœ‰åºçš„æƒ…å†µä¸‹ï¼Œè¦æƒ³æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ¯”è‡ªå·±å¤§æˆ–å°çš„chunkï¼Œéœ€è¦éå†æ‰€æœ‰ç›¸åŒçš„chunkï¼Œæ‰€ä»¥æ‰æœ‰fd_nextsizeå’Œbk_nextsizeè¿™ç§è®¾è®¡ï¼‰ å¦‚æœè¯¥ chunk å—è¢«åˆ†é…ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæŒ‡é’ˆä¹Ÿå°±æ²¡æœ‰ç”¨ï¼ˆè¯¥chunk å—å·²ç»ä» size é“¾ä¸­æ‹†å‡ºï¼‰äº†ï¼Œæ‰€ä»¥ä¹Ÿå½“ä½œåº”ç”¨ç¨‹åºçš„ä½¿ç”¨ç©ºé—´ï¼Œè€Œä¸è‡³äºæµªè´¹ã€‚
    

æ­£å¦‚ä¸Šé¢æ‰€æè¿°ï¼Œåœ¨ptmallocä¸­ï¼Œä¸ºäº†å°½å¯èƒ½çš„èŠ‚çœå†…å­˜ï¼Œä½¿ç”¨ä¸­çš„chunkå’Œæœªä½¿ç”¨çš„chunkåœ¨ç»“æ„ä¸Šæ˜¯ä¸ä¸€æ ·çš„ã€‚
![[Pasted image 20240914161108.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)åœ¨ä¸Šå›¾ä¸­ï¼š

- chunkæŒ‡é’ˆæŒ‡å‘chunkå¼€å§‹çš„åœ°å€
    
- memæŒ‡é’ˆæŒ‡å‘ç”¨æˆ·å†…å­˜å—å¼€å§‹çš„åœ°å€ã€‚
    
- p=0æ—¶ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªchunkä¸ºç©ºé—²ï¼Œprev_sizeæ‰æœ‰æ•ˆ
    
- p=1æ—¶ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªchunkæ­£åœ¨ä½¿ç”¨ï¼Œprev_sizeæ— æ•ˆ pä¸»è¦ç”¨äºå†…å­˜å—çš„åˆå¹¶æ“ä½œï¼›ptmalloc åˆ†é…çš„ç¬¬ä¸€ä¸ªå—æ€»æ˜¯å°†pè®¾ä¸º1, ä»¥é˜²æ­¢ç¨‹åºå¼•ç”¨åˆ°ä¸å­˜åœ¨çš„åŒºåŸŸ
    
- M=1 ä¸ºmmapæ˜ å°„åŒºåŸŸåˆ†é…ï¼›M=0ä¸ºheapåŒºåŸŸåˆ†é…
    
- A=0 ä¸ºä¸»åˆ†é…åŒºåˆ†é…ï¼›A=1 ä¸ºéä¸»åˆ†é…åŒºåˆ†é…ã€‚
    

ä¸éç©ºé—²chunkç›¸æ¯”ï¼Œç©ºé—²chunkåœ¨ç”¨æˆ·åŒºåŸŸå¤šäº†å››ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«ä¸ºfd,bk,fd_nextsize,bk_nextsizeï¼Œè¿™å‡ ä¸ªæŒ‡é’ˆçš„å«ä¹‰åœ¨ä¸Šé¢å·²ç»æœ‰è§£é‡Šï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚
![[Pasted image 20240914161122.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ç©ºé—²chunk

### 5.3 ç©ºé—²é“¾è¡¨(bins)

ç”¨æˆ·è°ƒç”¨freeå‡½æ•°é‡Šæ”¾å†…å­˜çš„æ—¶å€™ï¼Œptmallocå¹¶ä¸ä¼šç«‹å³å°†å…¶å½’è¿˜æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯å°†å…¶æ”¾å…¥ç©ºé—²é“¾è¡¨(bins)ä¸­ï¼Œè¿™æ ·ä¸‹æ¬¡å†è°ƒç”¨mallocå‡½æ•°ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œå°±ä¼šä»binsä¸­å–å‡ºä¸€å—è¿”å›ï¼Œè¿™æ ·å°±é¿å…äº†é¢‘ç¹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œä»è€Œé™ä½å†…å­˜åˆ†é…çš„å¼€é”€ã€‚

åœ¨ptmallocä¸­ï¼Œä¼šå°†å¤§å°ç›¸ä¼¼çš„chunké“¾æ¥èµ·æ¥ï¼Œå«åšbinã€‚æ€»å…±æœ‰128ä¸ªbinä¾›ptmallocä½¿ç”¨ã€‚

æ ¹æ®chunkçš„å¤§å°ï¼Œptmallocå°†binåˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

- fast bin
    
- unsorted bin
    
- small bin
    
- large bin
    

ä»å‰é¢malloc_stateç»“æ„å®šä¹‰ï¼Œå¯¹binè¿›è¡Œåˆ†ç±»ï¼Œå¯ä»¥åˆ†ä¸ºfast binå’Œbinsï¼Œå…¶ä¸­unsorted binã€small bin ä»¥åŠ large binå±äºbinsã€‚

åœ¨glibcä¸­ï¼Œä¸Šè¿°4ä¸­binçš„ä¸ªæ•°éƒ½ä¸ç­‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![[Pasted image 20240914161131.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

bin

#### 5.3.1 fast bin

ç¨‹åºåœ¨è¿è¡Œæ—¶ä¼šç»å¸¸éœ€è¦ç”³è¯·å’Œé‡Šæ”¾ä¸€äº›è¾ƒå°çš„å†…å­˜ç©ºé—´ã€‚å½“åˆ†é…å™¨åˆå¹¶äº†ç›¸é‚»çš„å‡ ä¸ªå°çš„ chunk ä¹‹å,ä¹Ÿè®¸é©¬ä¸Šå°±ä¼šæœ‰å¦ä¸€ä¸ªå°å—å†…å­˜çš„è¯·æ±‚,è¿™æ ·åˆ†é…å™¨åˆéœ€è¦ä»å¤§çš„ç©ºé—²å†…å­˜ä¸­åˆ‡åˆ†å‡ºä¸€å—,è¿™æ ·æ— ç–‘æ˜¯æ¯”è¾ƒä½æ•ˆçš„,æ•…è€Œ,malloc ä¸­åœ¨åˆ†é…è¿‡ç¨‹ä¸­å¼•å…¥äº† fast binsã€‚

åœ¨å‰é¢malloc_stateå®šä¹‰ä¸­

```c
mfastbinptrÂ fastbins[NFASTBINS];Â //Â NFASTBINSÂ Â =Â 10
```

1. fast binçš„ä¸ªæ•°æ˜¯10ä¸ª
    
2. æ¯ä¸ªfast binéƒ½æ˜¯ä¸€ä¸ªå•é“¾è¡¨(åªä½¿ç”¨fdæŒ‡é’ˆ)ã€‚è¿™æ˜¯å› ä¸ºfast binæ— è®ºæ˜¯æ·»åŠ è¿˜æ˜¯ç§»é™¤chunkéƒ½æ˜¯åœ¨é“¾è¡¨å°¾è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹fast binä¸­chunkçš„æ“ä½œï¼Œé‡‡ç”¨çš„æ˜¯LIFO(åå…¥å…ˆå‡º)ç®—æ³•ï¼šæ·»åŠ æ“ä½œ(freeå†…å­˜)å°±æ˜¯å°†æ–°çš„fast chunkåŠ å…¥é“¾è¡¨å°¾ï¼Œåˆ é™¤æ“ä½œ(mallocå†…å­˜)å°±æ˜¯å°†é“¾è¡¨å°¾éƒ¨çš„fast chunkåˆ é™¤ã€‚
    
3. chunk sizeï¼š10ä¸ªfast binä¸­æ‰€åŒ…å«çš„chunk sizeä»¥8ä¸ªå­—èŠ‚é€æ¸é€’å¢ï¼Œå³ç¬¬ä¸€ä¸ªfast binä¸­chunk sizeå‡ä¸º16ä¸ªå­—èŠ‚ï¼Œç¬¬äºŒä¸ªfast binçš„chunk sizeä¸º24å­—èŠ‚ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæœ€åä¸€ä¸ªfast binçš„chunk sizeä¸º80å­—èŠ‚ã€‚
    
4. ä¸ä¼šå¯¹free chunkè¿›è¡Œåˆå¹¶æ“ä½œã€‚è¿™æ˜¯å› ä¸ºfast binè®¾è®¡çš„åˆè¡·å°±æ˜¯å°å†…å­˜çš„å¿«é€Ÿåˆ†é…å’Œé‡Šæ”¾ï¼Œå› æ­¤ç³»ç»Ÿå°†å±äºfast binçš„chunkçš„P(æœªä½¿ç”¨æ ‡å¿—ä½)æ€»æ˜¯è®¾ç½®ä¸º1ï¼Œè¿™æ ·å³ä½¿å½“fast binä¸­æœ‰æŸä¸ªchunkåŒä¸€ä¸ªfree chunkç›¸é‚»çš„æ—¶å€™ï¼Œç³»ç»Ÿä¹Ÿä¸ä¼šè¿›è¡Œè‡ªåŠ¨åˆå¹¶æ“ä½œï¼Œè€Œæ˜¯ä¿ç•™ä¸¤è€…ã€‚
    
5. mallocæ“ä½œï¼šåœ¨mallocçš„æ—¶å€™ï¼Œå¦‚æœç”³è¯·çš„å†…å­˜å¤§å°èŒƒå›´åœ¨fast binçš„èŒƒå›´å†…ï¼Œåˆ™å…ˆåœ¨fast binä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™è¿”å›ã€‚å¦åˆ™åˆ™ä»small binã€unsorted binä»¥åŠlarge binä¸­æŸ¥æ‰¾ã€‚
    
6. freeæ“ä½œï¼šå…ˆé€šè¿‡chunksizeå‡½æ•°æ ¹æ®ä¼ å…¥çš„åœ°å€æŒ‡é’ˆè·å–è¯¥æŒ‡é’ˆå¯¹åº”çš„chunkçš„å¤§å°ï¼›ç„¶åæ ¹æ®è¿™ä¸ªchunkå¤§å°è·å–è¯¥chunkæ‰€å±çš„fast binï¼Œç„¶åå†å°†æ­¤chunkæ·»åŠ åˆ°è¯¥fast binçš„é“¾å°¾å³å¯ã€‚
    

ä¸‹é¢æ˜¯fastbinç»“æ„å›¾ï¼š
![[Pasted image 20240914161148.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

fastbin

#### 5.3.2 unsorted bin

unsorted bin çš„é˜Ÿåˆ—ä½¿ç”¨ bins æ•°ç»„çš„ç¬¬ä¸€ä¸ªï¼Œæ˜¯binsçš„ä¸€ä¸ªç¼“å†²åŒºï¼ŒåŠ å¿«åˆ†é…çš„é€Ÿåº¦ã€‚å½“ç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å¤§äºmax_fastæˆ–è€…fast binsåˆå¹¶åçš„chunkéƒ½ä¼šé¦–å…ˆè¿›å…¥unsorted binä¸Šã€‚

åœ¨unsorted binä¸­ï¼Œchunkçš„size æ²¡æœ‰é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»ä½•å¤§å°chunkéƒ½å¯ä»¥æ”¾è¿›unsorted binä¸­ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†è®©â€œglibc mallocæœºåˆ¶â€èƒ½å¤Ÿæœ‰ç¬¬äºŒæ¬¡æœºä¼šé‡æ–°åˆ©ç”¨æœ€è¿‘é‡Šæ”¾çš„chunk(ç¬¬ä¸€æ¬¡æœºä¼šå°±æ˜¯fast binæœºåˆ¶)ã€‚åˆ©ç”¨unsorted binï¼Œå¯ä»¥åŠ å¿«å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ“ä½œï¼Œå› ä¸ºæ•´ä¸ªæ“ä½œéƒ½ä¸å†éœ€è¦èŠ±è´¹é¢å¤–çš„æ—¶é—´å»æŸ¥æ‰¾åˆé€‚çš„binäº†ã€‚ã€€ã€€

ç”¨æˆ·mallocæ—¶ï¼Œå¦‚æœåœ¨ fast bins ä¸­æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ chunk,åˆ™malloc ä¼šå…ˆåœ¨ unsorted bin ä¸­æŸ¥æ‰¾åˆé€‚çš„ç©ºé—² chunkï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„binï¼Œptmallocä¼šå°†unsorted binä¸Šçš„chunkæ”¾å…¥binsä¸Šï¼Œç„¶ååˆ°binsä¸ŠæŸ¥æ‰¾åˆé€‚çš„ç©ºé—²chunkã€‚

ä¸fast binæ‰€ä¸åŒçš„æ˜¯ï¼Œunsortedbiné‡‡ç”¨çš„éå†é¡ºåºæ˜¯FIFOã€‚

unsorted binç»“æ„å›¾å¦‚ä¸‹ï¼š
![[Pasted image 20240914161205.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

unsorted bin

#### 5.3.3 small bin

å¤§å°å°äº512å­—èŠ‚çš„chunkè¢«ç§°ä¸ºsmall chunkï¼Œè€Œä¿å­˜small chunksçš„binè¢«ç§°ä¸ºsmall binã€‚æ•°ç»„ä»2å¼€å§‹ç¼–å·ï¼Œå‰62ä¸ªbinä¸ºsmall binsï¼Œsmall binæ¯ä¸ªbinä¹‹é—´ç›¸å·®8ä¸ªå­—èŠ‚ï¼ŒåŒä¸€ä¸ªsmall binä¸­çš„chunkå…·æœ‰ç›¸åŒå¤§å°ã€‚ã€€ã€€

æ¯ä¸ªsmall binéƒ½åŒ…æ‹¬ä¸€ä¸ªç©ºé—²åŒºå—çš„åŒå‘å¾ªç¯é“¾è¡¨ï¼ˆä¹Ÿç§°binlistï¼‰ã€‚freeæ‰çš„chunkæ·»åŠ åœ¨é“¾è¡¨çš„å‰ç«¯ï¼Œè€Œæ‰€éœ€chunkåˆ™ä»é“¾è¡¨åç«¯æ‘˜é™¤ã€‚ã€€ã€€

ä¸¤ä¸ªæ¯—è¿çš„ç©ºé—²chunkä¼šè¢«åˆå¹¶æˆä¸€ä¸ªç©ºé—²chunkã€‚åˆå¹¶æ¶ˆé™¤äº†ç¢ç‰‡åŒ–çš„å½±å“ä½†æ˜¯å‡æ…¢äº†freeçš„é€Ÿåº¦ã€‚åˆ†é…æ—¶ï¼Œå½“samll binéç©ºåï¼Œç›¸åº”çš„binä¼šæ‘˜é™¤binlistä¸­æœ€åä¸€ä¸ªchunkå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚

åœ¨freeä¸€ä¸ªchunkçš„æ—¶å€™ï¼Œæ£€æŸ¥å…¶å‰æˆ–å…¶åçš„chunkæ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯åˆ™åˆå¹¶ï¼Œä¹Ÿå³æŠŠå®ƒä»¬ä»æ‰€å±çš„é“¾è¡¨ä¸­æ‘˜é™¤å¹¶åˆå¹¶æˆä¸€ä¸ªæ–°çš„chunkï¼Œæ–°chunkä¼šæ·»åŠ åœ¨unsorted biné“¾è¡¨çš„å‰ç«¯ã€‚

small binä¹Ÿé‡‡ç”¨çš„æ˜¯FIFOç®—æ³•ï¼Œå³å†…å­˜é‡Šæ”¾æ“ä½œå°±å°†æ–°é‡Šæ”¾çš„chunkæ·»åŠ åˆ°é“¾è¡¨çš„front end(å‰ç«¯)ï¼Œåˆ†é…æ“ä½œå°±ä»é“¾è¡¨çš„rear end(å°¾ç«¯)ä¸­è·å–chunkã€‚
![[Pasted image 20240914161239.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

small bin

#### 5.3.4 large bin

å¤§å°å¤§äºç­‰äº512å­—èŠ‚çš„chunkè¢«ç§°ä¸ºlarge chunkï¼Œè€Œä¿å­˜large chunksçš„binè¢«ç§°ä¸ºlarge binï¼Œä½äºsmall binsåé¢ã€‚large binsä¸­çš„æ¯ä¸€ä¸ªbinåˆ†åˆ«åŒ…å«äº†ä¸€ä¸ªç»™å®šèŒƒå›´å†…çš„chunkï¼Œå…¶ä¸­çš„chunkæŒ‰å¤§å°é€’å‡æ’åºï¼Œå¤§å°ç›¸åŒåˆ™æŒ‰ç…§æœ€è¿‘ä½¿ç”¨æ—¶é—´æ’åˆ—ã€‚

ä¸¤ä¸ªæ¯—è¿çš„ç©ºé—²chunkä¼šè¢«åˆå¹¶æˆä¸€ä¸ªç©ºé—²chunkã€‚

small bins çš„ç­–ç•¥éå¸¸é€‚åˆå°åˆ†é…ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ä¸ºæ¯ä¸ªå¯èƒ½çš„å—å¤§å°éƒ½æœ‰ä¸€ä¸ª binã€‚å¯¹äºè¶…è¿‡ 512 å­—èŠ‚ï¼ˆ64 ä½ä¸º 1024 å­—èŠ‚ï¼‰çš„å—ï¼Œå †ç®¡ç†å™¨æ”¹ä¸ºä½¿ç”¨â€œlarge binâ€ã€‚

63 large binä¸­çš„æ¯ä¸€ä¸ªéƒ½ä¸small binçš„æ“ä½œæ–¹å¼å¤§è‡´ç›¸åŒï¼Œä½†ä¸æ˜¯å­˜å‚¨å›ºå®šå¤§å°çš„å—ï¼Œè€Œæ˜¯å­˜å‚¨å¤§å°èŒƒå›´å†…çš„å—ã€‚æ¯ä¸ªlarge bin çš„å¤§å°èŒƒå›´éƒ½è®¾è®¡ä¸ºä¸ä¸small bin çš„å—å¤§å°æˆ–å…¶ä»–large bin çš„èŒƒå›´é‡å ã€‚æ¢å¥è¯è¯´ï¼Œç»™å®šä¸€ä¸ªå—çš„å¤§å°ï¼Œè¿™ä¸ªå¤§å°å¯¹åº”çš„æ­£å¥½æ˜¯ä¸€ä¸ªsmall binæˆ–large binã€‚

åœ¨è¿™63ä¸ªlargebinsä¸­ï¼šç¬¬ä¸€ç»„çš„32ä¸ªlargebiné“¾ä¾æ¬¡ä»¥64å­—èŠ‚æ­¥é•¿ä¸ºé—´éš”ï¼Œå³ç¬¬ä¸€ä¸ªlargebiné“¾ä¸­chunksizeä¸º1024-1087å­—èŠ‚ï¼Œç¬¬äºŒä¸ªlarge binä¸­chunk sizeä¸º1088~1151å­—èŠ‚ã€‚ç¬¬äºŒç»„çš„16ä¸ªlargebiné“¾ä¾æ¬¡ä»¥512å­—èŠ‚æ­¥é•¿ä¸ºé—´éš”ï¼›ç¬¬ä¸‰ç»„çš„8ä¸ªlargebiné“¾ä»¥æ­¥é•¿4096ä¸ºé—´éš”ï¼›ç¬¬å››ç»„çš„4ä¸ªlargebiné“¾ä»¥32768å­—èŠ‚ä¸ºé—´éš”ï¼›ç¬¬äº”ç»„çš„2ä¸ªlargebiné“¾ä»¥262144å­—èŠ‚ä¸ºé—´éš”ï¼›æœ€åä¸€ç»„çš„largebiné“¾ä¸­çš„chunkå¤§å°æ— é™åˆ¶ã€‚

åœ¨è¿›è¡Œmallocæ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆç¡®å®šç”¨æˆ·è¯·æ±‚çš„å¤§å°å±äºå“ªä¸€ä¸ªlarge binï¼Œç„¶ååˆ¤æ–­è¯¥large binä¸­æœ€å¤§çš„chunkçš„sizeæ˜¯å¦å¤§äºç”¨æˆ·è¯·æ±‚çš„sizeã€‚å¦‚æœå¤§äºï¼Œå°±ä»å°¾å¼€å§‹éå†è¯¥large binï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªsizeç›¸ç­‰æˆ–æ¥è¿‘çš„chunkï¼Œåˆ†é…ç»™ç”¨æˆ·ã€‚å¦‚æœè¯¥chunkå¤§äºç”¨æˆ·è¯·æ±‚çš„sizeçš„è¯ï¼Œå°±å°†è¯¥chunkæ‹†åˆ†ä¸ºä¸¤ä¸ªchunkï¼šå‰è€…è¿”å›ç»™ç”¨æˆ·ï¼Œä¸”sizeç­‰åŒäºç”¨æˆ·è¯·æ±‚çš„sizeï¼›å‰©ä½™çš„éƒ¨åˆ†åšä¸ºä¸€ä¸ªæ–°çš„chunkæ·»åŠ åˆ°unsorted binä¸­ã€‚

å¦‚æœè¯¥large binä¸­æœ€å¤§çš„chunkçš„sizeå°äºç”¨æˆ·è¯·æ±‚çš„sizeçš„è¯ï¼Œé‚£ä¹ˆå°±ä¾æ¬¡æŸ¥çœ‹åç»­çš„large binä¸­æ˜¯å¦æœ‰æ»¡è¶³éœ€æ±‚çš„chunkï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯é‰´äºbinçš„ä¸ªæ•°è¾ƒå¤š(ä¸åŒbinä¸­çš„chunkææœ‰å¯èƒ½åœ¨ä¸åŒçš„å†…å­˜é¡µä¸­)ï¼Œå¦‚æœæŒ‰ç…§ä¸Šä¸€æ®µä¸­ä»‹ç»çš„æ–¹æ³•è¿›è¡Œéå†çš„è¯(å³éå†æ¯ä¸ªbinä¸­çš„chunk)ï¼Œå°±å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡å†…å­˜é¡µä¸­æ–­æ“ä½œï¼Œè¿›è€Œä¸¥é‡å½±å“æ£€ç´¢é€Ÿåº¦ï¼Œæ‰€ä»¥glibc mallocè®¾è®¡äº†Binmapç»“æ„ä½“æ¥å¸®åŠ©æé«˜bin-by-binæ£€ç´¢çš„é€Ÿåº¦ã€‚

Binmapè®°å½•äº†å„ä¸ªbinä¸­æ˜¯å¦ä¸ºç©ºï¼Œé€šè¿‡bitmapå¯ä»¥é¿å…æ£€ç´¢ä¸€äº›ç©ºçš„binã€‚å¦‚æœé€šè¿‡binmapæ‰¾åˆ°äº†ä¸‹ä¸€ä¸ªéç©ºçš„large binçš„è¯ï¼Œå°±æŒ‰ç…§ä¸Šä¸€æ®µä¸­çš„æ–¹æ³•åˆ†é…chunkï¼Œå¦åˆ™å°±ä½¿ç”¨top chunkï¼ˆåœ¨åé¢æœ‰è®²ï¼‰æ¥åˆ†é…åˆé€‚çš„å†…å­˜ã€‚

large binçš„free æ“ä½œä¸small binä¸€è‡´ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚
![[Pasted image 20240914161250.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

large bin

ä¸Šè¿°å‡ ç§binï¼Œç»„æˆäº†è¿›ç¨‹ä¸­æœ€æ ¸å¿ƒçš„åˆ†é…éƒ¨åˆ†ï¼šbinsï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)![[Pasted image 20240914161302.png]]

### 5.4 ç‰¹æ®Šchunk

ä¸ŠèŠ‚å†…å®¹è®²è¿°äº†å‡ ç§binä»¥åŠå„ç§binå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ç‰¹ç‚¹ï¼Œä½†æ˜¯ï¼Œä»…ä»…ä¸Šé¢å‡ ç§binè¿˜ä¸èƒ½å¤Ÿæ»¡è¶³ï¼Œæ¯”å¦‚å‡å¦‚ä¸Šè¿°binsä¸èƒ½æ»¡è¶³åˆ†é…æ¡ä»¶çš„æ—¶å€™ï¼Œglibcæå‡ºäº†å¦å¤–å‡ ç§ç‰¹æ®Šçš„chunkä¾›åˆ†é…å’Œé‡Šæ”¾ï¼Œåˆ†åˆ«ä¸ºtop chunkï¼Œmmaped chunk å’Œlast remainder chunkã€‚

#### 5.4.1 top trunk

top chunkæ˜¯å †æœ€ä¸Šé¢çš„ä¸€æ®µç©ºé—´ï¼Œå®ƒä¸å±äºä»»ä½•binï¼Œå½“æ‰€æœ‰çš„binéƒ½æ— æ³•æ»¡è¶³åˆ†é…è¦æ±‚æ—¶ï¼Œå°±è¦ä»è¿™å—åŒºåŸŸé‡Œæ¥åˆ†é…ï¼Œåˆ†é…çš„ç©ºé—´è¿”ç»™ç”¨æˆ·ï¼Œå‰©ä½™éƒ¨åˆ†å½¢æˆæ–°çš„top chunkï¼Œå¦‚æœtop chunkçš„ç©ºé—´ä¹Ÿä¸æ»¡è¶³ç”¨æˆ·çš„è¯·æ±‚ï¼Œå°±è¦ä½¿ç”¨brkæˆ–è€…mmapæ¥å‘ç³»ç»Ÿç”³è¯·æ›´å¤šçš„å †ç©ºé—´ï¼ˆä¸»åˆ†é…åŒºä½¿ç”¨brkã€sbrkï¼Œéä¸»åˆ†é…åŒºä½¿ç”¨mmapï¼‰ã€‚

åœ¨free chunkçš„æ—¶å€™ï¼Œå¦‚æœchunk sizeä¸å±äºfastbinçš„èŒƒå›´ï¼Œå°±è¦è€ƒè™‘æ˜¯ä¸æ˜¯å’Œtop chunkæŒ¨ç€ï¼Œå¦‚æœæŒ¨ç€ï¼Œå°±è¦mergeåˆ°top chunkä¸­ã€‚

#### 5.4.2 mmaped chunk

å½“åˆ†é…çš„å†…å­˜éå¸¸å¤§ï¼ˆå¤§äºåˆ†é…é˜€å€¼ï¼Œé»˜è®¤128Kï¼‰çš„æ—¶å€™ï¼Œéœ€è¦è¢«mmapæ˜ å°„ï¼Œåˆ™ä¼šæ”¾åˆ°mmaped chunkä¸Šï¼Œå½“é‡Šæ”¾mmaped chunkä¸Šçš„å†…å­˜çš„æ—¶å€™ä¼šç›´æ¥äº¤è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚ï¼ˆchunkä¸­çš„Mæ ‡å¿—ä½ç½®1ï¼‰

#### 5.4.3 last remainder chunk

Last remainder chunkæ˜¯å¦å¤–ä¸€ç§ç‰¹æ®Šçš„chunkï¼Œè¿™ä¸ªç‰¹æ®Šchunkæ˜¯è¢«ç»´æŠ¤åœ¨unsorted binä¸­çš„ã€‚

å¦‚æœç”¨æˆ·ç”³è¯·çš„sizeå±äºsmall binçš„ï¼Œä½†æ˜¯åˆä¸èƒ½ç²¾ç¡®åŒ¹é…çš„æƒ…å†µä¸‹ï¼Œè¿™æ—¶å€™é‡‡ç”¨æœ€ä½³åŒ¹é…ï¼ˆæ¯”å¦‚ç”³è¯·128å­—èŠ‚ï¼Œä½†æ˜¯å¯¹åº”çš„binæ˜¯ç©ºï¼Œåªæœ‰256å­—èŠ‚çš„binéç©ºï¼Œè¿™æ—¶å€™å°±è¦ä»256å­—èŠ‚çš„binä¸Šåˆ†é…ï¼‰ï¼Œè¿™æ ·ä¼šsplit chunkæˆä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†è¿”ç»™ç”¨æˆ·ï¼Œå¦ä¸€éƒ¨åˆ†å½¢æˆlast remainder chunkï¼Œæ’å…¥åˆ°unsorted binä¸­ã€‚

å½“éœ€è¦åˆ†é…ä¸€ä¸ªsmall chunk,ä½†åœ¨small binsä¸­æ‰¾ä¸åˆ°åˆé€‚çš„chunkï¼Œå¦‚æœlast remainder chunkçš„å¤§å°å¤§äºæ‰€éœ€è¦çš„small chunkå¤§å°ï¼Œlast remainder chunkè¢«åˆ†è£‚æˆä¸¤ä¸ªchunkï¼Œå…¶ä¸­ä¸€ä¸ªchunkè¿”å›ç»™ç”¨æˆ·ï¼Œå¦ä¸€ä¸ªchunkå˜æˆæ–°çš„last remainder chunkã€‚

last remainder chunkä¸»è¦é€šè¿‡æé«˜å†…å­˜åˆ†é…çš„å±€éƒ¨æ€§æ¥æé«˜è¿ç»­mallocï¼ˆäº§ç”Ÿå¤§é‡ small chunkï¼‰çš„æ•ˆç‡ã€‚

### 5.5 chunk åˆ‡åˆ†

chunké‡Šæ”¾æ—¶ï¼Œå…¶é•¿åº¦ä¸å±äºfastbinsçš„èŒƒå›´ï¼Œåˆ™åˆå¹¶å‰åç›¸é‚»çš„chunkã€‚é¦–æ¬¡åˆ†é…çš„é•¿åº¦åœ¨large binçš„èŒƒå›´ï¼Œå¹¶ä¸”fast binsä¸­æœ‰ç©ºé—²chunkï¼Œåˆ™å°†fastbinsä¸­çš„chunkä¸ç›¸é‚»ç©ºé—²çš„chunkè¿›è¡Œåˆå¹¶ï¼Œç„¶åå°†åˆå¹¶åçš„chunkæ”¾åˆ°unsorted binä¸­ï¼Œå¦‚æœfastbinä¸­çš„chunkç›¸é‚»çš„chunkå¹¶éç©ºé—²æ— æ³•åˆå¹¶ï¼Œä»æ—§å°†è¯¥chunkæ”¾åˆ°unsorted binä¸­ï¼Œå³èƒ½åˆå¹¶çš„è¯å°±è¿›è¡Œåˆå¹¶ï¼Œä½†æœ€ç»ˆéƒ½ä¼šæ”¾åˆ°unsorted binä¸­ã€‚

fastbinsï¼Œsmall binä¸­éƒ½æ²¡æœ‰åˆé€‚çš„chunkï¼Œtop chunkçš„é•¿åº¦ä¹Ÿä¸èƒ½æ»¡è¶³éœ€è¦ï¼Œåˆ™å¯¹fast binä¸­çš„chunkè¿›è¡Œåˆå¹¶ã€‚

### 5.6 chunk åˆå¹¶

å‰é¢è®²äº†ç›¸é‚»çš„chunkå¯ä»¥åˆå¹¶æˆä¸€ä¸ªå¤§çš„chunkï¼Œåè¿‡æ¥ï¼Œä¸€ä¸ªå¤§çš„chunkä¹Ÿå¯ä»¥åˆ†è£‚æˆä¸¤ä¸ªå°çš„chunkã€‚chunkçš„åˆ†è£‚ä¸ä»top chunkä¸­åˆ†é…æ–°çš„chunkæ˜¯ä¸€æ ·çš„ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼šåˆ†è£‚åçš„ä¸¤ä¸ªchunkå…¶é•¿åº¦å¿…é¡»å‡å¤§äºchunkçš„æœ€å°é•¿åº¦ï¼ˆå¯¹äº64ä½ç³»ç»Ÿæ˜¯32å­—èŠ‚ï¼‰ï¼Œå³ä¿è¯åˆ†è£‚åçš„ä¸¤ä¸ªchunkä»æ—§æ˜¯å¯ä»¥è¢«åˆ†é…ä½¿ç”¨çš„ï¼Œå¦åˆ™åˆ™ä¸è¿›è¡Œåˆ†è£‚ï¼Œè€Œæ˜¯å°†æ•´ä¸ªchunkè¿”å›ç»™ç”¨æˆ·ã€‚

## 6 å†…å­˜åˆ†é…(malloc)

glibcè¿è¡Œæ—¶åº“åˆ†é…åŠ¨æ€å†…å­˜ï¼Œåº•å±‚ç”¨çš„æ˜¯mallocæ¥å®ç°(new æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨malloc)ï¼Œä¸‹é¢æ˜¯mallocå‡½æ•°è°ƒç”¨æµç¨‹å›¾ï¼š
![[Pasted image 20240914161318.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

malloc

åœ¨æ­¤ï¼Œå°†ä¸Šè¿°æµç¨‹å›¾ä»¥æ–‡å­—å½¢å¼è¡¨ç¤ºå‡ºæ¥ï¼Œä»¥æ–¹ä¾¿å¤§å®¶ç†è§£ï¼š

1. è·å–åˆ†é…åŒºçš„é”ï¼Œä¸ºäº†é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªåˆ†é…åŒºï¼Œåœ¨è¿›è¡Œåˆ†é…ä¹‹å‰éœ€è¦å–å¾—åˆ†é…åŒºåŸŸçš„é”ã€‚çº¿ç¨‹å…ˆæŸ¥çœ‹çº¿ç¨‹ç§æœ‰å®ä¾‹ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªåˆ†é…åŒºï¼Œå¦‚æœå­˜åœ¨å°è¯•å¯¹è¯¥åˆ†é…åŒºåŠ é”ï¼Œå¦‚æœåŠ é”æˆåŠŸï¼Œä½¿ç”¨è¯¥åˆ†é…åŒºåˆ†é…å†…å­˜ï¼Œå¦åˆ™ï¼Œè¯¥çº¿ç¨‹æœç´¢åˆ†é…åŒºå¾ªç¯é“¾è¡¨è¯•å›¾è·å¾—ä¸€ä¸ªç©ºé—²ï¼ˆæ²¡æœ‰åŠ é”ï¼‰çš„åˆ†é…åŒºã€‚å¦‚æœæ‰€æœ‰çš„åˆ†é…åŒºéƒ½å·²ç»åŠ é”ï¼Œé‚£ä¹ˆ ptmalloc ä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„åˆ†é…åŒºï¼ŒæŠŠè¯¥åˆ†é…åŒºåŠ å…¥åˆ°å…¨å±€åˆ†é…åŒºå¾ªç¯é“¾è¡¨å’Œçº¿ç¨‹çš„ç§æœ‰å®ä¾‹ä¸­å¹¶åŠ é”ï¼Œç„¶åä½¿ç”¨è¯¥åˆ†é…åŒºè¿›è¡Œåˆ†é…æ“ä½œã€‚å¼€è¾Ÿå‡ºæ¥çš„æ–°åˆ†é…åŒºä¸€å®šä¸ºéä¸»åˆ†é…åŒºï¼Œå› ä¸ºä¸»åˆ†é…åŒºæ˜¯ä»çˆ¶è¿›ç¨‹é‚£é‡Œç»§æ‰¿æ¥çš„ã€‚å¼€è¾Ÿéä¸»åˆ†é…åŒºæ—¶ä¼šè°ƒç”¨ mmap()åˆ›å»ºä¸€ä¸ª sub-heapï¼Œå¹¶è®¾ç½®å¥½ top chunkã€‚
    
2. å°†ç”¨æˆ·çš„è¯·æ±‚å¤§å°è½¬æ¢ä¸ºå®é™…éœ€è¦åˆ†é…çš„ chunk ç©ºé—´å¤§å°ã€‚
    
3. åˆ¤æ–­æ‰€éœ€åˆ†é…chunk çš„å¤§å°æ˜¯å¦æ»¡è¶³chunk_size <= max_fast (max_fast é»˜è®¤ä¸º 64B)ï¼Œ å¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è½¬ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™è·³åˆ°ç¬¬ 5 æ­¥ã€‚
    
4. é¦–å…ˆå°è¯•åœ¨ fast bins ä¸­å–ä¸€ä¸ªæ‰€éœ€å¤§å°çš„ chunk åˆ†é…ç»™ç”¨æˆ·ã€‚å¦‚æœå¯ä»¥æ‰¾åˆ°ï¼Œåˆ™åˆ†é…ç»“æŸã€‚å¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚
    
5. åˆ¤æ–­æ‰€éœ€å¤§å°æ˜¯å¦å¤„åœ¨ small bins ä¸­ï¼Œå³åˆ¤æ–­ chunk_size < 512B æ˜¯å¦æˆç«‹ã€‚å¦‚æœchunk å¤§å°å¤„åœ¨ small bins ä¸­ï¼Œåˆ™è½¬ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™è½¬åˆ°ç¬¬ 6 æ­¥ã€‚
    
6. æ ¹æ®æ‰€éœ€åˆ†é…çš„ chunk çš„å¤§å°ï¼Œæ‰¾åˆ°å…·ä½“æ‰€åœ¨çš„æŸä¸ª small binï¼Œä»è¯¥ bin çš„å°¾éƒ¨æ‘˜å–ä¸€ä¸ªæ°å¥½æ»¡è¶³å¤§å°çš„ chunkã€‚è‹¥æˆåŠŸï¼Œåˆ™åˆ†é…ç»“æŸï¼Œå¦åˆ™ï¼Œè½¬åˆ°ä¸‹ä¸€æ­¥ã€‚
    
7. åˆ°äº†è¿™ä¸€æ­¥ï¼Œè¯´æ˜éœ€è¦åˆ†é…çš„æ˜¯ä¸€å—å¤§çš„å†…å­˜ï¼Œæˆ–è€… small bins ä¸­æ‰¾ä¸åˆ°åˆé€‚çš„chunkã€‚äºæ˜¯ï¼Œptmalloc é¦–å…ˆä¼šéå† fast bins ä¸­çš„ chunkï¼Œå°†ç›¸é‚»çš„ chunk è¿›è¡Œåˆå¹¶ï¼Œå¹¶é“¾æ¥åˆ° unsorted bin ä¸­ï¼Œç„¶åéå† unsorted bin ä¸­çš„ chunkï¼Œå¦‚æœ unsorted bin åªæœ‰ä¸€ä¸ª chunkï¼Œå¹¶ä¸”è¿™ä¸ª chunk åœ¨ä¸Šæ¬¡åˆ†é…æ—¶è¢«ä½¿ç”¨è¿‡ï¼Œå¹¶ä¸”æ‰€éœ€åˆ†é…çš„ chunk å¤§å°å±äº small binsï¼Œå¹¶ä¸” chunk çš„å¤§å°å¤§äºç­‰äºéœ€è¦åˆ†é…çš„å¤§å°ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ç›´æ¥å°†è¯¥ chunk è¿›è¡Œåˆ‡å‰²ï¼Œåˆ†é…ç»“æŸï¼Œå¦åˆ™å°†æ ¹æ® chunk çš„ç©ºé—´å¤§å°å°†å…¶æ”¾å…¥ small bins æˆ–æ˜¯ large bins ä¸­ï¼Œéå†å®Œæˆåï¼Œè½¬å…¥ä¸‹ä¸€æ­¥ã€‚
    
8. åˆ°äº†è¿™ä¸€æ­¥ï¼Œè¯´æ˜éœ€è¦åˆ†é…çš„æ˜¯ä¸€å—å¤§çš„å†…å­˜ï¼Œæˆ–è€… small bins å’Œ unsorted bin ä¸­éƒ½æ‰¾ä¸åˆ°åˆé€‚çš„ chunkï¼Œå¹¶ä¸” fast bins å’Œ unsorted bin ä¸­æ‰€æœ‰çš„ chunk éƒ½æ¸…é™¤å¹²å‡€äº†ã€‚ä» large bins ä¸­æŒ‰ç…§â€œsmallest-firstï¼Œbest-fitâ€åŸåˆ™ï¼Œæ‰¾ä¸€ä¸ªåˆé€‚çš„ chunkï¼Œä»ä¸­åˆ’åˆ†ä¸€å—æ‰€éœ€å¤§å°çš„ chunkï¼Œå¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†é“¾æ¥å›åˆ° bins ä¸­ã€‚è‹¥æ“ä½œæˆåŠŸï¼Œåˆ™åˆ†é…ç»“æŸï¼Œå¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚
    
9. å¦‚æœæœç´¢ fast bins å’Œ bins éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ chunkï¼Œé‚£ä¹ˆå°±éœ€è¦æ“ä½œ top chunk æ¥è¿›è¡Œåˆ†é…äº†ã€‚åˆ¤æ–­ top chunk å¤§å°æ˜¯å¦æ»¡è¶³æ‰€éœ€ chunk çš„å¤§å°ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä» top chunk ä¸­åˆ†å‡ºä¸€å—æ¥ã€‚å¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚
    
10. åˆ°äº†è¿™ä¸€æ­¥ï¼Œè¯´æ˜ top chunk ä¹Ÿä¸èƒ½æ»¡è¶³åˆ†é…è¦æ±‚ï¼Œæ‰€ä»¥ï¼Œäºæ˜¯å°±æœ‰äº†ä¸¤ä¸ªé€‰æ‹©: å¦‚æœæ˜¯ä¸»åˆ†é…åŒºï¼Œè°ƒç”¨ sbrk()ï¼Œå¢åŠ  top chunk å¤§å°ï¼›å¦‚æœæ˜¯éä¸»åˆ†é…åŒºï¼Œè°ƒç”¨ mmap æ¥åˆ†é…ä¸€ä¸ªæ–°çš„ sub-heapï¼Œå¢åŠ  top chunk å¤§å°ï¼›æˆ–è€…ä½¿ç”¨ mmap()æ¥ç›´æ¥åˆ†é…ã€‚åœ¨è¿™é‡Œï¼Œéœ€è¦ä¾é  chunk çš„å¤§å°æ¥å†³å®šåˆ°åº•ä½¿ç”¨å“ªç§æ–¹æ³•ã€‚åˆ¤æ–­æ‰€éœ€åˆ†é…çš„ chunk å¤§å°æ˜¯å¦å¤§äºç­‰äº mmap åˆ†é…é˜ˆå€¼ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œåˆ™è½¬ä¸‹ä¸€æ­¥ï¼Œè°ƒç”¨ mmap åˆ†é…ï¼Œ å¦åˆ™è·³åˆ°ç¬¬ 12 æ­¥ï¼Œå¢åŠ  top chunk çš„å¤§å°ã€‚
    
11. ä½¿ç”¨ mmap ç³»ç»Ÿè°ƒç”¨ä¸ºç¨‹åºçš„å†…å­˜ç©ºé—´æ˜ å°„ä¸€å— chunk_size align 4kB å¤§å°çš„ç©ºé—´ã€‚ç„¶åå°†å†…å­˜æŒ‡é’ˆè¿”å›ç»™ç”¨æˆ·ã€‚
    
12. åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ mallocï¼Œè‹¥æ˜¯ä¸»åˆ†é…åŒºï¼Œåˆ™éœ€è¦è¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–å·¥ä½œï¼Œåˆ†é…ä¸€å—å¤§å°ä¸º(chunk_size + 128KB) align 4KB å¤§å°çš„ç©ºé—´ä½œä¸ºåˆå§‹çš„ heapã€‚è‹¥å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œä¸»åˆ†é…åŒºåˆ™è°ƒç”¨ sbrk()å¢åŠ  heap ç©ºé—´ï¼Œåˆ†ä¸»åˆ†é…åŒºåˆ™åœ¨ top chunk ä¸­åˆ‡å‰²å‡ºä¸€ä¸ª chunkï¼Œä½¿ä¹‹æ»¡è¶³åˆ†é…éœ€æ±‚ï¼Œå¹¶å°†å†…å­˜æŒ‡é’ˆè¿”å›ç»™ç”¨æˆ·ã€‚
    

å°†ä¸Šé¢æµç¨‹ä¸²èµ·æ¥å°±æ˜¯ï¼š

> â
> 
> æ ¹æ®ç”¨æˆ·è¯·æ±‚åˆ†é…çš„å†…å­˜çš„å¤§å°ï¼Œptmallocæœ‰å¯èƒ½ä¼šåœ¨ä¸¤ä¸ªåœ°æ–¹ä¸ºç”¨æˆ·åˆ†é…å†…å­˜ç©ºé—´ã€‚åœ¨ç¬¬ä¸€æ¬¡åˆ†é…å†…å­˜æ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªå­˜åœ¨ä¸€ä¸ªä¸»åˆ†é…åŒºï¼Œä½†ä¹Ÿæœ‰å¯èƒ½ä»çˆ¶è¿›ç¨‹é‚£é‡Œç»§æ‰¿æ¥äº†å¤šä¸ªéä¸»åˆ†é…åŒºï¼Œåœ¨è¿™é‡Œä¸»è¦è®¨è®ºä¸»åˆ†é…åŒºçš„æƒ…å†µï¼Œbrkå€¼ç­‰äºstart_brkï¼Œæ‰€ä»¥å®é™…ä¸Šheapå¤§å°ä¸º0ï¼Œtop chunk å¤§å°ä¹Ÿæ˜¯0ã€‚è¿™æ—¶ï¼Œå¦‚æœä¸å¢åŠ heapå¤§å°ï¼Œå°±ä¸èƒ½æ»¡è¶³ä»»ä½•åˆ†é…è¦æ±‚ã€‚æ‰€ä»¥ï¼Œè‹¥ç”¨æˆ·çš„è¯·æ±‚çš„å†…å­˜å¤§å°å°äºmmapåˆ†é…é˜ˆå€¼ï¼Œ åˆ™ptmallocä¼šåˆå§‹heapã€‚
> 
> ç„¶ååœ¨heapä¸­åˆ†é…ç©ºé—´ç»™ç”¨æˆ·ï¼Œä»¥åçš„åˆ†é…å°±åŸºäºè¿™ä¸ªheapè¿›è¡Œã€‚è‹¥ç¬¬ä¸€æ¬¡ç”¨æˆ·çš„è¯·æ±‚å°±å¤§äºmmapåˆ†é…é˜ˆå€¼ï¼Œåˆ™ptmallocç›´æ¥ä½¿ç”¨mmap()åˆ†é…ä¸€å—å†…å­˜ç»™ç”¨æˆ·ï¼Œè€Œheapä¹Ÿå°±æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œç›´åˆ°ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚å°äºmmapåˆ†é…é˜ˆå€¼çš„å†…å­˜åˆ†é…ã€‚ç¬¬ä¸€æ¬¡ä»¥åçš„åˆ†é…å°±æ¯”è¾ƒå¤æ‚äº†ï¼Œç®€å•è¯´æ¥ï¼Œptmallocé¦–å…ˆä¼šæŸ¥æ‰¾fast binsï¼Œå¦‚æœä¸èƒ½æ‰¾åˆ°åŒ¹é…çš„chunkï¼Œåˆ™æŸ¥æ‰¾small Â binsã€‚
> 
> è‹¥ä»ç„¶ä¸æ»¡è¶³è¦æ±‚ï¼Œåˆ™åˆå¹¶fast binsï¼ŒæŠŠchunkåŠ å…¥unsorted binï¼Œåœ¨unsorted binä¸­æŸ¥æ‰¾ï¼Œè‹¥ä»ç„¶ä¸æ»¡è¶³è¦æ±‚ï¼ŒæŠŠunsorted bin ä¸­çš„chunkå…¨åŠ å…¥large bins ä¸­ï¼Œå¹¶æŸ¥æ‰¾large binsã€‚åœ¨fast bins å’Œsmall binsä¸­çš„æŸ¥æ‰¾éƒ½éœ€è¦ç²¾ç¡®åŒ¹é…ï¼Œ è€Œåœ¨large Â binsä¸­æŸ¥æ‰¾æ—¶ï¼Œåˆ™éµå¾ªâ€œsmallest-firstï¼Œbest-fitâ€çš„åŸåˆ™ï¼Œä¸éœ€è¦ç²¾ç¡®åŒ¹é…ã€‚
> 
> è‹¥ä»¥ä¸Šæ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œåˆ™ptmallocä¼šè€ƒè™‘ä½¿ç”¨top chunkã€‚è‹¥top chunkä¹Ÿä¸èƒ½æ»¡è¶³åˆ†é…è¦æ±‚ã€‚è€Œä¸”æ‰€éœ€chunkå¤§å°å¤§äºmmapåˆ†é…é˜ˆå€¼ï¼Œåˆ™ä½¿ç”¨mmapè¿›è¡Œåˆ†é…ã€‚å¦åˆ™å¢åŠ heapï¼Œå¢å¤§top chunkã€‚ä»¥æ»¡è¶³åˆ†é…è¦æ±‚ã€‚
> 
> â

å½“ç„¶äº†ï¼Œglibcä¸­mallocçš„åˆ†é…è¿œæ¯”ä¸Šé¢çš„è¦å¤æ‚çš„å¤šï¼Œè¦è€ƒè™‘åˆ°å„ç§æƒ…å†µï¼Œæ¯”å¦‚æŒ‡é’ˆå¼‚å¸¸Î©Î©è¶Šç•Œç­‰ï¼Œå°†è¿™äº›åˆ¤æ–­æ¡ä»¶ä¹ŸåŠ å…¥åˆ°æµç¨‹å›¾ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![[Pasted image 20240914161335.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

malloc

## 7 å†…å­˜é‡Šæ”¾(free)

mallocè¿›è¡Œå†…å­˜åˆ†é…ï¼Œé‚£ä¹ˆä¸mallocç›¸å¯¹çš„å°±æ˜¯freeï¼Œè¿›è¡Œå†…å­˜é‡Šæ”¾ï¼Œä¸‹é¢æ˜¯freeå‡½æ•°çš„åŸºæœ¬æµç¨‹å›¾ï¼š
![[Pasted image 20240914161343.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

free

å¯¹ä¸Šè¿°æµç¨‹å›¾è¿›è¡Œæè¿°ï¼Œå¦‚ä¸‹ï¼š

1. è·å–åˆ†é…åŒºçš„é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
    
2. å¦‚æœfreeçš„æ˜¯ç©ºæŒ‡é’ˆï¼Œåˆ™è¿”å›ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚
    
3. åˆ¤æ–­å½“å‰chunkæ˜¯å¦æ˜¯mmapæ˜ å°„åŒºåŸŸæ˜ å°„çš„å†…å­˜ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥munmap()é‡Šæ”¾è¿™å—å†…å­˜ã€‚å‰é¢çš„å·²ä½¿ç”¨chunkçš„æ•°æ®ç»“æ„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰Mæ¥æ ‡è¯†æ˜¯å¦æ˜¯mmapæ˜ å°„çš„å†…å­˜ã€‚
    
4. åˆ¤æ–­chunkæ˜¯å¦ä¸top chunkç›¸é‚»ï¼Œå¦‚æœç›¸é‚»ï¼Œåˆ™ç›´æ¥å’Œtop chunkåˆå¹¶ï¼ˆå’Œtop chunkç›¸é‚»ç›¸å½“äºå’Œåˆ†é…åŒºä¸­çš„ç©ºé—²å†…å­˜å—ç›¸é‚»ï¼‰ã€‚å¦åˆ™ï¼Œè½¬åˆ°æ­¥éª¤8
    
5. å¦‚æœchunkçš„å¤§å°å¤§äºmax_fastï¼ˆ64bï¼‰ï¼Œåˆ™æ”¾å…¥unsorted binï¼Œå¹¶ä¸”æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶ï¼Œæœ‰åˆå¹¶æƒ…å†µå¹¶ä¸”å’Œtop chunkç›¸é‚»ï¼Œåˆ™è½¬åˆ°æ­¥éª¤8ï¼›æ²¡æœ‰åˆå¹¶æƒ…å†µåˆ™freeã€‚
    
6. å¦‚æœchunkçš„å¤§å°å°äº max_fastï¼ˆ64bï¼‰ï¼Œåˆ™ç›´æ¥æ”¾å…¥fast binï¼Œfast binå¹¶æ²¡æœ‰æ”¹å˜chunkçš„çŠ¶æ€ã€‚æ²¡æœ‰åˆå¹¶æƒ…å†µï¼Œåˆ™freeï¼›æœ‰åˆå¹¶æƒ…å†µï¼Œè½¬åˆ°æ­¥éª¤7
    
7. åœ¨fast binï¼Œå¦‚æœå½“å‰chunkçš„ä¸‹ä¸€ä¸ªchunkä¹Ÿæ˜¯ç©ºé—²çš„ï¼Œåˆ™å°†è¿™ä¸¤ä¸ªchunkåˆå¹¶ï¼Œæ”¾å…¥unsorted binä¸Šé¢ã€‚åˆå¹¶åçš„å¤§å°å¦‚æœå¤§äº64Bï¼Œä¼šè§¦å‘è¿›è¡Œfast binsçš„åˆå¹¶æ“ä½œï¼Œfast binsä¸­çš„chunkå°†è¢«éå†ï¼Œå¹¶ä¸ç›¸é‚»çš„ç©ºé—²chunkè¿›è¡Œåˆå¹¶ï¼Œåˆå¹¶åçš„chunkä¼šè¢«æ”¾åˆ°unsorted binä¸­ï¼Œfast binä¼šå˜ä¸ºç©ºã€‚åˆå¹¶åçš„chunkå’Œtopchunkç›¸é‚»ï¼Œåˆ™ä¼šåˆå¹¶åˆ°topchunkä¸­ã€‚è½¬åˆ°æ­¥éª¤8
    
8. åˆ¤æ–­top chunkçš„å¤§å°æ˜¯å¦å¤§äºmmapæ”¶ç¼©é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º128KBï¼‰ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå¯¹äºä¸»åˆ†é…åŒºï¼Œåˆ™ä¼šè¯•å›¾å½’è¿˜top chunkä¸­çš„ä¸€éƒ¨åˆ†ç»™æ“ä½œç³»ç»Ÿã€‚freeç»“æŸã€‚
    

å¦‚æœå°†freeå‡½æ•°å†…éƒ¨å„ç§æ¡ä»¶åŠ å…¥è¿›å»ï¼Œé‚£ä¹ˆfreeè°ƒç”¨çš„è¯¦ç»†æµç¨‹å›¾å¦‚ä¸‹ï¼š
![[Pasted image 20240914161353.png]]
![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

free

  

## 8 é—®é¢˜åˆ†æä»¥åŠè§£å†³

é€šè¿‡å‰é¢å¯¹glibcè¿è¡Œæ—¶åº“çš„åˆ†æï¼ŒåŸºæœ¬å°±èƒ½å®šä½å‡ºåŸå› ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬è°ƒç”¨äº†freeè¿›è¡Œé‡Šæ”¾ï¼Œä½†ä»…ä»…æ˜¯å°†å†…å­˜è¿”è¿˜ç»™äº†glibcåº“ï¼Œè€Œglibcåº“å´æ²¡æœ‰å°†å†…å­˜å½’è¿˜æ“ä½œç³»ç»Ÿï¼Œæœ€ç»ˆå¯¼è‡´ç³»ç»Ÿå†…å­˜è€—å°½ï¼Œç¨‹åºå› ä¸º OOM è¢«ç³»ç»Ÿæ€æ‰ã€‚

æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š

- ç¦ç”¨ ptmalloc çš„ mmap åˆ†é… é˜ˆ å€¼ åŠ¨ æ€ è°ƒ æ•´ æœº åˆ¶ ã€‚é€š è¿‡ mallopt() è®¾ç½®M_TRIM_THRESHOLDï¼ŒM_MMAP_THRESHOLDï¼ŒM_TOP_PAD å’Œ M_MMAP_MAX ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œå…³é—­ mmap åˆ†é…é˜ˆå€¼åŠ¨æ€è°ƒæ•´æœºåˆ¶ï¼ŒåŒæ—¶éœ€è¦å°† mmap åˆ†é…é˜ˆå€¼è®¾ç½®ä¸º 64Kï¼Œå¤§äº 64K çš„å†…å­˜åˆ†é…éƒ½ä½¿ç”¨mmap å‘ç³»ç»Ÿåˆ†é…ï¼Œé‡Šæ”¾å¤§äº 64K çš„å†…å­˜å°†è°ƒç”¨ munmap é‡Šæ”¾å›ç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆçš„Â ç¼ºç‚¹æ˜¯æ¯æ¬¡å†…å­˜åˆ†é…å’Œç”³è¯·ï¼Œéƒ½æ˜¯ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·ï¼Œæ•ˆç‡ä½ã€‚
    
- é¢„ ä¼° ç¨‹ åº å¯ ä»¥ ä½¿ ç”¨ çš„ æœ€ å¤§ ç‰© ç† å†… å­˜ å¤§ å° ï¼Œ é… ç½® ç³» ç»Ÿ çš„/proc/sys/vm/overcommit_memoryï¼Œ/proc/sys/vm/overcommit_ratioï¼Œä»¥åŠä½¿ç”¨ ulimt â€“vé™åˆ¶ç¨‹åºèƒ½ä½¿ç”¨è™šæ‹Ÿå†…å­˜ç©ºé—´å¤§å°ï¼Œé˜²æ­¢ç¨‹åºå›  OOM è¢«æ€æ‰ã€‚è¿™ç§æ–¹æ¡ˆçš„Â ç¼ºç‚¹æ˜¯å¦‚æœé¢„ä¼°çš„å†…å­˜å°äºè¿›ç¨‹å®é™…å ç”¨ï¼Œé‚£ä¹ˆä»ç„¶ä¼šå‡ºç°OOMï¼Œå¯¼è‡´è¿›ç¨‹è¢«æ€æ‰ã€‚
    
- tcmalloc
    

æœ€ç»ˆé‡‡ç”¨tcmallocæ¥è§£å†³äº†é—®é¢˜ã€‚

## 9 ç»“è¯­

ä¸šç•Œè¯­å¥è¯´æ³•ï¼Œæ˜¯å¦äº†è§£å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ˜¯è¾¨åˆ«C/C++ç¨‹åºå‘˜å’Œå…¶ä»–çš„é«˜çº§è¯­è¨€ç¨‹åºå‘˜çš„é‡è¦åŒºåˆ«ã€‚ä½œä¸ºC/C++ä¸­çš„æœ€é‡è¦çš„ç‰¹æ€§ï¼ŒæŒ‡é’ˆåŠåŠ¨æ€å†…å­˜ç®¡ç†åœ¨ç»™ç¼–ç¨‹å¸¦æ¥æå¤§çš„çµæ´»æ€§çš„åŒæ—¶ï¼Œä¹Ÿç»™å¼€å‘äººå‘˜å¸¦æ¥äº†è®¸å¤šå›°æ‰°ã€‚

äº†è§£åº•å±‚å†…å­˜å®ç°ï¼Œæœ‰æ—¶å€™ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æ•ˆæœå“¦ã€‚

## 10 å‚è€ƒ

1ã€https://sourceware.org/glibc/wiki/MallocInternals

2ã€https://titanwolf.org/Network/Articles/Article?AID=99524c69-cb90-4d61-bb28-01c0864d0ccc

3ã€https://blog.fearcat.in/a?ID=00100-535db575-0d98-4287-92b6-4d7d9604b216

4ã€https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/

5ã€https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc

  

- EOF -

æ¨èé˜…è¯»Â Â ç‚¹å‡»æ ‡é¢˜å¯è·³è½¬

1ã€[å†…æ ¸è™šæ‹ŸæœºåŸç†ï¼šç½‘ç»œå¯ç¼–ç¨‹](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651170783&idx=1&sn=0b6db991015ff8b3315aa86bf8c42c38&chksm=80647680b713ff96d94c570741cbe118b37038a352d8a002bfa12d9468fdef2ee69af577724e&scene=21#wechat_redirect)

2ã€[æ·±å…¥ç†è§£ glibc mallocï¼šå†…å­˜åˆ†é…å™¨å®ç°åŸç†](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651168024&idx=2&sn=aa6ab7d5abd783a317dd4df197a480ef&chksm=80644c47b713c55150844681159a2618d65e262c1bd1db59fb2872e4ee6d3424893b676cea57&scene=21#wechat_redirect)

3ã€[å­¦ä¹ C++åº”è¯¥åšç‚¹ä»€ä¹ˆé¡¹ç›®](http://mp.weixin.qq.com/s?__biz=MzAxNDI5NzEzNg==&mid=2651170782&idx=2&sn=b7674ea01ee4e399ee62d2fdd7476b6f&chksm=80647681b713ff970d45141e45c387caf3b13b20fa3e6fc07e71ba1f432efb2442da02f65e38&scene=21#wechat_redirect)

  

**å…³æ³¨ã€CPPå¼€å‘è€…ã€**  

çœ‹ç²¾é€‰C/C++æŠ€æœ¯æ–‡ç« Â 

![](http://mmbiz.qpic.cn/mmbiz_png/pldYwMfYJpia3uWic6GbPCC1LgjBWzkBVqYrMfbfT6o9uMDnlLELGNgYDP496LvDfiaAiaOt0cZBlBWw4icAs6OHg8Q/300?wx_fmt=png&wxfrom=19)

**CPPå¼€å‘è€…**

æˆ‘ä»¬åœ¨ Github ç»´æŠ¤ç€ 9000+ star çš„Cè¯­è¨€/C++å¼€å‘èµ„æºã€‚æ—¥å¸¸åˆ†äº« Cè¯­è¨€ å’Œ C++ å¼€å‘ç›¸å…³æŠ€æœ¯æ–‡ç« ï¼Œæ¯ç¯‡æ–‡ç« éƒ½ç»è¿‡ç²¾å¿ƒç­›é€‰ï¼Œä¸€ç¯‡æ–‡ç« è®²é€ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œè®©è¯»è€…è¯»æœ‰æ‰€è·ï½

24ç¯‡åŸåˆ›å†…å®¹

å…¬ä¼—å·

ç‚¹èµå’Œåœ¨çœ‹å°±æ˜¯æœ€å¤§çš„æ”¯æŒâ¤ï¸  

ReadsÂ 3652

â€‹

Comment

**ç•™è¨€ 2**

- cds
    
    å¹¿ä¸œ2022å¹´5æœˆ13æ—¥
    
    Like1
    
    æœ€ç»ˆé‡‡ç”¨tcmallocæ¥è§£å†³äº†é—®é¢˜ã€‚ è¿™å¥çœŸå®ã€‚ æœ‰ä¸€æ¬¡æˆ‘åœ¨å®šä½å¯é udpåº“çš„bugæ—¶ï¼ŒèŠ±äº†ä¸¤å‘¨æ—¶é—´å»ä¼˜åŒ–ä»£ç åŠæŸ¥é˜…èµ„æ–™ã€‚æœ€åç”¨kcpè§£å†³äº†é—®é¢˜ã€‚
    
- ä¼ªæ–œæ 
    
    æµ™æ±Ÿ2022å¹´5æœˆ12æ—¥
    
    Like
    
    ç¡¬æ ¸ï¼Œå…ˆæ”¶è—ï¼
    

å·²æ— æ›´å¤šæ•°æ®

[](javacript:;)

![](http://mmbiz.qpic.cn/mmbiz_png/pldYwMfYJpia3uWic6GbPCC1LgjBWzkBVqYrMfbfT6o9uMDnlLELGNgYDP496LvDfiaAiaOt0cZBlBWw4icAs6OHg8Q/300?wx_fmt=png&wxfrom=18)

CPPå¼€å‘è€…

27Share14

2

Comment

**ç•™è¨€ 2**

- cds
    
    å¹¿ä¸œ2022å¹´5æœˆ13æ—¥
    
    Like1
    
    æœ€ç»ˆé‡‡ç”¨tcmallocæ¥è§£å†³äº†é—®é¢˜ã€‚ è¿™å¥çœŸå®ã€‚ æœ‰ä¸€æ¬¡æˆ‘åœ¨å®šä½å¯é udpåº“çš„bugæ—¶ï¼ŒèŠ±äº†ä¸¤å‘¨æ—¶é—´å»ä¼˜åŒ–ä»£ç åŠæŸ¥é˜…èµ„æ–™ã€‚æœ€åç”¨kcpè§£å†³äº†é—®é¢˜ã€‚
    
- ä¼ªæ–œæ 
    
    æµ™æ±Ÿ2022å¹´5æœˆ12æ—¥
    
    Like
    
    ç¡¬æ ¸ï¼Œå…ˆæ”¶è—ï¼
    

å·²æ— æ›´å¤šæ•°æ®